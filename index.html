<style>
    :root {
        --unam-azul: #002B7A;
        --unam-oro: #D59F0F;
    }

    body {
        background-color: #f8f9fa;
        /* Dark background to prevent white/blue flash */
        font-family: 'Segoe UI', system-ui, sans-serif;
        min-height: 100vh;
        display: flex;
        flex-direction: column;
    }

    /* Pantalla de carga */
    #step-1-landing {
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background: linear-gradient(135deg, #002B7A 0%, #00153d 100%);
        /* Solid black loading field */
        z-index: 9999;
        display: flex;
        flex-direction: column;
        justify-content: center;
        align-items: center;
        color: white;
        text-align: center;
        transition: transform 0.6s cubic-bezier(0.83, 0, 0.17, 1);
    }

    .header-hero {
        background: linear-gradient(135deg, var(--unam-azul) 0%, #001e54 100%);
        color: white;
        padding: 2rem 0 1rem;
        border-bottom: 5px solid var(--unam-oro);
    }

    .badge-student {
        background-color: var(--unam-oro);
        color: var(--unam-azul);
        font-weight: 800;
        padding: 0.4em 0.8em;
        border-radius: 20px;
        font-size: 0.8rem;
        text-transform: uppercase;
    }

    .nav-pills .nav-link.active {
        background-color: var(--unam-azul);
        color: var(--unam-oro);
        font-weight: bold;
    }

    .nav-pills .nav-link {
        color: var(--unam-azul);
    }

    .materia-item {
        cursor: pointer;
        font-size: 0.9rem;
        border-left: 4px solid transparent;
        transition: all 0.2s;
    }

    .materia-item:hover {
        background-color: #e9ecef;
    }

    .materia-item.active-item {
        background-color: #e7f1ff;
        border-left-color: var(--unam-azul);
        color: var(--unam-azul);
        font-weight: bold;
    }

    .materia-item.inscrita-item {
        background-color: #d1e7dd;
        border-left-color: #198754;
    }

    .materia-item.candidata-item {
        background-color: #fff3cd;
        border-left-color: var(--unam-oro);
    }

    .aviso-requerido {
        display: block;
        font-size: 0.7rem;
        color: #dc3545;
        font-weight: 800;
        margin-top: 2px;
        text-transform: uppercase;
        animation: fadeIn 0.5s;
    }

    .materia-item.item-requerido {
        border-left-color: #dc3545 !important;
        background-color: #fff5f5 !important;
    }

    @keyframes fadeIn {
        from {
            opacity: 0;
        }

        to {
            opacity: 1;
        }
    }

    .area-header {
        font-size: 0.75rem;
        font-weight: 800;
        text-transform: uppercase;
        color: #6c757d;
        background: #f8f9fa;
        padding: 8px 12px;
        margin-top: 5px;
        border-bottom: 1px solid #dee2e6;
    }

    .grupo-card {
        border: 1px solid #dee2e6;
        border-radius: 8px;
        background: white;
        transition: transform 0.2s;
        height: 100%;
        cursor: pointer;
        position: relative;
    }

    .grupo-card:hover {
        transform: translateY(-5px);
        box-shadow: 0 6px 15px rgba(0, 0, 0, 0.15);
        border-color: var(--unam-azul);
        z-index: 10;
    }

    .grupo-card.choque {
        background-color: #fff5f5;
        border-color: #ffc9c9;
    }

    .grupo-card.inscrita {
        border: 2px solid #198754;
        background-color: #f0fff4;
    }

    .grupo-card.previsualizacion {
        border: 2px dashed #dc3545;
        background-color: #fff;
        box-shadow: 0 0 10px rgba(220, 53, 69, 0.2);
    }

    .grupo-card.candidato-seleccionado {
        border: 2px solid var(--unam-oro);
        background-color: #fff9e6;
    }

    .horizontal-scroll-container {
        display: flex;
        flex-wrap: nowrap;
        overflow-x: auto;
        gap: 15px;
        padding: 15px 5px;
        align-items: stretch;
    }

    .horizontal-scroll-container::-webkit-scrollbar {
        height: 10px;
    }

    .horizontal-scroll-container::-webkit-scrollbar-track {
        background: #f1f1f1;
        border-radius: 7px;
        margin: 0 5px;
    }

    .horizontal-scroll-container::-webkit-scrollbar-thumb {
        background: #bbb;
        border-radius: 7px;
        border: 2px solid #f1f1f1;
    }

    .horizontal-scroll-container::-webkit-scrollbar-thumb:hover {
        background: #999;
    }

    .tabla-siae {
        font-size: 0.75rem;
        text-align: center;
    }

    .tabla-siae thead th {
        background-color: #e9ecef;
        color: #495057;
        vertical-align: middle;
        /* Corregido: z-index menor para que no tape dropdowns ni de problemas al descargar */
        position: sticky;
        top: 0;
        z-index: 10;
    }

    .tabla-siae td {
        vertical-align: middle;
        padding: 4px;
    }

    .col-dia {
        width: 8%;
        font-weight: 500;
        color: #002B7A;
    }

    .btn-ver-obs {
        font-size: 0.7rem;
        padding: 1px 6px;
        margin-left: 5px;
        border-radius: 10px;
        border: 1px solid #17a2b8;
        color: #17a2b8;
        background: white;
        cursor: pointer;
    }

    .obs-box {
        font-size: 0.8em;
        background: #e3f2fd;
        padding: 6px;
        border-radius: 4px;
        margin-top: 5px;
        display: none;
        border-left: 3px solid #2196f3;
        text-align: left;
    }

    #toast-guardado {
        position: fixed;
        bottom: 20px;
        right: 20px;
        background-color: #198754;
        color: white;
        padding: 10px 20px;
        border-radius: 30px;
        display: none;
        z-index: 1000;
    }

    .panel-filtros {
        background-color: #e3f2fd;
        border-bottom: 1px solid #bbdefb;
    }

    .label-filtro {
        font-size: 0.75rem;
        font-weight: bold;
        color: #002B7A;
        margin-bottom: 2px;
        display: block;
    }

    .tabla-visual {
        font-size: 0.75rem;
        table-layout: fixed;
        border-collapse: separate;
        border-spacing: 0;
        background-color: white;
        width: 100%;
    }

    .tabla-visual th {
        text-align: center;
        background: #f8f9fa;
        color: #6c757d;
        font-size: 0.8rem;
        border-bottom: 2px solid #dee2e6;
        padding: 4px;
        position: sticky;
        top: 0;
        z-index: 50;
        /* Z-index ajustado */
        box-shadow: 0 2px 2px rgba(0, 0, 0, 0.05);
    }

    .tabla-visual td {
        height: 30px;
        border-right: 1px solid #eee;
        border-bottom: 1px solid #f1f1f1;
        padding: 0;
        vertical-align: top;
        position: relative;
    }

    .hora-col {
        background: #fff;
        color: #999;
        font-weight: 600;
        font-size: 0.7rem;
        text-align: right;
        padding-right: 8px !important;
        vertical-align: middle !important;
        border-right: 2px solid #dee2e6 !important;
        width: 50px;
    }

    .bloque-materia {
        position: absolute;
        top: 0;
        left: 0;
        width: 100%;
        z-index: 40;
        display: flex;
        flex-direction: column;
        justify-content: center;
        align-items: center;
        text-align: center;
        padding: 2px 4px;
        cursor: pointer;
        border-radius: 4px;
        box-shadow: 0 2px 5px rgba(0, 0, 0, 0.05);
        border: 1px solid rgba(0, 0, 0, 0.25);
        transition: all 0.15s ease-out;
        overflow: hidden;
    }

    .bloque-resaltado {
        transform: scale(1.05) !important;
        z-index: 60 !important;
        box-shadow: 0 8px 16px rgba(0, 0, 0, 0.2) !important;
        border-color: var(--unam-azul) !important;
    }

    .bloque-traslape {
        background-color: rgba(255, 255, 255, 0.75) !important;
        border: 2px dashed #dc3545 !important;
        color: #dc3545 !important;
        z-index: 45 !important;
        backdrop-filter: blur(1px);
    }

    .label-traslape {
        font-weight: 900;
        color: #dc3545;
        font-size: 0.7rem;
        margin-top: 2px;
        text-transform: uppercase;
        background: rgba(255, 255, 255, 0.9);
        padding: 0 4px;
        border-radius: 4px;
    }

    .materia-nombre {
        font-size: 0.7rem;
        font-weight: 800;
        color: #212529;
        line-height: 1;
        margin-bottom: 1px;
    }

    .materia-grupo {
        font-size: 0.65rem;
        font-weight: 400;
        color: #000;
        margin-bottom: 1px;
    }

    .materia-horas {
        font-size: 0.6rem;
        color: #555;
        font-weight: 600;
        white-space: pre-wrap;
        line-height: 1;
    }

    .materia-profe {
        font-size: 0.6rem;
        color: #444;
        font-style: italic;
        line-height: 1;
        margin-top: 1px;
    }

    .hide-prof .materia-profe {
        display: none !important;
    }

    .hide-group .materia-grupo {
        display: none !important;
    }

    .hide-time .materia-horas {
        display: none !important;
    }

    .modal-profe-area {
        padding: 1.5rem;
        text-align: center;
        background: #f8f9fa;
        border-bottom: 1px solid #dee2e6;
    }

    .modal-obs-area {
        padding: 1.5rem;
        text-align: center;
        font-size: 0.9rem;
        color: #555;
    }

    .header-acciones {
        position: relative;
        z-index: 1050;
        overflow: visible !important;
    }

    .slide-up-exit {
        transform: translateY(-100%);
        pointer-events: none;
    }

    #app-container-wrapper {
        opacity: 0;
        transform: translateY(20px);
        transition: opacity 0.8s ease 0.3s, transform 0.8s ease 0.3s;
    }

    .app-loaded {
        opacity: 1 !important;
        transform: none !important;
    }

    .header-hero {
        transition: all 0.5s ease;
    }

    body.mode-workspace .header-hero {
        padding: 0.5rem 0 !important;
        border-bottom-width: 2px;
    }

    body.mode-workspace .header-hero h1 {
        font-size: 1.2rem;
        margin: 0;
    }

    body.mode-workspace .header-hero p {
        display: none;
    }

    body.mode-workspace .header-hero .badge-student {
        display: none;
    }

    body.mode-workspace .header-hero .d-inline-flex {
        transform: scale(0.9);
        margin-top: 0 !important;
    }

    .card-hover-effect {
        transition: transform 0.2s, box-shadow 0.2s;
    }

    .card-hover-effect:hover {
        transform: translateY(-5px);
        box-shadow: 0 10px 20px rgba(0, 0, 0, 0.1) !important;
    }

    .step-badge {
        display: inline-flex;
        justify-content: center;
        align-items: center;
        width: 28px;
        height: 28px;
        border-radius: 50%;
        font-weight: 800;
        font-size: 0.85rem;
        margin-right: 10px;
        flex-shrink: 0;
        color: white;
    }

    .instruction-bar {
        background: white;
        border-radius: 12px;
        box-shadow: 0 4px 12px rgba(0, 0, 0, 0.05);
        border: 1px solid #eee;
    }

    .step-text {
        font-size: 0.85rem;
        color: #555;
        line-height: 1.3;
    }

    .step-title {
        font-weight: 800;
        font-size: 0.75rem;
        text-transform: uppercase;
        display: block;
        margin-bottom: 2px;
    }

    .btn-custom-manual {
        background-color: #00695c !important;
        border-color: #00695c !important;
        color: white !important;
        transition: all 0.3s;
    }

    .btn-custom-manual:hover {
        background-color: #004d40 !important;
        border-color: #004d40 !important;
        transform: scale(1.05);
    }

    .btn-custom-auto {
        background-color: #6a1b9a !important;
        border-color: #6a1b9a !important;
        color: white !important;
        transition: all 0.3s;
    }

    .btn-custom-auto:hover {
        background-color: #4a148c !important;
        border-color: #4a148c !important;
        transform: scale(1.05);
    }

    .visual-mode-container {
        display: flex;
        align-items: center;
        background-color: #212529;
        color: white;
        border-radius: 50px;
        padding: 5px 15px;
        cursor: pointer;
        transition: all 0.2s;
        box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
        border: 2px solid transparent;
    }

    .visual-mode-container:hover {
        transform: scale(1.05);
        background-color: #000;
        box-shadow: 0 6px 12px rgba(0, 0, 0, 0.2);
    }

    .visual-mode-container input {
        cursor: pointer;
        margin-right: 8px !important;
    }

    .visual-mode-container label {
        cursor: pointer;
        font-weight: 800 !important;
        text-transform: uppercase;
        font-size: 0.8rem;
        color: white !important;
    }

    /* Ajuste para eliminar espacios excesivos en la parte inferior */
    #vista-manual,
    #vista-auto {
        padding-bottom: 0 !important;
        margin-bottom: 0 !important;
        height: auto !important;
        min-height: 0;
    }

    .card-body {
        overflow-y: auto;
    }

    /* Contenedor temporal para capturas de pantalla de alta resolución */
    #capture-container {
        position: fixed;
        top: 0;
        left: 0;
        width: 1300px !important;
        z-index: -1000;
        opacity: 0;
        pointer-events: none;
    }

    /* --- PREMIUM MANUAL TOOLBAR STYLES --- */
    .toolbar-manual-container {
        background: #ffffff;
        border-bottom: 1px solid #edf2f7;
        padding: 0.75rem 1.25rem;
        display: flex;
        justify-content: space-between;
        align-items: center;
        flex-wrap: wrap;
        gap: 15px;
        border-top-left-radius: 12px;
        /* Smooth corners for the card */
        border-top-right-radius: 12px;
    }

    .group-left,
    .group-right {
        display: flex;
        align-items: center;
        gap: 10px;
        flex-wrap: wrap;
    }

    .btn-tool {
        border: none;
        background: #f8f9fa;
        color: #495057;
        font-weight: 600;
        font-size: 0.85rem;
        padding: 8px 14px;
        border-radius: 10px;
        transition: all 0.2s ease;
        display: inline-flex;
        align-items: center;
        gap: 6px;
        cursor: pointer;
        text-decoration: none;
    }

    .btn-tool:hover {
        background: #e9ecef;
        color: #212529;
        transform: translateY(-1px);
    }

    .btn-tool:disabled {
        opacity: 0.5;
        cursor: not-allowed;
        transform: none;
    }

    .btn-tool-primary {
        background-color: var(--unam-azul);
        color: white;
        box-shadow: 0 2px 5px rgba(0, 43, 122, 0.2);
    }

    .btn-tool-primary:hover {
        background-color: #001e54;
        color: white;
        box-shadow: 0 4px 10px rgba(0, 43, 122, 0.3);
    }

    .btn-tool-danger {
        background-color: #fff5f5;
        color: #e03131;
    }

    .btn-tool-danger:hover {
        background-color: #ffe3e3;
        color: #c92a2a;
    }

    /* Input del nombre del horario */
    .input-tool-name {
        background: #f8f9fa;
        border: 2px solid transparent;
        border-radius: 8px;
        padding: 6px 12px;
        font-weight: 700;
        color: #343a40;
        font-size: 0.85rem;
        width: 180px;
        transition: all 0.2s;
    }

    .input-tool-name:focus {
        background: white;
        border-color: var(--unam-azul);
        color: var(--unam-azul);
        outline: none;
        box-shadow: 0 0 0 3px rgba(0, 43, 122, 0.1);
    }

    /* Dropdown de selección de horario */
    .select-tool-sched {
        border: none;
        background: transparent;
        font-weight: 800;
        color: var(--unam-azul);
        font-size: 0.95rem;
        cursor: pointer;
        padding-right: 20px;
        background-image: url("data:image/svg+xml,%3csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 16 16'%3e%3cpath fill='none' stroke='%23002B7A' stroke-linecap='round' stroke-linejoin='round' stroke-width='2' d='m2 5 6 6 6-6'/%3e%3c/svg%3e");
        background-repeat: no-repeat;
        background-position: right 0.1rem center;
        background-size: 10px 10px;
        appearance: none;
    }

    .select-tool-sched:focus {
        outline: none;
    }

    /* Pill de Visual Mode */
    .visual-pill {
        background: #212529;
        color: white;
        border-radius: 20px;
        padding: 6px 14px;
        display: flex;
        align-items: center;
        gap: 8px;
        cursor: pointer;
        transition: transform 0.2s;
        font-size: 0.75rem;
        font-weight: 800;
        letter-spacing: 0.5px;
    }

    .visual-pill:hover {
        transform: scale(1.03);
        box-shadow: 0 4px 10px rgba(0, 0, 0, 0.2);
    }

    .visual-pill input {
        cursor: pointer;
    }

    .separator-v {
        width: 1px;
        height: 24px;
        background-color: #dee2e6;
        margin: 0 5px;
    }

    /* Dropdown menu customization */
    .dropdown-menu-tool {
        border: none;
        box-shadow: 0 10px 30px rgba(0, 0, 0, 0.15);
        border-radius: 12px;
        overflow: hidden;
        padding: 0;
    }

    .dropdown-item-tool {
        padding: 10px 20px;
        font-size: 0.85rem;
        color: #495057;
        font-weight: 600;
        border-bottom: 1px solid #f1f3f5;
        transition: background 0.2s;
    }

    .dropdown-item-tool:hover {
        background: #f8f9fa;
        color: var(--unam-azul);
    }

    .dropdown-item-tool:last-child {
        border-bottom: none;
    }

    .dropdown-header-tool {
        background: #f8f9fa;
        color: #868e96;
        font-size: 0.7rem;
        text-transform: uppercase;
        letter-spacing: 0.5px;
        font-weight: 800;
        padding: 8px 15px;
    }
</style>
<!DOCTYPE html>
<html lang="es">

<head>
    <meta charset="UTF-8">
    <title>Generador Horarios Facultad de Psicología UNAM</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">

    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.0/font/bootstrap-icons.css">

    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdn.sheetjs.com/xlsx-latest/package/dist/xlsx.full.min.js"></script>

    <!-- Fonts for Landing -->
    <link
        href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800&family=Nunito:wght@300;400;600;700&display=swap"
        rel="stylesheet">

    <style>
        /* Animación de fondo dinámico */
        @keyframes gradientMove {
            0% {
                background-position: 0% 50%;
            }

            50% {
                background-position: 100% 50%;
            }

            100% {
                background-position: 0% 50%;
            }
        }

        /* Estilos específicos para el Landing Page (Oceans/Rays Theme) */
        #step-1-landing {
            position: fixed;
            top: 0;
            left: 0;
            width: 100vw;
            height: 100vh;
            background-color: #000;
            /* Fallback */
            z-index: 9999;
            overflow: hidden;
            font-family: 'Inter', sans-serif;
            color: white;
            display: flex;
            flex-direction: column;
            /* Stack vertically for separated layout */
            align-items: center;
            justify-content: center;
            transition: transform 0.8s cubic-bezier(0.77, 0, 0.175, 1);
        }

        /* Background Layers */
        .bg-layer {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            pointer-events: none;
        }

        .aura-background {
            z-index: -20;
            opacity: 0.6;
        }

        .tint-overlay {
            z-index: -15;
            background-color: rgba(30, 58, 138, 0.3);
            /* Deep Blue Tint for "Rays" (Azul fuerte bajito) */
            mix-blend-mode: overlay;
        }

        .particle-canvas {
            z-index: -10;
            opacity: 0.5;
            /* Slightly darker background feel */
        }

        /* Content Layout */
        .landing-content-wrapper {
            position: relative;
            z-index: 10;
            width: 100%;
            max-width: 800px;
            display: flex;
            flex-direction: column;
            align-items: center;
            padding: 20px;
            text-align: center;
        }

        .landing-header {
            margin-bottom: 3rem;
            animation: fadeInDown 1s ease-out;
            text-align: center;
            display: flex;
            flex-direction: column;
            align-items: center;
        }

        .landing-title {
            font-family: 'Inter', sans-serif;
            font-size: 4rem;
            /* Fallback */
            font-weight: 700;
            /* Bold */
            letter-spacing: -0.03em;
            margin-bottom: 1rem;
            text-transform: lowercase;
            /* Lowercase request */

            /* Pale Yellow Gradient & Strong Glow */
            background: linear-gradient(to bottom, #ffffff 20%, #fef08a 100%);
            /* White to Icy Yellow */
            -webkit-background-clip: text;
            background-clip: text;
            color: transparent;
            filter: drop-shadow(0 0 25px rgba(253, 224, 71, 0.6));
            /* Stronger Glow */
        }

        @media (min-width: 640px) {
            .landing-title {
                font-size: 5rem;
            }
        }

        @media (min-width: 768px) {
            .landing-title {
                font-size: 6rem;
            }
        }

        .landing-subtitle {
            font-family: 'Nunito', sans-serif;
            font-size: 1.5rem;
            font-weight: 600;
            letter-spacing: 0.02em;
            line-height: 1.3;
            color: #fefce8;
            /* Almost white/pale yellow */
            text-shadow: 0 0 25px rgba(253, 224, 71, 0.5);
            /* Enhanced Brightness/Glow */
            text-transform: none;
            max-width: 600px;
            /* Force 2 lines */
            margin-left: auto;
            margin-right: auto;
        }

        @media (min-width: 640px) {
            .landing-subtitle {
                font-size: 1.75rem;
            }
        }

        /* @media (min-width: 768px) { .landing-subtitle { font-size: 1.75rem; } } */
        /* This line was commented out in the original, keeping it that way */

        .card-selector-container {
            width: 100%;
            max-width: 450px;
            animation: fadeInUp 1s ease-out 0.2s backwards;
        }

        .glass-card {
            background: rgba(20, 20, 20, 0.4);
            backdrop-filter: blur(20px);
            -webkit-backdrop-filter: blur(20px);
            border: 1px solid rgba(255, 255, 255, 0.1);
            box-shadow: 0 25px 50px -12px rgba(0, 0, 0, 0.5), inset 0 1px 0 rgba(255, 255, 255, 0.1);
            border-radius: 24px;
            padding: 30px;
            text-align: center;
            transition: transform 0.3s ease, border-color 0.3s ease;
        }

        .glass-card:hover {
            border-color: rgba(255, 255, 255, 0.2);
            transform: translateY(-2px);
        }

        .landing-footer {
            margin-top: 3rem;
            font-size: 0.8rem;
            opacity: 0.6;
            max-width: 500px;
            text-align: center;
            animation: fadeIn 1.5s ease-out 0.5s backwards;
        }

        .text-gradient-gold {
            background: linear-gradient(to right, #fde047, #f59e0b);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
        }

        @keyframes fadeInDown {
            from {
                opacity: 0;
                transform: translateY(-30px);
            }

            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        @keyframes fadeInUp {
            from {
                opacity: 0;
                transform: translateY(30px);
            }

            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        @keyframes fadeIn {
            from {
                opacity: 0;
            }

            to {
                opacity: 1;
            }
        }

        .slide-up-exit {
            transform: translateY(-100%);
        }

        .landing-bg-orb {
            position: absolute;
            border-radius: 50%;
            filter: blur(100px);
            opacity: 0.4;
            z-index: -1;
            pointer-events: none;
        }

        .orb-blue {
            top: -20%;
            left: 50%;
            width: 800px;
            height: 800px;
            background: radial-gradient(circle, rgba(29, 78, 216, 0.5) 0%, rgba(0, 0, 0, 0) 70%);
            transform: translateX(-50%);
        }

        .orb-purple {
            bottom: -10%;
            right: -10%;
            width: 600px;
            height: 600px;
            background: radial-gradient(circle, rgba(147, 51, 234, 0.4) 0%, rgba(0, 0, 0, 0) 70%);
        }

        .orb-cyan {
            top: 40%;
            left: -10%;
            width: 500px;
            height: 500px;
            background: radial-gradient(circle, rgba(6, 182, 212, 0.4) 0%, rgba(0, 0, 0, 0) 70%);
        }

        .glass-card-container {
            position: relative;
            z-index: 10;
            width: 100%;
            max-width: 450px;
            /* Reduced from 500px */
            padding: 20px;
        }

        .glass-card {
            background: rgba(255, 255, 255, 0.03);
            backdrop-filter: blur(24px);
            -webkit-backdrop-filter: blur(24px);
            border: 1px solid rgba(255, 255, 255, 0.1);
            box-shadow: 0 25px 50px -12px rgba(0, 0, 0, 0.5), inset 0 1px 0 rgba(255, 255, 255, 0.1);
            border-radius: 32px;
            padding: 30px;
            /* Reduced from 40px */
            text-align: center;
            transition: transform 0.3s ease, box-shadow 0.3s ease;
        }

        .glass-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 30px 60px -12px rgba(0, 0, 0, 0.6), inset 0 1px 0 rgba(255, 255, 255, 0.2);
            border-color: rgba(255, 255, 255, 0.2);
        }

        .text-gradient {
            background: linear-gradient(to right, #60a5fa, #c084fc, #22d3ee);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
        }

        .btn-glass-primary {
            background: linear-gradient(135deg, #3b82f6 0%, #8b5cf6 100%);
            border: none;
            color: white;
            font-weight: 600;
            padding: 16px 32px;
            border-radius: 9999px;
            width: 100%;
            font-size: 1.1rem;
            transition: all 0.3s ease;
            box-shadow: 0 10px 15px -3px rgba(59, 130, 246, 0.3);
            position: relative;
            overflow: hidden;
        }

        .btn-glass-primary:hover:not(:disabled) {
            transform: scale(1.02);
            box-shadow: 0 20px 25px -5px rgba(59, 130, 246, 0.4);
            filter: brightness(1.1);
        }

        .btn-glass-primary:disabled {
            opacity: 0.6;
            cursor: not-allowed;
            background: #4b5563;
            box-shadow: none;
        }

        /* Floating elements animation */
        @keyframes float {

            0%,
            100% {
                transform: translateY(0);
            }

            50% {
                transform: translateY(-20px);
            }
        }

        .float-anim {
            animation: float 6s ease-in-out infinite;
        }

        .float-delay-1 {
            animation-delay: 2s;
        }

        .float-delay-2 {
            animation-delay: 4s;
        }

        .neon-white-glow {
            font-family: 'Inter', sans-serif;
            font-weight: 700;
            color: white;
            text-shadow: 0 0 20px rgba(255, 255, 255, 0.6), 0 0 40px rgba(255, 255, 255, 0.4), 0 0 60px rgba(255, 255, 255, 0.2);
            /* Reduced glow */
            font-size: 5rem;
            /* Reduced to half (was 10rem) */
            margin-top: auto;
            /* Push to bottom if in flex container */
            padding-top: 2rem;
            animation: float 6s ease-in-out infinite;
            line-height: 0.8;
            /* Compact line height */
            letter-spacing: -5px;
            /* Adjust spacing for smaller size */
            margin-bottom: -20px;
            /* Raise slightly (was -70px) */
        }

        /* Content Layout */
        .landing-content-wrapper {
            position: relative;
            z-index: 10;
            width: 100%;
            max-width: 95vw;
            /* Allow wider content for the single line subtitle */
            display: flex;
            flex-direction: column;
            align-items: center;
            padding: 20px;
            text-align: center;
        }

        .landing-header {
            margin-bottom: 3rem;
            animation: fadeInDown 1s ease-out;
            text-align: center;
            display: flex;
            flex-direction: column;
            align-items: center;
            width: 100%;
        }

        .header-generator-title {
            font-family: 'Inter', sans-serif;
            font-weight: 800;
            font-size: 4rem;
            /* Reduced to half (was 8rem) */
            color: white;
            margin-bottom: 0rem;
            text-shadow: 0 4px 10px rgba(0, 0, 0, 0.5);
            line-height: 1.1;
        }

        .header-school-subtitle {
            font-family: 'Nunito', sans-serif;
            font-weight: 700;
            font-style: italic;
            color: white;
            font-size: 1.75rem;
            /* Reduced to half (was 3.5rem) */
            line-height: 1.4;
            max-width: 100%;
            text-shadow: 0 2px 5px rgba(0, 0, 0, 0.5);
            white-space: nowrap;
        }

        .highlight-letter {
            color: #ff0000 !important;
            /* Force Red */
            text-decoration: line-through;
            text-decoration-color: #ff0000;
            text-decoration-thickness: 4px;
            font-weight: 900;
        }

        .btn-gold-gradient {
            background: linear-gradient(135deg, #facc15 0%, #ca8a04 100%);
            /* Yellow-400 to Yellow-600 */
            border: 1px solid #fef08a;
            /* Yellow-200 outline */
            color: white;
            box-shadow: 0 0 15px rgba(250, 204, 21, 0.5);
            font-weight: 700;
            transition: all 0.3s ease;
        }

        /* Responsive Adjustments */
        @media (max-width: 1200px) {
            .header-generator-title {
                font-size: 3rem;
            }

            .header-school-subtitle {
                font-size: 1.5rem;
            }

            .neon-white-glow {
                font-size: 4rem;
                margin-bottom: -10px;
            }
        }

        @media (max-width: 768px) {
            .header-generator-title {
                font-size: 2.2rem;
            }

            .header-school-subtitle {
                font-size: 1.1rem;
            }

            .neon-white-glow {
                font-size: 3rem;
                margin-bottom: 0px;
            }

            .landing-content-wrapper {
                padding: 10px;
            }

            .glass-card {
                width: 95% !important;
                padding: 2rem !important;
            }
        }

        @media (max-width: 480px) {
            .header-generator-title {
                font-size: 1.8rem;
            }

            .header-school-subtitle {
                font-size: 0.9rem;
            }

            .neon-white-glow {
                font-size: 2.5rem;
            }
        }

        .btn-gold-gradient:hover {
            box-shadow: 0 0 25px rgba(250, 204, 21, 0.8);
            transform: translateY(-2px);
            background: linear-gradient(135deg, #fde047 0%, #eab308 100%);
            border-color: white;
        }

        .btn-gold-gradient:disabled {
            background: #4b5563;
            border-color: #6b7280;
            box-shadow: none;
            cursor: not-allowed;
            transform: none;
        }

        .landing-select option {
            background-color: #1f2937;
            color: white;
        }
    </style>
</head>

<body>

    <div id="step-1-landing">
        <!-- BACKGROUND SYSTEM -->
        <!-- Layer 1: Aura (Unicorn Studio) -->
        <div class="bg-layer aura-background">
            <div data-us-project="uFY4IYPs2LU8fWm96Im2" style="width: 100%; height: 100%;"></div>
            <script type="text/javascript">
                !function () { if (!window.UnicornStudio) { window.UnicornStudio = { isInitialized: !1 }; var i = document.createElement("script"); i.src = "https://cdn.jsdelivr.net/gh/hiunicornstudio/unicornstudio.js@v1.4.29/dist/unicornStudio.umd.js", i.onload = function () { window.UnicornStudio.isInitialized || (UnicornStudio.init(), window.UnicornStudio.isInitialized = !0) }, (document.head || document.body).appendChild(i) } }();
            </script>
        </div>

        <!-- Layer 2: Yellow Light Rays Tint -->
        <div class="bg-layer tint-overlay"></div>

        <!-- Layer 3: Particles (Canvas) -->
        <div class="bg-layer particle-canvas">
            <canvas id="ocean-dust"></canvas>
        </div>

        <!-- MAIN ACCESS CONTENT -->
        <div class="landing-content-wrapper">

            <!-- Separated Header Section -->
            <!-- Separated Header Section (Reordered to Top) -->
            <div class="landing-header">
                <h1 class="header-generator-title">Generador de horarios</h1>
                <p class="header-school-subtitle">
                    de <span class="highlight-letter">A</span>poyo a las <span
                        class="highlight-letter">I</span>nscripciones de la <span
                        class="highlight-letter">F</span>acultad de Psicología UNAM
                </p>
            </div>

            <!-- Glass Card for Actions Only -->
            <div class="card-selector-container">
                <div class="glass-card">
                    <p class="mb-2 fw-bold text-white small">Para comenzar:</p>
                    <label class="fw-bold mb-3 d-block display-6" style="color: white; letter-spacing: 0.5px;">¿Qué
                        semestre cursarás?</label>
                    <select id="landing-selector" class="form-select form-select-lg fw-bold landing-select mb-4"
                        onchange="document.getElementById('btn-start-app').disabled = false">
                        <option value="" selected disabled>- Elige una opción -</option>
                        <option value="2">2do Semestre</option>
                        <option value="4">4to Semestre</option>
                        <option value="6">6to Semestre</option>
                        <option value="8">8vo Semestre</option>
                        <option value="adicional">Semestre Adicional / Optativas</option>
                    </select>

                    <button id="btn-start-app" class="btn-gold-gradient rounded-pill px-5 py-3 w-100"
                        onclick="window.entrarAlWorkspace()" disabled>
                        COMENZAR <i class="bi bi-arrow-right-short fs-4 align-middle"></i>
                    </button>

                </div>
            </div>

            <!-- Footer Disclaimer -->
            <div class="landing-footer mb-4">
                <p class="mb-1"><i class="bi bi-exclamation-triangle-fill text-warning me-1"></i>
                    <strong>Importante:</strong>
                </p>
                <p class="mb-0">
                    <strong>NO afiliado</strong> a la administración de la Facultad.<br>
                    La inscripción oficial se realiza en las páginas oficiales dadas por la Facultad.
                </p>
            </div>

            <!-- Neon Title at Bottom -->
            <h1 class="neon-white-glow">¡Bienvenidx!</h1>

        </div>
    </div>


    <div id="app-container-wrapper">

        <header class="header-hero text-center mb-3">
            <div class="container">
                <span class="badge-student mb-2 d-inline-block"><i class="bi bi-mortarboard-fill"></i> PROYECTO
                    AIE</span>
                <br><strong>Semestre 2026-2</strong>
                <div class="row justify-content-center">
                    <div class="col-lg-8">
                        <p class="lead" style="font-size: 1.1rem;">
                            Organiza tu semestre de forma sencilla y eficiente.
                        </p>
                    </div>
                </div>
                <div class="mt-2 d-inline-flex align-items-center bg-white rounded-pill px-3 py-1 shadow-sm">
                    <span class="text-dark fw-bold me-2 small">VER OFERTA DE:</span>
                    <select id="semestre-selector" class="form-select form-select-sm border-0 fw-bold text-primary"
                        style="width: auto; cursor: pointer;" onchange="cambiarSemestre(false)">
                        <option value="2">2do Semestre</option>
                        <option value="4">4to Semestre</option>
                        <option value="6">6to Semestre</option>
                        <option value="8" selected>8vo Semestre</option>
                        <option value="adicional">Semestre adicional</option>
                    </select>
                </div>
            </div>
        </header>

        <div class="container-fluid px-4 pb-3" id="app">
            <div id="alerta-semestre" class="container mb-3"></div>

            <div class="container mb-4">
                <div class="row g-4">
                    <div class="col-md-6">
                        <div class="card h-100 border-0 shadow-sm card-hover-effect"
                            style="border-top: 5px solid #00695c !important; cursor: pointer;"
                            onclick="activarModo('manual')">
                            <div
                                class="card-body p-4 text-center d-flex flex-column align-items-center justify-content-center">
                                <div class="mb-3 rounded-circle p-3" style="background-color: #e0f2f1; color: #00695c;">
                                    <i class="bi bi-pencil-square display-5"></i>
                                </div>
                                <h4 class="fw-bold text-dark mb-1">Arma tu horario paso a paso</h4>
                                <p class="text-muted fst-italic mb-4">Quiero elegir grupo por grupo</p>

                                <button class="btn btn-custom-manual rounded-pill px-4 fw-bold mt-auto">
                                    Usar modo manual <i class="bi bi-arrow-right"></i>
                                </button>
                            </div>
                        </div>
                    </div>

                    <div class="col-md-6">
                        <div class="card h-100 border-0 shadow-sm card-hover-effect"
                            style="border-top: 5px solid #6a1b9a !important; cursor: pointer;"
                            onclick="activarModo('auto')">
                            <div
                                class="card-body p-4 text-center d-flex flex-column align-items-center justify-content-center">
                                <div class="mb-3 rounded-circle p-3" style="background-color: #f3e5f5; color: #6a1b9a;">
                                    <i class="bi bi-cpu-fill display-5"></i>
                                </div>
                                <h4 class="fw-bold text-dark mb-1">Déjame ver todas las combinaciones</h4>
                                <p class="text-muted fst-italic mb-4">Quiero comparar opciones sin traslapes</p>

                                <button class="btn btn-custom-auto rounded-pill px-4 fw-bold mt-auto">
                                    Explorar horarios <i class="bi bi-search"></i>
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <div id="vista-manual" class="flex-column" style="display:none;">
                <div class="instruction-bar p-3 mx-3 mb-3"
                    style="background-color: #e0f2f1; border: 1px solid #b2dfdb; border-left: 5px solid #00695c;">
                    <div class="d-flex justify-content-between align-items-center cursor-pointer"
                        data-bs-toggle="collapse" data-bs-target="#instruccionesManual" aria-expanded="true">
                        <h6 class="fw-bold mb-0" style="font-size: 0.85rem; letter-spacing: 0.5px; color: #004d40;">
                            <i class="bi bi-ui-checks-grid me-2"></i> MODO MANUAL. PASOS A SEGUIR Y OPCIONES
                        </h6>
                        <i class="bi bi-chevron-down text-dark"></i>
                    </div>

                    <div class="collapse show mt-3" id="instruccionesManual">
                        <div class="row align-items-center g-3 border-bottom pb-4"
                            style="border-color: #b2dfdb !important;">
                            <div class="col-md-4 d-flex align-items-start border-end-md" style="border-color: #b2dfdb;">
                                <div class="step-badge shadow-sm" style="background-color: #00695c;">1</div>
                                <div class="step-text">
                                    <span class="step-title" style="color: #00695c;">AGREGAR</span>
                                    Busca tu materia a la izquierda y selecciónala.
                                </div>
                            </div>
                            <div class="col-md-4 d-flex align-items-start border-end-md" style="border-color: #b2dfdb;">
                                <div class="step-badge shadow-sm" style="background-color: #00695c;">2</div>
                                <div class="step-text">
                                    <span class="step-title" style="color: #00695c;">SELECCIONAR</span>
                                    En el panel derecho selecciona al profesor y presiona continuar.
                                </div>
                            </div>
                            <div class="col-md-4 d-flex align-items-start">
                                <div class="step-badge shadow-sm" style="background-color: #00695c;">3</div>
                                <div class="step-text">
                                    <span class="step-title" style="color: #00695c;">VISUALIZA</span>
                                    Repite con la siguiente materia y observa tu horario.
                                </div>
                            </div>
                        </div>

                        <h6 class="fw-bold mb-3 pb-2 border-bottom mt-4"
                            style="color: #004d40; border-color: #b2dfdb !important;">
                            <i class="bi bi-stars text-warning"></i> Opciones Avanzadas
                        </h6>

                        <div class="row g-3">
                            <div class="col-md-6 col-lg-3">
                                <div class="p-3 border rounded bg-white h-100 shadow-sm d-flex flex-column">
                                    <div class="text-danger mb-2"><i class="bi bi-exclamation-triangle-fill fs-4"></i>
                                    </div>
                                    <h6 class="fw-bold small text-dark">Manejo de Traslapes</h6>
                                    <p class="small text-muted mb-0">Se te mostrarán en color rojo los traslapes.
                                        Confirma
                                        si deseas reemplazar o cancelar.</p>
                                </div>
                            </div>

                            <div class="col-md-6 col-lg-3">
                                <div class="p-3 border rounded bg-white h-100 shadow-sm d-flex flex-column">
                                    <div class="text-success mb-2"><i class="bi bi-hdd-fill fs-4"></i></div>
                                    <h6 class="fw-bold small text-dark">Multi-Guardado</h6>
                                    <p class="small text-muted mb-0">Guarda tu versión actual, ponle nombre, crea uno
                                        nuevo
                                        y alterna entre ellos.</p>
                                </div>
                            </div>

                            <div class="col-md-6 col-lg-3">
                                <div class="p-3 border rounded bg-white h-100 shadow-sm d-flex flex-column">
                                    <div class="text-primary mb-2"><i class="bi bi-arrow-counterclockwise fs-4"></i>
                                    </div>
                                    <h6 class="fw-bold small text-dark">Deshacer / Rehacer</h6>
                                    <p class="small text-muted mb-0">¿Te equivocaste? Usa las flechas deshacer para
                                        corregir
                                        sin perder nada.</p>
                                </div>
                            </div>

                            <div class="col-md-6 col-lg-3">
                                <div class="p-3 border rounded bg-white h-100 shadow-sm d-flex flex-column">
                                    <div class="text-info mb-2"><i class="bi bi-sort-down fs-4"></i></div>
                                    <h6 class="fw-bold small text-dark">Orden de Visualizacion</h6>
                                    <p class="small text-muted mb-0">Usa el filtro para ordenar tu lista por materia,
                                        profesor, grupo, duración tota u orden cronológico.</p>
                                </div>
                            </div>

                            <div class="col-md-6 col-lg-3">
                                <div class="p-3 border rounded bg-white h-100 shadow-sm d-flex flex-column">
                                    <div class="text-warning mb-2"><i class="bi bi-layout-text-window-reverse fs-4"></i>
                                    </div>
                                    <h6 class="fw-bold small text-dark">Modo Visual</h6>
                                    <p class="small text-muted mb-0">Activa el switch "Visual" para ver bloques de
                                        colores.
                                        Usa el engrane para ocultar datos.</p>
                                </div>
                            </div>

                            <div class="col-md-6 col-lg-3">
                                <div class="p-3 border rounded bg-white h-100 shadow-sm d-flex flex-column">
                                    <div style="color: #6f42c1;" class="mb-2"><i class="bi bi-palette-fill fs-4"></i>
                                    </div>
                                    <h6 class="fw-bold small text-dark">Colores a tu gusto</h6>
                                    <p class="small text-muted mb-0">En modo visual, presiona el botón de paleta <i
                                            class="bi bi-palette"></i> para reasignar colores.</p>
                                </div>
                            </div>

                            <div class="col-md-6 col-lg-6">
                                <div
                                    class="p-3 border rounded bg-white h-100 shadow-sm d-flex flex-row align-items-center">
                                    <div class="text-secondary me-3"><i class="bi bi-download fs-1"></i></div>
                                    <div>
                                        <h6 class="fw-bold small text-dark">Exportación Total</h6>
                                        <p class="small text-muted mb-0">Descarga tu horario en <strong>PDF</strong>,
                                            <strong> png</strong>, <strong>Excel</strong> o <strong>CSV</strong>.
                                        </p>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <div class="row g-3 h-100">
                    <div class="col-lg-3 col-md-4 d-flex flex-column">
                        <div class="card shadow-sm flex-grow-1" style="height: auto;">
                            <div class="card-header bg-white py-3">
                                <h6 class="fw-bold mb-2" style="color: #00695c;"><i class="bi bi-search"></i> 1. Elige
                                    Materia</h6>
                                <input type="text" id="buscador" class="form-control form-control-sm"
                                    placeholder="Buscar materia..." onkeyup="filtrarMaterias()">
                            </div>
                            <div class="card-body p-0 overflow-auto" id="lista-materias-container">
                                <div id="lista-materias" class="list-group list-group-flush"></div>
                            </div>
                        </div>
                    </div>

                    <div class="col-lg-9 col-md-8 d-flex flex-column">

                        <div id="contenedor-panel-manual" class="card shadow-sm border-0 mb-3 bg-light"
                            style="flex-shrink: 0;">
                            <div class="card-header bg-white d-flex justify-content-between align-items-center py-2">
                                <div class="d-flex align-items-center">
                                    <h6 class="fw-bold mb-0 me-3" id="titulo-seleccion" style="color: #00695c;"><i
                                            class="bi bi-arrow-left-circle"></i> 2. Selecciona un Profesor</h6>
                                    <span class="badge bg-light text-dark border"
                                        id="info-seleccion">Esperando...</span>
                                </div>
                            </div>
                            <div class="card-body bg-light py-2" id="body-panel-manual">
                                <div id="contenedor-grupos" class="horizontal-scroll-container">
                                    <div class="text-center text-muted py-4 w-100">
                                        <i class="bi bi-hand-index-thumb display-6 opacity-25"></i>
                                        <p class="mt-2 small mb-0">Selecciona una materia del menú izquierdo.</p>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <div class="card shadow-sm border-0 flex-grow-1" style="min-height: 400px;">
                            <div <div class="card-header toolbar-manual-container header-acciones">
                                <!-- SECCIÓN IZQUIERDA: GESTIÓN DE HORARIOS -->
                                <div class="group-left">
                                    <div class="d-flex align-items-center bg-white rounded-pill px-2 border shadow-sm"
                                        style="height: 38px;">
                                        <select id="selector-horarios"
                                            class="select-tool-sched border-0 bg-transparent ps-2 py-1"
                                            style="max-width:140px;" onchange="cambiarHorarioActivo()"></select>
                                        <div class="vr mx-1"></div>
                                        <button class="btn btn-sm text-primary" onclick="crearNuevoHorario()"
                                            title="Crear nuevo horario"><i class="bi bi-plus-lg"></i></button>
                                    </div>

                                    <div class="d-flex align-items-center gap-1">
                                        <input type="text" id="nombre-horario-actual" class="input-tool-name shadow-sm"
                                            style="height: 38px;" value="Mi Horario" placeholder="Nombrar...">
                                        <button class="btn-tool btn-tool-primary shadow-sm"
                                            style="height: 38px; width: 38px; justify-content: center; padding: 0;"
                                            onclick="guardarNombreHorario()" title="Guardar nombre"><i
                                                class="bi bi-floppy"></i></button>
                                        <button class="btn-tool btn-tool-danger shadow-sm"
                                            style="height: 38px; width: 38px; justify-content: center; padding: 0;"
                                            onclick="eliminarHorarioActual()" title="Eliminar este horario"><i
                                                class="bi bi-trash"></i></button>
                                    </div>
                                </div>

                                <!-- SECCIÓN CENTRAL: HERRAMIENTAS Y VISTA -->
                                <div class="group-center d-flex align-items-center gap-2">
                                    <div class="btn-group shadow-sm rounded-3">
                                        <button class="btn btn-light border" id="btn-undo" onclick="undo()" disabled
                                            title="Deshacer (Undo)"><i
                                                class="bi bi-arrow-counterclockwise"></i></button>
                                        <button class="btn btn-light border" id="btn-redo" onclick="redo()" disabled
                                            title="Rehacer (Redo)"><i class="bi bi-arrow-clockwise"></i></button>
                                    </div>

                                    <div class="visual-pill shadow-sm"
                                        onclick="document.getElementById('switch-vista').click()">
                                        <div class="form-check form-switch m-0 d-flex align-items-center">
                                            <input class="form-check-input" type="checkbox" id="switch-vista"
                                                onclick="event.stopPropagation()" onchange="toggleVistaVisual()">
                                            <span class="ms-2"> MODO VISUAL</span>
                                        </div>
                                    </div>

                                    <button id="btn-recolorear" class="btn-tool bg-white shadow-sm border"
                                        style="display:none;" onclick="recolorearInteligente()"
                                        title="Reasignar colores (Manual)"><i
                                            class="bi bi-palette text-primary"></i></button>

                                    <div class="dropdown">
                                        <button class="btn-tool bg-white shadow-sm border" type="button"
                                            data-bs-toggle="dropdown" aria-expanded="false"><i
                                                class="bi bi-gear-fill text-secondary"></i></button>
                                        <ul class="dropdown-menu dropdown-menu-end dropdown-menu-tool shadow p-0"
                                            onclick="event.stopPropagation()">
                                            <li>
                                                <h6 class="dropdown-header-tool">Mostrar en visual</h6>
                                            </li>
                                            <li>
                                                <div class="dropdown-item-tool">
                                                    <div class="form-check small m-0"><input
                                                            class="form-check-input vis-toggle" type="checkbox"
                                                            id="chk-prof" checked
                                                            onchange="actualizarConfigVisual()"><label
                                                            class="form-check-label w-100"
                                                            for="chk-prof">Profesor</label></div>
                                                </div>
                                            </li>
                                            <li>
                                                <div class="dropdown-item-tool">
                                                    <div class="form-check small m-0"><input
                                                            class="form-check-input vis-toggle" type="checkbox"
                                                            id="chk-grupo" checked
                                                            onchange="actualizarConfigVisual()"><label
                                                            class="form-check-label w-100" for="chk-grupo">Grupo</label>
                                                    </div>
                                                </div>
                                            </li>
                                            <li>
                                                <div class="dropdown-item-tool">
                                                    <div class="form-check small m-0"><input
                                                            class="form-check-input vis-toggle" type="checkbox"
                                                            id="chk-horas" checked
                                                            onchange="actualizarConfigVisual()"><label
                                                            class="form-check-label w-100"
                                                            for="chk-horas">Horario</label></div>
                                                </div>
                                            </li>
                                        </ul>
                                    </div>
                                </div>

                                <!-- SECCIÓN DERECHA: ORDEN Y EXPORT -->
                                <div class="group-right d-flex align-items-center gap-2">
                                    <!-- Hidden select for compatibility -->
                                    <select id="sort-manual" style="display:none;">
                                        <option value="materia" selected>Materia</option>
                                        <option value="profesor">Profesor</option>
                                        <option value="grupo">Grupo</option>
                                        <option value="horas">Duración</option>
                                        <option value="cronologico">Crono</option>
                                    </select>

                                    <div class="dropdown">
                                        <button
                                            class="btn btn-sm btn-light border shadow-sm dropdown-toggle fw-bold text-secondary"
                                            type="button" data-bs-toggle="dropdown" aria-expanded="false"
                                            style="border-radius: 20px; padding-left: 15px; padding-right: 15px;">
                                            <i class="bi bi-sort-down me-1"></i> <span
                                                id="btn-sort-label">Materia</span>
                                        </button>
                                        <ul class="dropdown-menu dropdown-menu-end shadow border-0 rounded-3 mt-1">
                                            <li><button class="dropdown-item small fw-bold py-2"
                                                    onclick="ordenarMiHorario('materia')">Materia</button></li>
                                            <li><button class="dropdown-item small fw-bold py-2"
                                                    onclick="ordenarMiHorario('profesor')">Profesor (A-Z)</button></li>
                                            <li><button class="dropdown-item small fw-bold py-2"
                                                    onclick="ordenarMiHorario('grupo')">Grupo</button></li>
                                            <li><button class="dropdown-item small fw-bold py-2"
                                                    onclick="ordenarMiHorario('horas')">Duración Total</button></li>
                                            <li><button class="dropdown-item small fw-bold py-2"
                                                    onclick="ordenarMiHorario('cronologico')">Orden Cronológico</button>
                                            </li>
                                        </ul>
                                    </div>

                                    <span id="creditos-badge"
                                        class="badge rounded-pill bg-light text-dark border shadow-sm py-2 px-3">0
                                        Créditos</span>

                                    <div class="btn-group">
                                        <button type="button"
                                            class="btn btn-success btn-sm fw-bold shadow-sm dropdown-toggle rounded-pill px-3"
                                            data-bs-toggle="dropdown" aria-expanded="false">
                                            <i class="bi bi-download"></i> Descargar
                                        </button>
                                        <ul class="dropdown-menu dropdown-menu-end shadow border-0 rounded-3 mt-1">
                                            <li><button class="dropdown-item small py-2" onclick="descargarPDF()"><i
                                                        class="bi bi-file-earmark-pdf text-danger me-2"></i>PDF</button>
                                            </li>
                                            <li><button class="dropdown-item small py-2" onclick="descargarImagen()"><i
                                                        class="bi bi-file-image text-primary me-2"></i>Imagen
                                                    PNG</button></li>
                                            <li><button class="dropdown-item small py-2" onclick="descargarExcel()"><i
                                                        class="bi bi-file-earmark-excel text-success me-2"></i>Excel</button>
                                            </li>
                                            <li><button class="dropdown-item small py-2" onclick="descargarCSV()"><i
                                                        class="bi bi-file-text me-2"></i>CSV</button></li>
                                        </ul>
                                    </div>

                                    <button class="btn btn-sm btn-outline-danger border-0 rounded-circle shadow-sm"
                                        id="btn-limpiar-manual" onclick="limpiarTodoManual()"
                                        style="display:none; width: 32px; height: 32px;" title="Borrar todo"><i
                                            class="bi bi-trash"></i></button>
                                </div>
                            </div>
                            <div class="card-body p-0 d-flex flex-column" style="overflow: hidden;">
                                <div id="vista-lista-container" class="table-responsive bg-white p-2 flex-grow-1"
                                    style="overflow-y: auto;">
                                    <table class="table table-bordered table-hover mb-0 tabla-siae">
                                        <thead class="sticky-top">
                                            <tr>
                                                <th>Materia</th>
                                                <th>Gpo</th>
                                                <th>Profesor</th>
                                                <th class="col-dia">Lun</th>
                                                <th class="col-dia">Mar</th>
                                                <th class="col-dia">Mie</th>
                                                <th class="col-dia">Jue</th>
                                                <th class="col-dia">V</th>
                                                <th class="col-dia">S</th>
                                                <th>Cr</th>
                                                <th>Obs</th>
                                                <th></th>
                                            </tr>
                                        </thead>
                                        <tbody id="tabla-mi-horario">
                                            <tr>
                                                <td colspan="12" class="text-center text-muted py-4">No has agregado
                                                    materias aún.</td>
                                            </tr>
                                        </tbody>
                                    </table>
                                </div>
                                <div id="vista-visual-container" class="table-responsive bg-white p-3 flex-grow-1"
                                    style="display:none; overflow-y: auto;">
                                    <table class="table mb-0 tabla-visual w-100">
                                        <thead>
                                            <tr>
                                                <th style="width:50px;">Hora</th>
                                                <th>Lunes</th>
                                                <th>Martes</th>
                                                <th>Miércoles</th>
                                                <th>Jueves</th>
                                                <th>Viernes</th>
                                                <th>Sábado</th>
                                            </tr>
                                        </thead>
                                        <tbody id="grid-horario-visual"></tbody>
                                    </table>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <div id="vista-auto" class="container-fluid p-0" style="display:none;">
                <div class="instruction-bar p-3 mx-3 mb-3"
                    style="background-color: #f3e5f5; border: 1px solid #e1bee7; border-left: 5px solid #6a1b9a;">
                    <div class="d-flex justify-content-between align-items-center cursor-pointer"
                        data-bs-toggle="collapse" data-bs-target="#instruccionesAuto" aria-expanded="true">
                        <h6 class="fw-bold mb-0" style="font-size: 0.85rem; letter-spacing: 0.5px; color: #4a148c;">
                            <i class="bi bi-cpu-fill me-2"></i> MODO EXPLORAR. PASOS A SEGUIR Y OPCIONES
                        </h6>
                        <i class="bi bi-chevron-down text-dark"></i>
                    </div>

                    <div class="collapse show mt-3" id="instruccionesAuto">
                        <div class="row align-items-center g-3 border-bottom pb-4"
                            style="border-color: #e1bee7 !important;">
                            <div class="col-md-4 d-flex align-items-start border-end-md" style="border-color: #e1bee7;">
                                <div class="step-badge shadow-sm" style="background-color: #6a1b9a;">1</div>
                                <div class="step-text">
                                    <span class="step-title" style="color: #6a1b9a;">AGREGAR</span>
                                    Busca tu materia a la izquierda y selecciónala.
                                </div>
                            </div>
                            <div class="col-md-4 d-flex align-items-start border-end-md" style="border-color: #e1bee7;">
                                <div class="step-badge shadow-sm" style="background-color: #6a1b9a;">2</div>
                                <div class="step-text">
                                    <span class="step-title" style="color: #6a1b9a;">SELECCIONAR</span>
                                    En el panel derecho selecciona todos los profesores que quieras.
                                </div>
                            </div>
                            <div class="col-md-4 d-flex align-items-start">
                                <div class="step-badge shadow-sm" style="background-color: #6a1b9a;">3</div>
                                <div class="step-text">
                                    <span class="step-title" style="color: #6a1b9a;">GENERAR</span>
                                    Presiona generar horarios y visualiza todas las combinaciones.
                                </div>
                            </div>
                        </div>

                        <h6 class="fw-bold mb-3 pb-2 border-bottom mt-4"
                            style="color: #4a148c; border-color: #e1bee7 !important;">
                            <i class="bi bi-stars" style="color: #aa00ff;"></i> Opciones Avanzadas y Filtros
                        </h6>

                        <div class="row g-3">
                            <div class="col-md-6 col-lg-4">
                                <div class="p-3 border rounded bg-white h-100 shadow-sm d-flex flex-column">
                                    <div class="mb-2" style="color: #d32f2f;"><i class="bi bi-shield-x fs-4"></i></div>
                                    <h6 class="fw-bold small text-dark">Manejo de Traslapes</h6>
                                    <p class="small text-muted mb-0">El sistema oculta automáticamente los traslapes. Si
                                        tienes un conflicto inevitable entre tus selecciones, te marcará en rojo dónde
                                        está el
                                        problema.</p>
                                </div>
                            </div>

                            <div class="col-md-12 col-lg-8">
                                <div class="p-3 border rounded bg-white h-100 shadow-sm">
                                    <div class="d-flex align-items-center mb-2">
                                        <div class="me-2" style="color: #6a1b9a;"><i class="bi bi-funnel-fill fs-4"></i>
                                        </div>
                                        <h6 class="fw-bold small text-dark mb-0">Filtrados</h6>
                                    </div>
                                    <div class="row g-2">
                                        <div class="col-md-6">
                                            <ul class="small text-muted mb-0 ps-3">
                                                <li><strong>Ordenar:</strong> Visualiza horarios con menos días de
                                                    asistencia,
                                                    más créditos o huecos compactos.</li>
                                                <li><strong>Turno:</strong> Filtra opciones matutinas, vespertinas o
                                                    mixtas.
                                                </li>
                                            </ul>
                                        </div>
                                        <div class="col-md-6">
                                            <ul class="small text-muted mb-0 ps-3">
                                                <li><strong>Días Libres:</strong> Observa combinaciones que te dejen
                                                    días
                                                    completos sin clase.</li>
                                                <li><strong>Profesores:</strong> ¿Buscas a alguien específico? Búscalo
                                                    en
                                                    este filtro.</li>
                                            </ul>
                                        </div>
                                    </div>
                                </div>
                            </div>

                            <div class="col-md-6 col-lg-4">
                                <div class="p-3 border rounded bg-white h-100 shadow-sm d-flex flex-column"
                                    style="border-left: 4px solid #6a1b9a !important;">
                                    <div class="mb-2" style="color: #6a1b9a;"><i
                                            class="bi bi-arrow-right-circle-fill fs-4"></i></div>
                                    <h6 class="fw-bold small text-dark">Transferir a Manual</h6>
                                    <p class="small text-muted mb-0">Si encuentras un horario base que te gusta, envíalo
                                        al
                                        "Generador Manual" para editar detalles finos.</p>
                                </div>
                            </div>

                            <div class="col-md-6 col-lg-4">
                                <div class="p-3 border rounded bg-white h-100 shadow-sm d-flex flex-column">
                                    <div class="text-warning mb-2"><i class="bi bi-layout-text-window-reverse fs-4"></i>
                                    </div>
                                    <h6 class="fw-bold small text-dark">Modo Visual</h6>
                                    <p class="small text-muted mb-0">Haz la tabla dinámica interactiva. Activa el switch
                                        en
                                        cada resultado para verlo gráficamente.</p>
                                </div>
                            </div>

                            <div class="col-md-6 col-lg-4">
                                <div class="p-3 border rounded bg-white h-100 shadow-sm d-flex flex-column">
                                    <div style="color: #6f42c1;" class="mb-2"><i class="bi bi-palette-fill fs-4"></i>
                                    </div>
                                    <h6 class="fw-bold small text-dark">Reasigna Colores</h6>
                                    <p class="small text-muted mb-0">¿No te gustan los colores? Reasigna la paleta de
                                        colores a tu gusto.</p>
                                </div>
                            </div>

                            <div class="col-md-12">
                                <div
                                    class="p-3 border rounded bg-white h-100 shadow-sm d-flex flex-row align-items-center">
                                    <div class="text-secondary me-3"><i class="bi bi-download fs-1"></i></div>
                                    <div>
                                        <h6 class="fw-bold small text-dark">Descarga y Guarda</h6>
                                        <p class="small text-muted mb-0">Puedes descargar tu opción elegida en PDF, PNG,
                                            Excel o CSV para tenerla a la mano.</p>
                                    </div>
                                </div>
                            </div>

                        </div>
                    </div>
                </div>
                <div class="row g-3">

                    <div class="col-lg-3 col-md-4 d-flex flex-column gap-3">

                        <div class="card shadow-sm flex-grow-1" style="height: auto;">
                            <div class="card-header bg-white py-3">
                                <h6 class="fw-bold mb-2" style="color: #6a1b9a;"><i class="bi bi-search"></i> 1. Elige
                                    Materia</h6>
                                <input type="text" id="buscador-auto" class="form-control form-control-sm"
                                    placeholder="Buscar materia..." onkeyup="filtrarMateriasAuto()">
                            </div>
                            <div class="card-body p-0">
                                <div id="lista-materias-auto" class="list-group list-group-flush"></div>
                            </div>
                        </div>

                        <div class="card border-0 shadow-sm flex-shrink-0">
                            <div class="card-header bg-white d-flex justify-content-between align-items-center">
                                <span class="fw-bold small text-uppercase" style="color: #6a1b9a;"><i
                                        class="bi bi-list-check"></i> 3. Mis Selecciones</span>
                                <button class="btn btn-sm text-danger" onclick="limpiarBolsa()" title="Limpiar todo"><i
                                        class="bi bi-trash"></i></button>
                            </div>
                            <div class="card-body p-0">
                                <ul id="lista-bolsa" class="list-group list-group-flush small">
                                    <li class="list-group-item text-muted text-center py-3">Vacío</li>
                                </ul>
                            </div>
                            <div class="card-footer bg-light border-top p-2">
                                <button class="btn btn-custom-auto w-100 fw-bold py-2" onclick="generarCombinaciones()">
                                    <i class="bi bi-cpu-fill"></i> GENERAR HORARIOS
                                </button>
                            </div>
                        </div>
                    </div>

                    <div class="col-lg-9 col-md-8 d-flex flex-column">

                        <div id="contenedor-panel-auto" class="card shadow-sm border-0 mb-3 flex-shrink-0"
                            style="height: auto; min-height: 100px;">
                            <div class="card-header bg-white d-flex justify-content-between align-items-center">
                                <h6 class="fw-bold mb-0" id="titulo-seleccion-auto" style="color: #6a1b9a;"><i
                                        class="bi bi-arrow-left-circle"></i> 3. Selecciona Profesores o grupos</h6>
                                <span class="badge bg-light text-dark border"
                                    id="info-seleccion-auto">Esperando...</span>
                            </div>
                            <div class="card-body bg-light">
                                <div id="contenedor-grupos-auto" class="horizontal-scroll-container">
                                    <div class="text-center text-muted py-5 w-100">
                                        <i class="bi bi-hand-index-thumb display-4 opacity-25"></i>
                                        <p class="mt-3 lead small">Selecciona una materia a la izquierda para ver sus
                                            grupos o profesores aquí.</p>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <div class="card border-0 shadow" style="min-height: 0;">

                            <div class="card-header bg-white fw-bold d-flex justify-content-between align-items-center">
                                <div>
                                    <span style="color: #6a1b9a;"><i class="bi bi-table"></i> Resultados</span>
                                    <span id="conteo-resultados" class="badge bg-light text-dark border ms-2">0
                                        opciones</span>
                                </div>
                            </div>

                            <div id="panel-filtros-resultados" class="panel-filtros p-2" style="display:none;">
                                <div class="row g-2">
                                    <div class="col-md-3"><span class="label-filtro">Ordenar:</span><select
                                            id="sort-resultados" class="form-select form-select-sm border-primary"
                                            onchange="aplicarOrdenYFiltro()">
                                            <option value="dias">Menos Días</option>
                                            <option value="creditos">Más Créditos</option>
                                            <option value="huecos">Menos Huecos</option>
                                        </select></div>
                                    <div class="col-md-3"><span class="label-filtro">Turno:</span><select
                                            id="filtro-turno" class="form-select form-select-sm border-primary"
                                            onchange="aplicarOrdenYFiltro()">
                                            <option value="">Cualquiera</option>
                                            <option value="matutino">Matutino</option>
                                            <option value="vespertino">Vespertino</option>
                                        </select></div>
                                    <div class="col-md-3">
                                        <span class="label-filtro">Días Libres:</span>
                                        <div class="dropdown" id="dropdown-dias-container">
                                            <button
                                                class="btn btn-sm btn-outline-primary dropdown-toggle w-100 text-truncate"
                                                type="button" data-bs-toggle="dropdown" aria-expanded="false"
                                                id="btn-filtro-dia" style="font-size:0.75rem;">Ninguno</button>
                                            <div class="dropdown-menu p-2 shadow" onclick="event.stopPropagation()">
                                                <div class="form-check mb-1"><input
                                                        class="form-check-input chk-filtro-dia" type="checkbox"
                                                        value="LUNES" id="fd-l" onchange="aplicarOrdenYFiltro()"><label
                                                        class="form-check-label small" for="fd-l">Lunes</label></div>
                                                <div class="form-check mb-1"><input
                                                        class="form-check-input chk-filtro-dia" type="checkbox"
                                                        value="MARTES" id="fd-m" onchange="aplicarOrdenYFiltro()"><label
                                                        class="form-check-label small" for="fd-m">Martes</label></div>
                                                <div class="form-check mb-1"><input
                                                        class="form-check-input chk-filtro-dia" type="checkbox"
                                                        value="MIERCOLES" id="fd-mi"
                                                        onchange="aplicarOrdenYFiltro()"><label
                                                        class="form-check-label small" for="fd-mi">Miércoles</label>
                                                </div>
                                                <div class="form-check mb-1"><input
                                                        class="form-check-input chk-filtro-dia" type="checkbox"
                                                        value="JUEVES" id="fd-j" onchange="aplicarOrdenYFiltro()"><label
                                                        class="form-check-label small" for="fd-j">Jueves</label></div>
                                                <div class="form-check mb-1"><input
                                                        class="form-check-input chk-filtro-dia" type="checkbox"
                                                        value="VIERNES" id="fd-v"
                                                        onchange="aplicarOrdenYFiltro()"><label
                                                        class="form-check-label small" for="fd-v">Viernes</label></div>
                                                <div class="form-check mb-1"><input
                                                        class="form-check-input chk-filtro-dia" type="checkbox"
                                                        value="SABADO" id="fd-s" onchange="aplicarOrdenYFiltro()"><label
                                                        class="form-check-label small" for="fd-s">Sábado</label></div>
                                            </div>
                                        </div>
                                    </div>
                                    <div class="col-md-3">
                                        <span class="label-filtro">Profesores:</span>
                                        <div class="dropdown" id="dropdown-profes-container">
                                            <button
                                                class="btn btn-sm btn-outline-primary dropdown-toggle w-100 text-truncate"
                                                type="button" data-bs-toggle="dropdown" aria-expanded="false"
                                                id="btn-filtro-profe" style="font-size:0.75rem;">Todos</button>
                                            <div class="dropdown-menu p-2 shadow"
                                                style="width: 250px; max-height: 300px; overflow-y: auto;"
                                                onclick="event.stopPropagation()">
                                                <input type="text" class="form-control form-control-sm mb-2"
                                                    placeholder="Buscar profe..."
                                                    onkeyup="filtrarListaProfesResultados(this)">
                                                <div class="d-flex justify-content-between mb-2 pb-1 border-bottom">
                                                    <button class="btn btn-sm btn-link p-0 text-decoration-none"
                                                        onclick="toggleAllProfesResultados(true)"
                                                        style="font-size:0.75rem;">Seleccionar Todos</button>
                                                    <button
                                                        class="btn btn-sm btn-link p-0 text-decoration-none text-danger"
                                                        onclick="toggleAllProfesResultados(false)"
                                                        style="font-size:0.75rem;">Limpiar</button>
                                                </div>
                                                <div id="lista-profes-filtro-resultados"></div>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>

                            <div class="card-body bg-light overflow-auto p-0" id="resultados-auto"
                                style="min-height: 200px;">
                                <div class="text-center text-muted py-5">
                                    <p class="small">Configura tus profesores arriba y genera horarios.</p>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <div class="modal fade" id="modalDetallesMateria" tabindex="-1" aria-hidden="true">
                <div class="modal-dialog modal-dialog-centered">
                    <div class="modal-content overflow-hidden border-0 shadow">
                        <div class="modal-header border-bottom-0 pb-0 text-center justify-content-center">
                            <h5 class="modal-title fw-bold text-primary" id="tituloMateriaModal">Detalles</h5>
                        </div>
                        <div class="modal-body p-0">
                            <div class="modal-profe-area">
                                <h6 class="text-muted small text-uppercase fw-bold mb-2">Profesor(a) Titular</h6>
                                <h4 class="fw-bold text-dark mb-0" id="profeMateriaModal">--</h4>
                            </div>
                            <div class="modal-obs-area">
                                <h6 class="text-muted small text-uppercase fw-bold mb-2">Observaciones</h6>
                                <p class="mb-0 fst-italic" id="obsMateriaModal">--</p>
                            </div>
                        </div>
                        <div class="modal-footer d-flex justify-content-between border-top-0 pt-2 pb-3 bg-light px-4">
                            <button type="button" id="btnEliminarDesdeModal"
                                class="btn btn-sm btn-danger px-3 rounded-pill"><i class="bi bi-trash"></i> Eliminar
                                Materia</button>
                            <button type="button" class="btn btn-sm btn-secondary px-4 rounded-pill"
                                data-bs-dismiss="modal">Cerrar</button>
                        </div>
                    </div>
                </div>
            </div>


            <footer class="mt-auto bg-white border-top py-4">
                <div class="container text-center">
                    <button class="btn btn-outline-primary btn-sm mb-3" data-bs-toggle="modal"
                        data-bs-target="#modalReglas">
                        <i class="bi bi-info-circle"></i> Ver Normativa Académica y Créditos
                    </button>

                    <div class="mx-auto" style="max-width: 700px;">
                        <p class="small text-muted mb-1">
                            <strong>Aviso Importante:</strong> Esta herramienta es un simulador. Los horarios y
                            profesores están <strong>sujetos a cambios</strong> de último momento por parte de la
                            administración de la Facultad.
                        </p>
                        <p class="small text-muted mb-1">
                            Nos esforzamos por mantener la base de datos actualizada ante cualquier aviso, sin embargo,
                            <strong>no nos hacemos responsables</strong> por discrepancias entre este generador y el
                            sistema oficial al momento de tu inscripción.
                        </p>
                    </div>

                    <p class="small text-primary mt-3 fw-bold">¡Mucha suerte en sus inscripciones!</p>
                </div>
            </footer>

            <div class="modal fade" id="modalReglas" tabindex="-1" aria-hidden="true">
                <div class="modal-dialog modal-lg">
                    <div class="modal-content border-0 shadow">
                        <div class="modal-header bg-light">
                            <h5 class="modal-title fw-bold text-primary"><i class="bi bi-journal-bookmark-fill"></i>
                                Normativa y Créditos</h5>
                            <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                        </div>
                        <div class="modal-body p-0">
                            <ul class="list-group list-group-flush small">

                                <li
                                    class="list-group-item bg-warning bg-opacity-10 border-start border-4 border-warning p-3">
                                    <h6 class="fw-bold text-dark mb-2"><i class="bi bi-speedometer2"></i> Carga
                                        Académica:</h6>
                                    <div class="d-flex gap-2 align-items-center flex-wrap">
                                        <span class="badge bg-warning text-dark border border-warning">Mínimo 37
                                            Créditos</span>
                                        <span class="text-muted">Carga ideal para acabar en tiempo.</span>
                                    </div>
                                    <div class="d-flex gap-2 align-items-center flex-wrap mt-1">
                                        <span class="badge bg-danger border border-danger">Máximo 41 Créditos</span>
                                        <span class="text-muted">Tope del sistema (+1 recursamiento).</span>
                                    </div>
                                </li>

                                <li class="list-group-item px-4 py-3">
                                    <div class="fw-bold text-primary mb-1">1. Límites y Plazos</div>
                                    <p class="mb-1">El sistema permite inscribir hasta <strong>41 créditos</strong>
                                        semestrales, con opción a un recursamiento adicional. Tienes un margen de
                                        tolerancia de 3 a 4 créditos sobre los 310 totales del plan.</p>
                                    <p class="mb-0 text-muted fst-italic">Dispones de <strong>12 semestres</strong> para
                                        cursar en periodo ordinario; al finalizar este plazo, solo podrás acreditar
                                        mediante exámenes extraordinarios.</p>
                                </li>

                                <li class="list-group-item px-4 py-3">
                                    <div class="fw-bold text-primary mb-1">2. Asignaturas Optativas y Reprobación</div>
                                    <p class="mb-1">Si obtienes una calificación de <strong>NP o 5</strong> en una
                                        optativa, tienes la libertad de recursar la misma materia o elegir una distinta.
                                    </p>
                                    <p class="mb-0 text-muted">Recuerda que la oferta de optativas es variable; no todas
                                        se abren cada semestre. Verifica disponibilidad <a
                                            href="http://132.248.25.133/alumno/horarios/publicar/" target="_blank"
                                            class="fw-bold text-decoration-none">aquí</a>.</p>
                                </li>

                                <li class="list-group-item px-4 py-3">
                                    <div class="fw-bold text-primary mb-1">3. Movilidad y Planteles Externos</div>
                                    <p class="mb-0">Las materias cursadas en otros planteles o en programas de Movilidad
                                        Estudiantil aparecerán en tu Historia Académica y serán revalidadas según el
                                        Plan de Estudios. <strong>Ojo:</strong> Sus créditos se suman a tu tope
                                        semestral permitido (41 créditos).</p>
                                </li>

                                <li class="list-group-item bg-light px-4 py-3">
                                    <div class="d-flex align-items-start gap-2">
                                        <i class="bi bi-link-45deg fs-4 text-primary"></i>
                                        <div>
                                            <strong>Enlaces de consulta oficial:</strong><br>
                                            <a href="http://www.psicologia.unam.mx/programa-completo-de-la-licenciatura-en-psicologia/"
                                                target="_blank" class="text-decoration-none me-3"><i
                                                    class="bi bi-file-earmark-text"></i> Ver Programas de Asignatura</a>
                                        </div>
                                    </div>
                                </li>
                            </ul>
                        </div>
                        <div class="modal-footer border-0 pt-0">
                            <button type="button" class="btn btn-secondary rounded-pill px-4"
                                data-bs-dismiss="modal">Entendido</button>
                        </div>
                    </div>
                </div>
            </div>
            <div id="toast-guardado"><i class="bi bi-save"></i> Guardado</div>

            <div id="capture-container"></div>
            <script>
                let BD_CRUDA = [], BD_AGRUPADA = [], miHorario = [], bolsa = {}, materiaSeleccionadaActual = null, materiaSeleccionadaAuto = null;
                let MAPA_COLORES_ASIGNADOS = {};
                let OFFSET_RECOLOR = 0;
                let OFFSET_RECOLOR_AUTO = 0;
                let RESULTADOS_GLOBALES = [];
                let RESULTADOS_MOSTRADOS = [];
                let OFFSET_MOSTRADOS = 0;
                const BATCH_SIZE = 50;
                let historial = [];
                let futuro = [];
                let materiasPendientes = [];
                let configVisual = { prof: true, grupo: true, horas: true };
                let horariosGuardados = {};
                let activeScheduleId = "default";

                const DB_FILE = 'Horarios_Completo_UNAM.json';
                const PALETA_ENTERA = [
                    '#FFF9C4', '#F5F5DC', '#E3F2FD', '#F3E5F5', '#E0F2F1', '#FFF3E0', '#FBE9E7', '#FAFAFA',
                    '#ECEFF1', '#F9FBE7', '#FFF4F0', '#FFF4DC', '#F1F3FF', '#FFECF0', '#DCF2DD', '#D0F3CB',
                    '#DAEDAF', '#FFE8DC', '#E9F8FF', '#FAD2D2', '#FFD9E4', '#D1F3FF', '#CBE6F1', '#EADFFF',
                    '#D2DADD', '#FFFAC7', '#B0E0E0', '#B1CAFF', '#B7DAFF', '#FEDBD7', '#FFCCEA', '#FBC6F0',
                    '#FFE2C8', '#99DAFF', '#FFA79F', '#82E9E6', '#C3ADFF', '#FFC7BA'
                ];
                let PALETA_ORDENADA = [];

                function getLuminance(hex) { let c = hex.substring(1); let rgb = parseInt(c, 16); let r = (rgb >> 16) & 0xff; let g = (rgb >> 8) & 0xff; let b = (rgb >> 0) & 0xff; return 0.2126 * r + 0.7152 * g + 0.0722 * b; }
                function convertirMinutos(horaStr) { if (!horaStr || typeof horaStr !== 'string') return 0; const [h, m] = horaStr.split(':').map(Number); return (h * 60) + m; }
                function minutosAHora(minutos) { let h = Math.floor(minutos / 60); let m = minutos % 60; return `${h.toString().padStart(2, '0')}:${m.toString().padStart(2, '0')}`; }
                function asignarColorFijo(id_unico) { if (MAPA_COLORES_ASIGNADOS[id_unico]) return; let count = Object.keys(MAPA_COLORES_ASIGNADOS).length; let color = PALETA_ORDENADA[count % PALETA_ORDENADA.length]; MAPA_COLORES_ASIGNADOS[id_unico] = color; }

                // --- UNDO/REDO ---
                function registrarEstado() {
                    historial.push(JSON.parse(JSON.stringify(miHorario)));
                    futuro = [];
                    actualizarBotonesUndo();
                }

                function undo() {
                    if (historial.length === 0) return;
                    futuro.push(JSON.parse(JSON.stringify(miHorario)));
                    miHorario = historial.pop();
                    materiasPendientes = [];
                    guardarEstado();
                    actualizarUICompleta();
                    actualizarBotonesUndo();
                }

                function redo() {
                    if (futuro.length === 0) return;
                    historial.push(JSON.parse(JSON.stringify(miHorario)));
                    miHorario = futuro.pop();
                    materiasPendientes = [];
                    guardarEstado();
                    actualizarUICompleta();
                    actualizarBotonesUndo();
                }

                function actualizarBotonesUndo() {
                    document.getElementById('btn-undo').disabled = (historial.length === 0);
                    document.getElementById('btn-redo').disabled = (futuro.length === 0);
                }

                function actualizarUICompleta() {
                    actualizarTablaHorario();
                    renderizarHorarioVisual();
                    if (materiaSeleccionadaActual) cargarPanelGrupos(materiaSeleccionadaActual);
                    filtrarMaterias();
                }

                function recolorearInteligente() { OFFSET_RECOLOR++; let materiasOrdenadas = [...miHorario].sort((a, b) => { if (a.creditos !== b.creditos) return a.creditos - b.creditos; return a.asignatura.localeCompare(b.asignatura); }); let totalMaterias = materiasOrdenadas.length; let totalColores = PALETA_ORDENADA.length; if (totalMaterias > 0) { let step = totalColores / totalMaterias; materiasOrdenadas.forEach((mat, i) => { let baseIndex = Math.floor(i * step); let nextIndex = Math.floor((i + 1) * step); let sectionSize = Math.max(1, nextIndex - baseIndex); let indexWithin = OFFSET_RECOLOR % sectionSize; let finalIndex = baseIndex + indexWithin; if (finalIndex >= totalColores) finalIndex = totalColores - 1; MAPA_COLORES_ASIGNADOS[mat.id_unico] = PALETA_ORDENADA[finalIndex]; }); } guardarEstado(); renderizarHorarioVisual(); }

                function recolorearAuto() {
                    OFFSET_RECOLOR_AUTO++;
                    RESULTADOS_MOSTRADOS.forEach((res, i) => {
                        let switchVis = document.getElementById(`switch-auto-${i}`);
                        if (switchVis && switchVis.checked) {
                            let visualDiv = document.getElementById(`res-visual-${i}`);
                            if (visualDiv) {
                                visualDiv.innerHTML = generarHTMLGridVisual(`auto-${i}`);
                                renderizarBloquesEnGrid(res.cursos, `auto-${i}`);
                            }
                        }
                    });
                }

                function obtenerChoques(c1, lista) {
                    let conflictos = [];
                    if (!c1 || !lista) return conflictos;
                    for (let c2 of lista) {
                        let choca = false;
                        for (let s1 of c1.sesiones) {
                            for (let s2 of c2.sesiones) {
                                if (s1.dia === s2.dia) {
                                    if (s1.min_inicio < s2.min_fin && s2.min_inicio < s1.min_fin) {
                                        choca = true; break;
                                    }
                                }
                            }
                            if (choca) break;
                        }
                        if (choca) conflictos.push(c2);
                    }
                    return conflictos;
                }

                function hayChoque(c1, lista) { return obtenerChoques(c1, lista).length > 0; }
                function hayChoqueCombo(lista) { for (let i = 0; i < lista.length; i++) { for (let j = i + 1; j < lista.length; j++) { if (hayChoque(lista[i], [lista[j]])) return true; } } return false; }

                function actualizarConfigVisual() {
                    configVisual.prof = document.getElementById('chk-prof').checked;
                    configVisual.grupo = document.getElementById('chk-grupo').checked;
                    configVisual.horas = document.getElementById('chk-horas').checked;
                    renderizarHorarioVisual();
                    if (document.getElementById('vista-auto').style.display === 'block') {
                        RESULTADOS_MOSTRADOS.forEach((r, i) => {
                            let vis = document.getElementById(`res-visual-${i}`);
                            if (vis && vis.style.display === 'block') {
                                vis.innerHTML = generarHTMLGridVisual(`auto-${i}`);
                                renderizarBloquesEnGrid(r.cursos, `auto-${i}`);
                            }
                        });
                    }
                }

                // Se eliminó toggleFijarPanel por petición del usuario

                window.onload = function () {
                    PALETA_ORDENADA = [...PALETA_ENTERA].sort((a, b) => getLuminance(b) - getLuminance(a));
                    fetch(DB_FILE)
                        .then(res => { if (!res.ok) throw new Error("Error JSON"); return res.json(); })
                        .then(data => {
                            BD_CRUDA = data;
                            procesarDatosCrudos();
                            crearGridVisualVacia();
                            cargarEstado();
                            let semSelect = document.getElementById('semestre-selector');
                            if (semSelect.value) cambiarSemestre(false);
                        })
                        .catch(err => { console.error(err); alert("Error cargando datos: " + err.message); });
                };

                function procesarDatosCrudos() {
                    let temp = {};
                    BD_CRUDA.forEach(fila => {
                        let sem = parseInt(fila.semestre || 0);
                        let asig = (fila.asignatura || "SIN NOMBRE").toString().trim();
                        let prof = (fila.profesor || "POR ASIGNAR").toString().trim();
                        let gpo = (fila.grupo || "0").toString();
                        let area = (fila.area || "GENERAL").toString().trim();
                        if (area === "") area = "GENERAL";
                        let key = `${sem}-${asig}-${gpo}`;
                        if (!temp[key]) {
                            temp[key] = {
                                id_unico: fila.id_unico || Math.random(),
                                semestre: sem,
                                asignatura: asig,
                                profesor: prof,
                                grupo: gpo,
                                creditos: parseInt(fila.creditos || 0),
                                observaciones: fila.observaciones || "",
                                area: area,
                                sesiones: []
                            };
                        }
                        let d = fila.dia || "POR ASIGNAR";
                        let i = fila.hora_inicio || "00:00";
                        let f = fila.hora_fin || "00:00";
                        if (d !== "POR ASIGNAR" && i !== "00:00") {
                            temp[key].sesiones.push({
                                dia: d, inicio: i, fin: f,
                                min_inicio: convertirMinutos(i),
                                min_fin: convertirMinutos(f)
                            });
                        }
                    });
                    BD_AGRUPADA = Object.values(temp);
                }

                function guardarEstado() {
                    horariosGuardados[activeScheduleId].cursos = miHorario;
                    localStorage.setItem('unam_schedules_v3', JSON.stringify(horariosGuardados));
                    localStorage.setItem('unam_active_id_v3', activeScheduleId);
                    localStorage.setItem('unam_b_v3', JSON.stringify(bolsa));
                    localStorage.setItem('unam_colors_v3', JSON.stringify(MAPA_COLORES_ASIGNADOS));
                    mostrarToast();
                }

                function cargarEstado() {
                    let savedSchedules = localStorage.getItem('unam_schedules_v3');
                    if (savedSchedules) {
                        horariosGuardados = JSON.parse(savedSchedules);
                    } else {
                        horariosGuardados = { "default": { nombre: "Mi Horario 1", cursos: [] } };
                    }
                    let savedId = localStorage.getItem('unam_active_id_v3');
                    if (savedId && horariosGuardados[savedId]) {
                        activeScheduleId = savedId;
                    } else {
                        activeScheduleId = Object.keys(horariosGuardados)[0];
                    }
                    let b = localStorage.getItem('unam_b_v3');
                    let c = localStorage.getItem('unam_colors_v3');
                    if (b) bolsa = JSON.parse(b);
                    if (c) MAPA_COLORES_ASIGNADOS = JSON.parse(c);
                    miHorario = horariosGuardados[activeScheduleId].cursos || [];

                    historial = [];
                    futuro = [];
                    actualizarBotonesUndo();

                    actualizarUIHorarios();
                    actualizarTablaHorario();
                    renderBolsa();
                }

                function actualizarUIHorarios() {
                    let selector = document.getElementById('selector-horarios');
                    selector.innerHTML = '';
                    Object.keys(horariosGuardados).forEach(id => {
                        let opt = document.createElement('option');
                        opt.value = id;
                        opt.text = horariosGuardados[id].nombre;
                        if (id === activeScheduleId) opt.selected = true;
                        selector.appendChild(opt);
                    });
                    document.getElementById('nombre-horario-actual').value = horariosGuardados[activeScheduleId].nombre;
                }

                function cambiarHorarioActivo() {
                    activeScheduleId = document.getElementById('selector-horarios').value;
                    miHorario = horariosGuardados[activeScheduleId].cursos || [];
                    localStorage.setItem('unam_active_id_v3', activeScheduleId);
                    document.getElementById('nombre-horario-actual').value = horariosGuardados[activeScheduleId].nombre;
                    materiasPendientes = [];
                    historial = []; futuro = []; actualizarBotonesUndo();
                    actualizarTablaHorario();
                    renderizarHorarioVisual();
                    materiaSeleccionadaActual = null;
                    limpiarPanelGrupos();
                    filtrarMaterias();
                }

                function crearNuevoHorario() {
                    let newId = 'sched_' + Date.now();
                    let count = Object.keys(horariosGuardados).length + 1;
                    horariosGuardados[newId] = { nombre: `Nuevo Horario ${count}`, cursos: [] };
                    activeScheduleId = newId;
                    miHorario = [];
                    materiasPendientes = [];
                    historial = []; futuro = []; actualizarBotonesUndo();
                    guardarEstado();
                    actualizarUIHorarios();
                    actualizarTablaHorario();
                    renderizarHorarioVisual();
                    materiaSeleccionadaActual = null;
                    limpiarPanelGrupos();
                    filtrarMaterias();
                }

                function guardarNombreHorario() {
                    let nuevoNombre = document.getElementById('nombre-horario-actual').value.trim();
                    if (!nuevoNombre) return alert("El nombre no puede estar vacío");
                    horariosGuardados[activeScheduleId].nombre = nuevoNombre;
                    guardarEstado();
                    actualizarUIHorarios();
                }

                function eliminarHorarioActual() {
                    if (Object.keys(horariosGuardados).length <= 1) return alert("Debes tener al menos un horario.");
                    if (!confirm(`¿Eliminar "${horariosGuardados[activeScheduleId].nombre}" permanentemente?`)) return;
                    delete horariosGuardados[activeScheduleId];
                    activeScheduleId = Object.keys(horariosGuardados)[0];
                    miHorario = horariosGuardados[activeScheduleId].cursos;
                    materiasPendientes = [];
                    historial = []; futuro = []; actualizarBotonesUndo();
                    guardarEstado();
                    actualizarUIHorarios();
                    actualizarTablaHorario();
                    renderizarHorarioVisual();
                }

                function mostrarToast() { document.getElementById('toast-guardado').style.display = 'block'; setTimeout(() => document.getElementById('toast-guardado').style.display = 'none', 1500); }

                function toggleVistaVisual() {
                    let isVisual = document.getElementById('switch-vista').checked;
                    document.getElementById('vista-lista-container').style.display = isVisual ? 'none' : 'block';
                    document.getElementById('vista-visual-container').style.display = isVisual ? 'block' : 'none';
                    document.getElementById('btn-recolorear').style.display = isVisual ? 'inline-block' : 'none';

                    if (isVisual) renderizarHorarioVisual();
                }

                function crearGridVisualVacia() { let tbody = document.getElementById('grid-horario-visual'); tbody.innerHTML = ''; let startMin = 7 * 60; let endMin = 21 * 60; for (let m = startMin; m < endMin; m += 30) { let tr = document.createElement('tr'); let horaStr = minutosAHora(m); let idHora = m; let tdHora = document.createElement('td'); tdHora.className = 'hora-col'; tdHora.innerText = horaStr; tr.appendChild(tdHora);['LUNES', 'MARTES', 'MIERCOLES', 'JUEVES', 'VIERNES', 'SABADO'].forEach(dia => { let td = document.createElement('td'); td.id = `grid-${dia}-${idHora}`; td.dataset.dia = dia; td.dataset.min = idHora; tr.appendChild(td); }); tbody.appendChild(tr); } }

                function resaltarMateria(idUnico) {
                    let bloques = document.querySelectorAll(`.bloque-${idUnico}`);
                    bloques.forEach(b => b.classList.add('bloque-resaltado'));
                }
                function quitarResaltado(idUnico) {
                    let bloques = document.querySelectorAll(`.bloque-${idUnico}`);
                    bloques.forEach(b => b.classList.remove('bloque-resaltado'));
                }

                function renderizarHorarioVisual() {
                    document.querySelectorAll('#grid-horario-visual .bloque-materia').forEach(el => el.remove());

                    miHorario.forEach(curso => {
                        if (!MAPA_COLORES_ASIGNADOS[curso.id_unico]) asignarColorFijo(curso.id_unico);
                        let color = MAPA_COLORES_ASIGNADOS[curso.id_unico];
                        insertarBloque(curso, color, false);
                    });

                    materiasPendientes.forEach(item => {
                        insertarBloque(item.curso, 'transparent', true);
                    });
                }

                function insertarBloque(curso, color, esTraslape) {
                    let horasStr = curso.sesiones.map(s => `${s.dia.substr(0, 3)} ${s.inicio}-${s.fin}`).join('\n');
                    curso.sesiones.forEach(sesion => {
                        let diaNorm = sesion.dia.toUpperCase().replace('É', 'E');
                        let inicio = sesion.min_inicio;
                        let fin = sesion.min_fin;
                        let duration = fin - inicio;
                        let cellInicio = document.getElementById(`grid-${diaNorm}-${inicio}`);
                        if (cellInicio) {
                            let bloque = document.createElement('div');
                            bloque.className = `bloque-materia bloque-${curso.id_unico}`;

                            if (!configVisual.prof) bloque.classList.add('hide-prof');
                            if (!configVisual.grupo) bloque.classList.add('hide-group');
                            if (!configVisual.horas) bloque.classList.add('hide-time');

                            if (esTraslape) {
                                bloque.classList.add('bloque-traslape');
                            } else {
                                bloque.style.backgroundColor = color;
                                bloque.onmouseenter = () => resaltarMateria(curso.id_unico);
                                bloque.onmouseleave = () => quitarResaltado(curso.id_unico);
                            }

                            let slots = duration / 30;
                            let heightPx = (slots * 31) - 1;
                            bloque.style.height = `${heightPx}px`;
                            if (!esTraslape) {
                                bloque.onclick = (e) => { e.stopPropagation(); mostrarDetallesMateria(curso.id_unico); };
                            }

                            let htmlContent = `<div class="materia-nombre">${curso.asignatura}</div>`;
                            htmlContent += `<div class="materia-grupo">Gpo: ${curso.grupo}</div>`;
                            htmlContent += `<div class="materia-profe">${curso.profesor}</div>`;
                            htmlContent += `<div class="materia-horas">${horasStr}</div>`;

                            if (esTraslape) {
                                htmlContent += `<div class="label-traslape">TRASLAPE</div>`;
                            }

                            bloque.innerHTML = htmlContent;
                            cellInicio.appendChild(bloque);
                        }
                    });
                }

                function mostrarDetallesMateria(id) { let curso = miHorario.find(c => c.id_unico === id); if (!curso) return; document.getElementById('tituloMateriaModal').innerText = curso.asignatura; document.getElementById('profeMateriaModal').innerText = curso.profesor || "Profesor no asignado"; let obs = curso.observaciones ? curso.observaciones : "Sin observaciones registradas para este grupo."; document.getElementById('obsMateriaModal').innerText = obs; let btnEliminar = document.getElementById('btnEliminarDesdeModal'); btnEliminar.onclick = () => eliminarDesdeModal(id); let modal = new bootstrap.Modal(document.getElementById('modalDetallesMateria')); modal.show(); }

                function eliminarDesdeModal(id) {
                    if (!confirm("¿Estás seguro de eliminar esta materia?")) return;
                    registrarEstado();
                    let idx = miHorario.findIndex(c => c.id_unico === id);
                    if (idx > -1) {
                        let borrada = miHorario[idx];
                        miHorario.splice(idx, 1);
                        delete MAPA_COLORES_ASIGNADOS[id];
                        guardarEstado();
                        actualizarTablaHorario();
                        filtrarMaterias();
                        if (materiaSeleccionadaActual === borrada.asignatura) cargarPanelGrupos(borrada.asignatura);
                        let modalEl = document.getElementById('modalDetallesMateria');
                        let modal = bootstrap.Modal.getInstance(modalEl);
                        modal.hide();
                    }
                }

                function obtenerMateriasActivas() {
                    const selector = document.getElementById('semestre-selector');
                    const valor = selector.value;
                    if (valor === 'adicional') {
                        const filtroSistema = document.getElementById('filtro-sistema');
                        const sistema = filtroSistema ? filtroSistema.value : 'escolarizado';
                        return BD_AGRUPADA.filter(c => {
                            if (c.semestre !== 6 && c.semestre !== 8) return false;
                            const grupoNum = parseInt(c.grupo);
                            const esSUA = grupoNum >= 9000;
                            if (sistema === 'escolarizado' && esSUA) return false;
                            if (sistema === 'sua' && !esSUA) return false;
                            return true;
                        });
                    } else {
                        const sem = parseInt(valor);
                        // Mostrar materias del semestre seleccionado, o "PRINCIPIOS..." si estamos en 6to (ya que es de 8vo pero se abre a 6to)
                        return BD_AGRUPADA.filter(c => c.semestre === sem || (c.asignatura === "PRINCIPIOS DE SUSTENTABILIDAD" && sem === 6));
                    }
                }

                function cambiarSemestre(resetear = true) {
                    let val = document.getElementById('semestre-selector').value;
                    let sem = parseInt(val);
                    if (resetear) {
                        miHorario = [];
                        bolsa = {};
                        MAPA_COLORES_ASIGNADOS = {};
                        horariosGuardados = { "default": { nombre: "Mi Horario 1", cursos: [] } };
                        activeScheduleId = "default";
                        materiasPendientes = [];
                        historial = []; futuro = []; actualizarBotonesUndo();
                        guardarEstado();
                        actualizarUIHorarios();
                        actualizarTablaHorario();
                        renderBolsa();
                    }
                    document.getElementById('buscador').value = '';
                    document.getElementById('buscador-auto').value = '';
                    materiaSeleccionadaActual = null;
                    materiaSeleccionadaAuto = null;
                    limpiarPanelGrupos();
                    limpiarPanelGruposAuto();

                    let divAlerta = document.getElementById('alerta-semestre');
                    divAlerta.innerHTML = '';
                    if (val === 'adicional') {
                        divAlerta.innerHTML = `<div class="alert alert-info shadow-sm" role="alert"><div class="d-flex align-items-center mb-2"><i class="bi bi-info-circle-fill fs-4 me-2 text-primary"></i><h5 class="alert-heading fw-bold mb-0">Semestre Adicional: Reglas de Selección</h5></div><hr class="my-2"><div class="row align-items-center"><div class="col-md-8"><p class="small mb-1"><strong><i class="bi bi-card-checklist"></i> Requisitos Académicos:</strong></p><ul class="small mb-2 ps-3"><li>Elige asignaturas de <strong>6° y 8° semestre</strong> de la oferta vigente.</li><li>Propón asignaturas que <strong>no hayas inscrito previamente</strong>.</li><li>Rango de créditos obligatorio: <strong>Mínimo 31 - Máximo 41</strong>.</div><div class="col-md-4 mt-2 mt-md-0"><div class="bg-white p-3 rounded border border-primary"><label class="form-label fw-bold text-primary small mb-1">Sistema de Pertenencia:</label><select id="filtro-sistema" class="form-select form-select-sm border-primary" onchange="filtrarMaterias(); filtrarMateriasAuto();"><option value="escolarizado">Escolarizado (Gpos. 6000-8000)</option><option value="sua">SUA (Gpos. 9000)</option></select><small class="text-danger fw-bold d-block mt-1"><i`;
                    }
                    else if (sem === 2) {
                        divAlerta.innerHTML = `<div class="alert alert-info alert-dismissible fade show shadow-sm" role="alert"><h5 class="alert-heading"><i class="bi bi-people-fill"></i> ¡Hola, estudiante de Segundo Semestre!</h5><p class="small mb-1">Sabemos que en 2do semestre los horarios funcionan por grupos completos. Por lo que te recomendamos tener en cuenta lo siguiente:</p><ul class="small mb-2"><li><strong>¿Qué son los Grupos Espejo?:</strong> Son dos o más grupos que se imparten exactamente en el mismo horario, pero con diferente profesor. <li><strong>¿Cuáles son los Grupos Espejo?:</strong> El grupo 2001 y 2002. 2003 y 2004. 2005 y 2006. 2007 y 2008. 2010 y 2011.  </li><li><strong>Recomendación:</strong> Usa el <strong>Modo Manual</strong>. Elige un grupo base (ej. 2003) y si un profe no te gusta, cámbialo por el del grupo espejo.</li><li>Si quieres usar el modo exploratorio, usa los filtros, te serán de ayuda para ver otras combinaciones.</li></ul><button type="button" class="btn-close" data-bs-dismiss="alert"></button></div>`;
                    }
                    else if (sem === 4) {
                        divAlerta.innerHTML = `<div class="alert alert-info alert-dismissible fade show shadow-sm" role="alert"><h5 class="alert-heading fw-bold"><i class="bi bi-people-fill"></i> ¡Hola, estudiante de Cuarto Semestre!</h5><p class="small mb-2">Sabemos que en 4to semestre los horarios funcionan por grupos completos. Por lo que te recomendamos tener en cuenta los siguiente:</p><ul class="small mb-0"><li class="mb-1"><strong>Grupos Espejo:</strong> Grupos: 4001 y 4002. 4003 y 4004. 4005 y 4006. 4007 - 4008 y 4009. 4011 y 4012 tienen las mismas horas. Es fácil intercambiar profesores entre ellos.</li><li class="mb-1"><strong>Recomendación:</strong> Usa el <strong>Modo Manual</strong>. Elige un grupo base (ej. 4003) y si un profe no te gusta, cámbialo por el del grupo espejo.</li><li class="mb-2">Si quieres usar el modo exploratorio, usa los filtros, te serán de ayuda para ver otras combinaciones.</li><li class="mt-2 p-2 bg-warning bg-opacity-10 border border-warning rounded text-dark"><strong><i class="bi bi-exclamation-triangle-fill"></i> IMPORTANTE ACA III:</strong> Por cada grupo de <em>APRENDIZAJE Y CONDUCTA ADAPTAT. III</em> le corresponden 2 grupos de (Práctica). Asegúrate de elegir el grupo correspondiente de prácticas acorde a lo que dicen las <strong>observaciones</strong> del grupo de Teoría.</li></ul><button type="button" class="btn-close" data-bs-dismiss="alert"></button></div>`;
                    }

                    filtrarMaterias();
                    filtrarMateriasAuto();
                }

                function activarModo(modo) {
                    cambiarModo(modo);
                    setTimeout(() => {
                        let destino = modo === 'manual' ? 'vista-manual' : 'vista-auto';
                        let elemento = document.getElementById(destino);
                        if (elemento) {
                            const yOffset = -20;
                            const y = elemento.getBoundingClientRect().top + window.pageYOffset + yOffset;
                            window.scrollTo({ top: y, behavior: 'smooth' });
                        }
                    }, 100);
                }

                function cambiarModo(m) {
                    let vistaManual = document.getElementById('vista-manual');
                    let vistaAuto = document.getElementById('vista-auto');
                    if (vistaManual) {
                        vistaManual.style.display = (m === 'manual') ? 'flex' : 'none';
                    }
                    if (vistaAuto) {
                        vistaAuto.style.display = (m === 'auto') ? 'block' : 'none';
                    }
                }

                function filtrarMaterias() {
                    let txt = document.getElementById('buscador').value.toUpperCase();
                    let lista = document.getElementById('lista-materias'); lista.innerHTML = '';
                    let matSem = obtenerMateriasActivas();
                    if (matSem.length === 0) { lista.innerHTML = '<div class="p-3 text-muted small text-center">No hay datos disponibles para esta selección.</div>'; return; }

                    let areas = [...new Set(matSem.map(c => c.area))].sort();

                    let semVal = parseInt(document.getElementById('semestre-selector').value);
                    let teoriaACA = "APRENDIZAJE Y CONDUCTA ADAPTAT. III";
                    let practicaACA = "APRENDIZAJE Y CONDUCTA ADAPTAT. III (PRACTICA)";

                    areas.forEach(area => {
                        let matsEnArea = [...new Set(matSem.filter(c => c.area === area).map(c => c.asignatura))].sort();
                        let matsFiltradas = matsEnArea.filter(m => m.toUpperCase().includes(txt));

                        if (matsFiltradas.length > 0) {
                            let header = document.createElement('div'); header.className = 'area-header'; header.innerText = area; lista.appendChild(header);

                            matsFiltradas.forEach(nom => {
                                let inscrita = miHorario.some(c => c.asignatura === nom);
                                let active = materiaSeleccionadaActual === nom ? 'active-item' : '';

                                let htmlAviso = '';
                                let claseExtra = '';

                                if (semVal === 4) {
                                    if (nom === teoriaACA) {
                                        let tengoPractica = miHorario.some(c => c.asignatura === practicaACA);
                                        if (tengoPractica && !inscrita) {
                                            htmlAviso = '<span class="aviso-requerido">Necesaria inscribir</span>';
                                            claseExtra = 'item-requerido';
                                        }
                                    } else if (nom === practicaACA) {
                                        let tengoTeoria = miHorario.some(c => c.asignatura === teoriaACA);
                                        if (tengoTeoria && !inscrita) {
                                            htmlAviso = '<span class="aviso-requerido">Necesaria inscribir</span>';
                                            claseExtra = 'item-requerido';
                                        }
                                    }
                                }

                                let item = document.createElement('div');
                                item.className = `list-group-item materia-item px-3 py-2 ${inscrita ? 'inscrita-item' : ''} ${active} ${claseExtra}`;

                                item.innerHTML = `
                        <div class="d-flex justify-content-between align-items-center">
                            <span class="${inscrita ? 'fw-bold text-success' : ''}">${nom}</span>
                            ${inscrita ? '<i class="bi bi-check-circle-fill text-success"></i>' : ''}
                        </div>
                        ${htmlAviso}
                    `;

                                item.onclick = () => {
                                    materiaSeleccionadaActual = nom;
                                    filtrarMaterias();
                                    cargarPanelGrupos(nom);
                                };
                                lista.appendChild(item);
                            });
                        }
                    });
                }

                function limpiarPanelGrupos() {
                    document.getElementById('titulo-seleccion').innerHTML = '<i class="bi bi-arrow-left-circle"></i> 2. Selecciona un Profesor';
                    document.getElementById('info-seleccion').innerText = 'Esperando...';
                    document.getElementById('contenedor-grupos').innerHTML = '<div class="text-center text-muted py-5 w-100"><i class="bi bi-hand-index-thumb display-1 opacity-25"></i><p class="mt-3 lead">Selecciona una materia a la izquierda.</p></div>';
                    materiasPendientes = [];
                    renderizarHorarioVisual();
                }

                function cargarPanelGrupos(asignatura) {
                    let semVal = document.getElementById('semestre-selector').value;
                    let sem = parseInt(semVal);
                    document.getElementById('titulo-seleccion').innerHTML = `<i class="bi bi-book"></i> ${asignatura}`;
                    let cursos = obtenerMateriasActivas().filter(c => c.asignatura === asignatura).sort((a, b) => a.grupo.localeCompare(b.grupo));

                    let gA = parseInt(cursos[0]?.grupo), gB = parseInt(cursos[1]?.grupo);
                    if (!isNaN(gA) && !isNaN(gB)) {
                        cursos.sort((a, b) => parseInt(a.grupo) - parseInt(b.grupo));
                    }

                    document.getElementById('info-seleccion').innerText = `${cursos.length} Grupos`;
                    let contenedor = document.getElementById('contenedor-grupos'); contenedor.innerHTML = '';
                    if (cursos.length === 0) { contenedor.innerHTML = '<div class="alert alert-warning text-center w-100">No se encontraron grupos.</div>'; return; }

                    let materiaPadreInscrita = null;
                    let materiaHijoInscrita = null;

                    if (sem === 4) {
                        if (asignatura.includes("APRENDIZAJE Y CONDUCTA ADAPTAT. III (PRACTICA)")) {
                            materiaPadreInscrita = miHorario.find(m => m.asignatura === "APRENDIZAJE Y CONDUCTA ADAPTAT. III");
                        }
                        else if (asignatura === "APRENDIZAJE Y CONDUCTA ADAPTAT. III") {
                            materiaHijoInscrita = miHorario.find(m => m.asignatura.includes("(PRACTICA)"));
                        }
                    }

                    let horarioSinMateriaActual = miHorario.filter(h => h.asignatura !== asignatura);

                    cursos.forEach(c => {
                        let conflictos = obtenerChoques(c, horarioSinMateriaActual);
                        let choca = conflictos.length > 0;
                        let yaInscrita = miHorario.some(h => h.id_unico === c.id_unico);
                        let esPrevisualizada = materiasPendientes.some(p => p.curso.id_unico === c.id_unico);
                        let bloqueadoPorACA = false;

                        if (materiaPadreInscrita && !materiaPadreInscrita.observaciones.includes(c.grupo)) {
                            bloqueadoPorACA = true;
                        }
                        if (materiaHijoInscrita && !c.observaciones.includes(materiaHijoInscrita.grupo)) {
                            bloqueadoPorACA = true;
                        }

                        let horario = c.sesiones.map(s => `<div><span class="fw-bold">${s.dia.substr(0, 3)}</span> ${s.inicio}-${s.fin}</div>`).join('') || "<i>Sin horario</i>";
                        let obsBtn = c.observaciones.length > 5 ? `<button class="btn-ver-obs" onclick="event.stopPropagation(); verObs('obs-${c.id_unico}')">Ver Obs</button>` : '';
                        let obsBox = c.observaciones.length > 5 ? `<div id="obs-${c.id_unico}" class="obs-box">${c.observaciones}</div>` : '';

                        let claseEstado = '';
                        let botonAccion = '';
                        let clickEvent = '';

                        if (yaInscrita) {
                            claseEstado = 'inscrita';
                            botonAccion = '<div class="mt-2 text-center text-success fw-bold small"><i class="bi bi-check-circle-fill"></i> Seleccionado</div>';
                            clickEvent = `toggleSeleccionManual(${c.id_unico}, '${asignatura}')`;
                        }
                        else if (bloqueadoPorACA) {
                            claseEstado = 'choque';
                            botonAccion = '<div class="mt-2 text-center text-danger fw-bold small"><i class="bi bi-slash-circle"></i> Gpo Incorrecto</div>';
                        }
                        else if (esPrevisualizada) {
                            claseEstado = 'previsualizacion';
                            let pendiente = materiasPendientes.find(p => p.curso.id_unico === c.id_unico);
                            let listaNombresConflictos = pendiente.conflictos.map(cf => cf.asignatura).join(', ');

                            botonAccion = `
                    <div class="mt-2 text-center small">
                        <div class="text-danger fw-bold mb-1" style="font-size:0.65rem;">SE ELIMINARÁ: ${listaNombresConflictos}</div>
                        <button class="btn btn-sm btn-danger w-100 fw-bold" onclick="event.stopPropagation(); confirmarTraslape(${c.id_unico})">CONFIRMAR CAMBIO</button>
                        <button class="btn btn-sm btn-link text-muted p-0 mt-1" onclick="event.stopPropagation(); cancelarTraslape(${c.id_unico}, '${asignatura}')">Cancelar</button>
                    </div>`;
                        }
                        else if (choca) {
                            claseEstado = 'choque';
                            botonAccion = '<div class="mt-2 text-center text-danger fw-bold small">TRASLAPE (Click para ver)</div>';
                            clickEvent = `previsualizarTraslape(${c.id_unico}, '${asignatura}')`;
                        }
                        else {
                            botonAccion = '<div class="mt-2 text-center text-primary fw-bold small opacity-0 btn-add">Seleccionar</div>';
                            clickEvent = `toggleSeleccionManual(${c.id_unico}, '${asignatura}')`;
                        }

                        let col = document.createElement('div'); col.className = 'col-auto'; col.style.width = '300px'; col.style.flexShrink = '0';
                        col.innerHTML = `<div class="grupo-card p-3 d-flex flex-column ${claseEstado}" onclick="${clickEvent}"><div class="d-flex justify-content-between mb-2"><span class="badge bg-primary">Gpo ${c.grupo}</span><span class="text-muted small">${c.creditos} Cr</span></div><h6 class="card-title text-primary small text-uppercase fw-bold mb-2" style="min-height:2.5em;">${c.profesor}</h6><div class="small text-muted flex-grow-1 border-top pt-2">${horario}</div> ${obsBtn} ${obsBox} ${botonAccion}</div>`;
                        contenedor.appendChild(col);
                    });
                }

                function verObs(id) { let el = document.getElementById(id); el.style.display = el.style.display === 'block' ? 'none' : 'block'; }

                function previsualizarTraslape(idNuevo, asignatura) {
                    let cursoNuevo = BD_AGRUPADA.find(c => c.id_unico === idNuevo);
                    let horarioActual = miHorario.filter(h => h.asignatura !== asignatura);
                    let conflictos = obtenerChoques(cursoNuevo, horarioActual);

                    if (!materiasPendientes.some(p => p.curso.id_unico === idNuevo)) {
                        materiasPendientes.push({
                            curso: cursoNuevo,
                            conflictos: conflictos
                        });
                    }

                    renderizarHorarioVisual();
                    cargarPanelGrupos(asignatura);
                }

                function confirmarTraslape(idUnicoConfirmar) {
                    registrarEstado();
                    let pendiente = materiasPendientes.find(p => p.curso.id_unico === idUnicoConfirmar);
                    if (!pendiente) return;
                    let nuevo = pendiente.curso;
                    let conflictoIds = pendiente.conflictos.map(c => c.id_unico);
                    miHorario = miHorario.filter(c => !conflictoIds.includes(c.id_unico) && c.asignatura !== nuevo.asignatura);
                    miHorario.push(nuevo);
                    materiasPendientes = materiasPendientes.filter(p => p.curso.id_unico !== idUnicoConfirmar);
                    ordenarMiHorario();
                    guardarEstado();
                    actualizarTablaHorario();
                    renderizarHorarioVisual();
                    filtrarMaterias();
                    cargarPanelGrupos(nuevo.asignatura);
                }

                function cancelarTraslape(idUnicoCancelar, asignatura) {
                    materiasPendientes = materiasPendientes.filter(p => p.curso.id_unico !== idUnicoCancelar);
                    renderizarHorarioVisual();
                    cargarPanelGrupos(asignatura);
                }

                function toggleSeleccionManual(id, asignatura) {
                    registrarEstado();
                    if (materiasPendientes.some(p => p.curso.id_unico === id)) {
                        materiasPendientes = materiasPendientes.filter(p => p.curso.id_unico !== id);
                    }
                    let yaEsta = miHorario.some(c => c.id_unico === id);
                    if (yaEsta) {
                        miHorario = miHorario.filter(c => c.id_unico !== id);
                    } else {
                        miHorario = miHorario.filter(c => c.asignatura !== asignatura);
                        let curso = BD_AGRUPADA.find(c => c.id_unico === id);
                        miHorario.push(curso);
                    }
                    ordenarMiHorario();
                    guardarEstado();
                    actualizarTablaHorario();
                    renderizarHorarioVisual();
                    filtrarMaterias();
                    cargarPanelGrupos(asignatura);
                }

                function ordenarMiHorario(criterioInput = null) {
                    let criterio = criterioInput;
                    if (!criterio) {
                        let el = document.getElementById('sort-manual');
                        if (el) criterio = el.value;
                    }
                    if (!criterio) return;

                    // Actualizar UI del selector si existe (para sincronizar)
                    let elSelect = document.getElementById('sort-manual');
                    if (elSelect && criterioInput) elSelect.value = criterioInput;

                    // Actualizar texto del botón si existe
                    let btnLabel = document.getElementById('btn-sort-label');
                    if (btnLabel) {
                        const labels = {
                            'materia': 'Materia',
                            'profesor': 'Profesor',
                            'grupo': 'Grupo',
                            'horas': 'Duración',
                            'cronologico': 'Cronológico'
                        };
                        btnLabel.innerText = labels[criterio] || 'Ordenar';
                    }
                    const mapaDias = { 'LUNES': 0, 'MARTES': 1, 'MIERCOLES': 2, 'JUEVES': 3, 'VIERNES': 4, 'SABADO': 5 };
                    miHorario.sort((a, b) => {
                        switch (criterio) {
                            case 'materia': return a.asignatura.localeCompare(b.asignatura);
                            case 'profesor': return a.profesor.localeCompare(b.profesor);
                            case 'grupo':
                                let gA = parseInt(a.grupo); let gB = parseInt(b.grupo);
                                if (!isNaN(gA) && !isNaN(gB)) return gA - gB;
                                return a.grupo.localeCompare(b.grupo);
                            case 'horas':
                                let durA = a.sesiones.reduce((sum, s) => sum + (s.min_fin - s.min_inicio), 0);
                                let durB = b.sesiones.reduce((sum, s) => sum + (s.min_fin - s.min_inicio), 0);
                                return durB - durA;
                            case 'cronologico':
                                let getEarliest = (curso) => {
                                    if (curso.sesiones.length === 0) return 999999;
                                    return Math.min(...curso.sesiones.map(s => {
                                        let diaIdx = mapaDias[s.dia] !== undefined ? mapaDias[s.dia] : 9;
                                        return (diaIdx * 10000) + s.min_inicio;
                                    }));
                                };
                                return getEarliest(a) - getEarliest(b);
                            default: return 0;
                        }
                    });
                    guardarEstado();
                    actualizarTablaHorario();
                    renderizarHorarioVisual();
                }

                function actualizarTablaHorario() {
                    let tbody = document.getElementById('tabla-mi-horario');
                    if (!tbody) return;
                    tbody.innerHTML = '';
                    let total = 0;
                    document.getElementById('btn-limpiar-manual').style.display = miHorario.length ? 'inline-block' : 'none';
                    if (!miHorario.length) {
                        tbody.innerHTML = '<tr><td colspan="12" class="text-center text-muted py-4">No has agregado materias aún.</td></tr>';
                    } else {
                        miHorario.forEach((c, idx) => {
                            total += c.creditos;
                            tbody.innerHTML += generarFilaSIAE(c, idx);
                        });
                    }

                    // --- LOGICA AJUSTADA DE CREDITOS ---
                    let semVal = parseInt(document.getElementById('semestre-selector').value);
                    let badge = document.getElementById('creditos-badge');
                    badge.innerText = `${total} Créditos`;
                    badge.className = 'badge me-3';

                    let minIdeal = 37;
                    let maxIdeal = 41;

                    if (semVal === 2) { minIdeal = 40; maxIdeal = 40; }
                    if (semVal === 4) { minIdeal = 44; maxIdeal = 44; }

                    if (total === 0) {
                        badge.classList.add('bg-secondary');
                    } else if (total < minIdeal) {
                        badge.classList.add('bg-warning', 'text-dark');
                        badge.innerText += " (Faltan)";
                    } else if (total > maxIdeal) {
                        badge.classList.add('bg-danger');
                        badge.innerText += " (Exceso)";
                    } else {
                        badge.classList.add('bg-success');
                        badge.innerText += " (¡Perfecto!)";
                    }

                    if (document.getElementById('switch-vista').checked) renderizarHorarioVisual();
                }

                function generarFilaSIAE(c, idx = null, showDelete = true) {
                    let d = { LUNES: '', MARTES: '', MIERCOLES: '', JUEVES: '', VIERNES: '', SABADO: '' };
                    c.sesiones.forEach(s => { let k = s.dia.toUpperCase().replace('É', 'E'); if (d.hasOwnProperty(k)) d[k] = `${s.inicio}-${s.fin}`; });
                    let btn = showDelete ? `<button onclick="borrar(${idx})" class="btn btn-sm text-danger p-0"><i class="bi bi-x-circle-fill"></i></button>` : '';
                    let obsCell = '';
                    if (c.observaciones && c.observaciones.length > 5) {
                        let rndId = 'obs-auto-' + Math.random().toString(36).substr(2, 6);
                        obsCell = `<button class="btn-ver-obs" onclick="verObs('${rndId}')">Ver Obs</button><div id="${rndId}" class="obs-box text-start mt-1" style="display:none; min-width: 150px;">${c.observaciones}</div>`;
                    }
                    return `<tr><td class="text-start small fw-bold text-primary text-truncate" style="max-width:150px;" title="${c.asignatura}">${c.asignatura}</td><td>${c.grupo}</td><td class="text-start small text-uppercase text-truncate" style="max-width:150px;" title="${c.profesor}">${c.profesor}</td><td>${d.LUNES}</td><td>${d.MARTES}</td><td>${d.MIERCOLES}</td><td>${d.JUEVES}</td><td>${d.VIERNES}</td><td>${d.SABADO}</td><td>${c.creditos}</td><td>${obsCell}</td><td>${btn}</td></tr>`;
                }

                function borrar(idx) {
                    registrarEstado();
                    let borrada = miHorario[idx];
                    miHorario.splice(idx, 1);
                    guardarEstado();
                    actualizarTablaHorario();
                    filtrarMaterias();
                    if (materiaSeleccionadaActual === borrada.asignatura) cargarPanelGrupos(borrada.asignatura);
                }
                function limpiarTodoManual() {
                    if (confirm("¿Borrar todo?")) {
                        registrarEstado();
                        miHorario = [];
                        materiasPendientes = [];
                        guardarEstado();
                        limpiarPanelGrupos();
                        filtrarMaterias();
                        actualizarTablaHorario();
                    }
                }

                // --- NUEVAS FUNCIONES DE DESCARGA (CORRIGEN MÓVIL/VERTICAL) ---
                async function descargarPDF() {
                    const { jsPDF } = window.jspdf;

                    // 1. Clonar contenido a un contenedor oculto con ancho fijo
                    let isVisual = document.getElementById('switch-vista').checked;
                    let sourceId = isVisual ? 'vista-visual-container' : 'vista-lista-container';
                    let source = document.getElementById(sourceId);

                    let container = document.getElementById('capture-container');
                    container.innerHTML = ''; // Limpiar

                    let wrapper = document.createElement('div');
                    wrapper.style.width = '1300px'; // Forzar ancho escritorio
                    wrapper.style.padding = '20px';
                    wrapper.style.backgroundColor = '#ffffff';

                    let clone = source.cloneNode(true);
                    clone.style.display = 'block';
                    clone.style.overflow = 'visible';
                    clone.style.height = 'auto';
                    clone.style.maxHeight = 'none';

                    wrapper.appendChild(clone);
                    container.appendChild(wrapper);

                    // 2. Capturar desde el contenedor oculto
                    const canvas = await html2canvas(wrapper, { scale: 2, useCORS: true, scrollY: 0 });
                    const imgData = canvas.toDataURL('image/png');

                    const pdf = new jsPDF('l', 'mm', 'a4');
                    const pdfWidth = pdf.internal.pageSize.getWidth();
                    const pdfHeight = pdf.internal.pageSize.getHeight();
                    const imgProps = pdf.getImageProperties(imgData);
                    const ratio = imgProps.width / imgProps.height;

                    let w = pdfWidth - 20;
                    let h = w / ratio;
                    if (h > pdfHeight - 20) { h = pdfHeight - 20; w = h * ratio; }

                    let x = (pdfWidth - w) / 2;
                    let y = (pdfHeight - h) / 2;

                    pdf.addImage(imgData, 'PNG', x, y, w, h);
                    pdf.save('Horario_FacPsi_UNAM.pdf');

                    container.innerHTML = ''; // Limpiar
                }

                async function descargarImagen() {
                    // 1. Clonar contenido a un contenedor oculto con ancho fijo
                    let isVisual = document.getElementById('switch-vista').checked;
                    let sourceId = isVisual ? 'vista-visual-container' : 'vista-lista-container';
                    let source = document.getElementById(sourceId);

                    let container = document.getElementById('capture-container');
                    container.innerHTML = '';

                    let wrapper = document.createElement('div');
                    wrapper.style.width = '1300px'; // Forzar ancho escritorio
                    wrapper.style.padding = '20px';
                    wrapper.style.backgroundColor = '#ffffff';

                    let clone = source.cloneNode(true);
                    clone.style.display = 'block';
                    clone.style.overflow = 'visible';
                    clone.style.height = 'auto';
                    clone.style.maxHeight = 'none';

                    wrapper.appendChild(clone);
                    container.appendChild(wrapper);

                    // 2. Capturar
                    const canvas = await html2canvas(wrapper, { scale: 2, useCORS: true, scrollY: 0 });
                    const link = document.createElement('a');
                    link.download = 'Horario_FacPsi_UNAM.png';
                    link.href = canvas.toDataURL('image/png');
                    link.click();

                    container.innerHTML = '';
                }

                function descargarCSV() {
                    if (miHorario.length === 0) return alert("No hay horario para exportar.");
                    let csvContent = "data:text/csv;charset=utf-8,";
                    csvContent += "Materia,Grupo,Profesor,Lunes,Martes,Miercoles,Jueves,Viernes,Sabado,Creditos,Observaciones\n";
                    miHorario.forEach(c => {
                        let d = { LUNES: '', MARTES: '', MIERCOLES: '', JUEVES: '', VIERNES: '', SABADO: '' };
                        c.sesiones.forEach(s => { let k = s.dia.toUpperCase().replace('É', 'E'); if (d.hasOwnProperty(k)) d[k] = `${s.inicio}-${s.fin}`; });
                        let asig = c.asignatura.replace(/,/g, '');
                        let prof = c.profesor.replace(/,/g, '');
                        let obs = (c.observaciones || "").replace(/,/g, ' ').replace(/\n/g, ' ');
                        let row = `${asig},${c.grupo},${prof},${d.LUNES},${d.MARTES},${d.MIERCOLES},${d.JUEVES},${d.VIERNES},${d.SABADO},${c.creditos},${obs}`;
                        csvContent += row + "\n";
                    });
                    const encodedUri = encodeURI(csvContent);
                    const link = document.createElement("a");
                    link.setAttribute("href", encodedUri);
                    link.setAttribute("download", "Horario_FacPsi_UNAM.csv");
                    document.body.appendChild(link);
                    link.click();
                    document.body.removeChild(link);
                }

                function descargarExcel() {
                    if (miHorario.length === 0) return alert("No hay horario para exportar.");

                    const headers = ["Hora", "Lunes", "Martes", "Miércoles", "Jueves", "Viernes", "Sábado"];
                    const diasKeys = ["LUNES", "MARTES", "MIERCOLES", "JUEVES", "VIERNES", "SABADO"];

                    let ws_data = [headers];
                    let startMin = 7 * 60;
                    let endMin = 21 * 60;
                    let step = 30;

                    let rowMap = {};
                    let rowIndex = 1;

                    for (let m = startMin; m < endMin; m += step) {
                        let horaLabel = minutosAHora(m) + " - " + minutosAHora(m + 30);
                        let row = [horaLabel, "", "", "", "", "", ""];
                        ws_data.push(row);
                        rowMap[m] = rowIndex;
                        rowIndex++;
                    }

                    let merges = [];

                    miHorario.forEach(curso => {
                        let textoCelda = `${curso.asignatura}\n(${curso.profesor})\nGpo: ${curso.grupo}`;
                        curso.sesiones.forEach(sesion => {
                            let diaNormal = sesion.dia.toUpperCase().replace("É", "E");
                            let colIndex = diasKeys.indexOf(diaNormal) + 1;
                            if (colIndex > 0) {
                                let startM = sesion.min_inicio;
                                let endM = sesion.min_fin;
                                if (startM < startMin) startM = startMin;
                                let rStart = rowMap[startM];
                                if (rStart !== undefined) {
                                    let durationMins = endM - startM;
                                    let rowSpan = Math.ceil(durationMins / 30);
                                    ws_data[rStart][colIndex] = textoCelda;
                                    if (rowSpan > 1) {
                                        merges.push({
                                            s: { r: rStart, c: colIndex },
                                            e: { r: rStart + rowSpan - 1, c: colIndex }
                                        });
                                    }
                                }
                            }
                        });
                    });

                    var wb = XLSX.utils.book_new();
                    var ws = XLSX.utils.aoa_to_sheet(ws_data);
                    if (merges.length > 0) ws['!merges'] = merges;
                    var wscols = [{ wch: 15 }, { wch: 25 }, { wch: 25 }, { wch: 25 }, { wch: 25 }, { wch: 25 }, { wch: 25 }];
                    ws['!cols'] = wscols;
                    XLSX.utils.book_append_sheet(wb, ws, "Horario Visual");
                    XLSX.writeFile(wb, "Horario_FacPsi_UNAM.xlsx");
                }

                function filtrarMateriasAuto() {
                    let txt = document.getElementById('buscador-auto').value.toUpperCase();
                    let lista = document.getElementById('lista-materias-auto'); lista.innerHTML = '';
                    let matSem = obtenerMateriasActivas();
                    if (matSem.length === 0) { lista.innerHTML = '<div class="p-3 text-muted small text-center">No hay datos.</div>'; return; }
                    let areas = [...new Set(matSem.map(c => c.area))].sort();

                    areas.forEach(area => {
                        let matsEnArea = [...new Set(matSem.filter(c => c.area === area).map(c => c.asignatura))].sort();
                        let matsFiltradas = matsEnArea.filter(m => m.toUpperCase().includes(txt));

                        if (matsFiltradas.length > 0) {
                            let header = document.createElement('div'); header.className = 'area-header'; header.innerText = area; lista.appendChild(header);
                            matsFiltradas.forEach(nom => {
                                let enBolsa = bolsa[nom] && bolsa[nom].length > 0;
                                let active = materiaSeleccionadaAuto === nom ? 'active-item' : '';
                                let item = document.createElement('div');
                                item.className = `list-group-item materia-item px-3 py-2 ${enBolsa ? 'candidata-item' : ''} ${active}`;
                                item.innerHTML = `<div class="d-flex justify-content-between align-items-center"><span class="${enBolsa ? 'fw-bold text-dark' : ''}">${nom}</span>${enBolsa ? '<i class="bi bi-star-fill text-warning"></i>' : ''}</div>`;
                                item.onclick = () => {
                                    materiaSeleccionadaAuto = nom;
                                    filtrarMateriasAuto();
                                    cargarPanelGruposAuto(nom);
                                };
                                lista.appendChild(item);
                            });
                        }
                    });
                }

                function limpiarPanelGruposAuto() {
                    document.getElementById('titulo-seleccion-auto').innerHTML = '<i class="bi bi-arrow-left-circle"></i> 2. Selecciona tus Profesores';
                    document.getElementById('info-seleccion-auto').innerText = 'Esperando...';
                    document.getElementById('contenedor-grupos-auto').innerHTML = '<div class="text-center text-muted py-5 w-100"><i class="bi bi-hand-index-thumb display-1 opacity-25"></i><p class="mt-3 lead">Selecciona una materia a la izquierda.</p></div>';
                }

                function cargarPanelGruposAuto(asignatura) {
                    document.getElementById('titulo-seleccion-auto').innerHTML = `<i class="bi bi-book"></i> ${asignatura}`;
                    let cursos = obtenerMateriasActivas().filter(c => c.asignatura === asignatura).sort((a, b) => a.grupo.localeCompare(b.grupo));
                    document.getElementById('info-seleccion-auto').innerText = `${cursos.length} Grupos`;

                    let contenedor = document.getElementById('contenedor-grupos-auto'); contenedor.innerHTML = '';
                    if (cursos.length === 0) { contenedor.innerHTML = '<div class="alert alert-warning text-center w-100">No se encontraron grupos.</div>'; return; }

                    let idsEnBolsa = [];
                    if (bolsa[asignatura]) {
                        idsEnBolsa = bolsa[asignatura].map(c => c.id_unico);
                    }

                    cursos.forEach(c => {
                        let seleccionado = idsEnBolsa.includes(c.id_unico);
                        let horario = c.sesiones.map(s => `<div><span class="fw-bold">${s.dia.substr(0, 3)}</span> ${s.inicio}-${s.fin}</div>`).join('') || "<i>Sin horario</i>";
                        let obsBtn = c.observaciones.length > 5 ? `<button class="btn-ver-obs" onclick="event.stopPropagation(); verObs('obs-auto-${c.id_unico}')">Ver Obs</button>` : '';
                        let obsBox = c.observaciones.length > 5 ? `<div id="obs-auto-${c.id_unico}" class="obs-box">${c.observaciones}</div>` : '';

                        let claseEstado = seleccionado ? 'candidato-seleccionado' : '';
                        let textoEstado = seleccionado ? '<div class="mt-2 text-center text-dark fw-bold small"><i class="bi bi-check-circle-fill text-warning"></i> Seleccionado</div>' : '<div class="mt-2 text-center text-primary fw-bold small opacity-0 btn-add">Agregar</div>';

                        let col = document.createElement('div'); col.className = 'col-auto'; col.style.width = '280px'; col.style.flexShrink = '0';
                        col.innerHTML = `
                <div class="grupo-card p-3 d-flex flex-column ${claseEstado}" onclick="toggleCandidato(${c.id_unico}, '${asignatura}')">
                    <div class="d-flex justify-content-between mb-2">
                        <span class="badge bg-secondary">Gpo ${c.grupo}</span>
                        <span class="text-muted small">${c.creditos} Cr</span>
                    </div>
                    <h6 class="card-title text-primary small text-uppercase fw-bold mb-2" style="min-height:2.5em;">${c.profesor}</h6>
                    <div class="small text-muted flex-grow-1 border-top pt-2">${horario}</div> 
                    ${obsBtn} ${obsBox} ${textoEstado}
                </div>`;
                        contenedor.appendChild(col);
                    });
                }

                function toggleCandidato(id, asignatura) {
                    if (!bolsa[asignatura]) bolsa[asignatura] = [];
                    let index = bolsa[asignatura].findIndex(c => c.id_unico === id);
                    if (index > -1) {
                        bolsa[asignatura].splice(index, 1);
                        if (bolsa[asignatura].length === 0) delete bolsa[asignatura];
                    } else {
                        let curso = BD_AGRUPADA.find(c => c.id_unico === id);
                        bolsa[asignatura].push(curso);
                    }
                    guardarEstado();
                    renderBolsa();
                    filtrarMateriasAuto();
                    cargarPanelGruposAuto(asignatura);
                }

                function renderBolsa() {
                    let ul = document.getElementById('lista-bolsa'); ul.innerHTML = '';
                    let keys = Object.keys(bolsa);
                    if (keys.length === 0) { ul.innerHTML = '<li class="list-group-item text-muted text-center py-3">Vacío</li>'; return; }
                    keys.forEach(k => {
                        let li = document.createElement('li'); li.className = 'list-group-item d-flex justify-content-between align-items-center py-1';
                        li.innerHTML = `<div><span class="fw-bold d-block text-truncate small" style="max-width:140px;" title="${k}">${k}</span></div><div><span class="badge bg-secondary rounded-pill me-2">${bolsa[k].length}</span><i class="bi bi-x-circle text-danger cursor-pointer" onclick="delBolsa('${k}')"></i></div>`;
                        ul.appendChild(li);
                    });
                }

                function delBolsa(k) { delete bolsa[k]; guardarEstado(); renderBolsa(); filtrarMateriasAuto(); limpiarPanelGruposAuto(); }
                function limpiarBolsa() { if (confirm("¿Limpiar todo?")) { bolsa = {}; guardarEstado(); renderBolsa(); filtrarMateriasAuto(); limpiarPanelGruposAuto(); } }

                function esCombinacionValida(comb) {
                    let teoria = comb.find(c => c.asignatura === "APRENDIZAJE Y CONDUCTA ADAPTAT. III");
                    let practica = comb.find(c => c.asignatura === "APRENDIZAJE Y CONDUCTA ADAPTAT. III (PRACTICA)");
                    if (teoria && practica) { if (!teoria.observaciones.includes(practica.grupo)) return false; }
                    return true;
                }

                async function generarCombinaciones() {
                    let resDiv = document.getElementById('resultados-auto');

                    resDiv.innerHTML = `
            <div class="text-center py-5">
                <div class="spinner-border text-primary mb-2" role="status"></div>
                <h6 class="fw-bold text-primary">Analizando combinaciones...</h6>
                <p class="small text-muted" id="progress-text">Iniciando motor...</p>
                <div class="progress w-50 mx-auto" style="height: 5px;">
                    <div id="progress-bar-inner" class="progress-bar" role="progressbar" style="width: 0%"></div>
                </div>
                <button class="btn btn-sm btn-outline-danger mt-3" onclick="window.detenerGeneracion = true">Cancelar</button>
            </div>`;

                    window.detenerGeneracion = false;
                    await new Promise(r => setTimeout(r, 100));

                    try {
                        let nombresMaterias = Object.keys(bolsa);
                        let listas = Object.values(bolsa);

                        if (!listas.length) { throw new Error("Agrega materias primero."); }

                        for (let i = 0; i < nombresMaterias.length; i++) {
                            if (!listas[i] || listas[i].length === 0) throw new Error(`La materia "${nombresMaterias[i]}" está en tu lista pero no tiene grupos seleccionados.`);
                        }

                        let totalPosibilidades = listas.reduce((acc, lista) => acc * lista.length, 1);

                        if (totalPosibilidades > 2000000) {
                            if (!confirm(`Se han detectado ${totalPosibilidades.toLocaleString()} combinaciones posibles. Esto podría tardar. ¿Continuar?`)) {
                                resDiv.innerHTML = '<div class="text-center py-4 text-muted">Cancelado por el usuario.</div>';
                                return;
                            }
                        }

                        RESULTADOS_GLOBALES = [];
                        let indices = new Array(listas.length).fill(0);
                        let combinacionesProcesadas = 0;
                        let combinacionesValidas = 0;
                        let startTimestamp = Date.now();

                        while (true) {
                            if (window.detenerGeneracion) {
                                resDiv.innerHTML = '<div class="alert alert-warning text-center">Cálculo detenido.</div>';
                                return;
                            }

                            let comb = [];
                            for (let i = 0; i < listas.length; i++) {
                                comb.push(listas[i][indices[i]]);
                            }

                            if (!hayChoqueCombo(comb) && esCombinacionValida(comb)) {
                                let creds = comb.reduce((a, b) => a + b.creditos, 0);
                                let diasSet = new Set(comb.flatMap(c => c.sesiones.map(s => s.dia)));
                                let huecos = calcularHuecos(comb);

                                RESULTADOS_GLOBALES.push({
                                    cursos: [...comb],
                                    creditos: creds,
                                    dias: diasSet.size,
                                    huecos: huecos
                                });
                                combinacionesValidas++;
                            }

                            combinacionesProcesadas++;

                            if (combinacionesProcesadas % 500 === 0) {
                                let now = Date.now();
                                if (now - startTimestamp > 100) {
                                    let porcentaje = Math.min(100, Math.round((combinacionesProcesadas / totalPosibilidades) * 100));
                                    let elTexto = document.getElementById('progress-text');
                                    let elBarra = document.getElementById('progress-bar-inner');

                                    if (elTexto) elTexto.innerText = `Analizando... (${combinacionesValidas} válidas)`;
                                    if (elBarra) elBarra.style.width = `${porcentaje}%`;

                                    await new Promise(r => setTimeout(r, 0));
                                    startTimestamp = now;
                                }
                            }

                            if (combinacionesValidas >= 5000) break;

                            let nextIndex = listas.length - 1;
                            while (nextIndex >= 0) {
                                indices[nextIndex]++;
                                if (indices[nextIndex] < listas[nextIndex].length) {
                                    break;
                                } else {
                                    indices[nextIndex] = 0;
                                    nextIndex--;
                                }
                            }
                            if (nextIndex < 0) break;
                        }

                        if (RESULTADOS_GLOBALES.length > 0) {
                            renderizarFiltroProfesores();
                            actualizarFiltrosUI();
                            document.getElementById('panel-filtros-resultados').style.display = 'block';
                            aplicarOrdenYFiltro();
                        } else {
                            ejecutarDetectiveDeConflictos(nombresMaterias, resDiv);
                        }
                    } catch (error) {
                        console.error(error);
                        resDiv.innerHTML = `<div class="alert alert-danger text-center"><i class="bi bi-exclamation-triangle-fill"></i> ${error.message}</div>`;
                    }
                }

                function ejecutarDetectiveDeConflictos(nombresMaterias, contenedor) {
                    document.getElementById('panel-filtros-resultados').style.display = 'none';
                    let resDiv = document.getElementById('resultados-auto');

                    resDiv.innerHTML = `
                        <div class="card border-0 shadow-sm mx-auto mt-4" style="max-width: 600px;">
                            <div class="card-body text-center p-5">
                                <div class="mb-4">
                                    <i class="bi bi-puzzle display-1 text-muted opacity-50"></i>
                                </div>
                                <h4 class="fw-bold text-dark mb-3">No existen horarios posibles</h4>
                                <p class="text-muted mb-4">
                                    El sistema ha explorado todas las opciones pero no encontró combinaciones válidas. 
                                    Esto suele ocurrir cuando hay <strong>traslapes inevitables</strong> entre materias obligatorias 
                                    o cuando se exceden los límites de tiempo.
                                </p>
                                <div class="alert alert-light border small text-muted mb-4">
                                    <i class="bi bi-info-circle me-2"></i> No es un error del estudiante ni una falla del sistema. Es un rompecabezas complejo que requiere ajustes.
                                </div>
                                <button class="btn btn-primary rounded-pill px-4 py-2 shadow-sm" onclick="iniciarAnalisisProfundo()">
                                    <i class="bi bi-search me-2"></i> Identificar materia en conflicto
                                </button>
                            </div>
                        </div>
                    `;
                }

                async function iniciarAnalisisProfundo() {
                    let resDiv = document.getElementById('resultados-auto');
                    resDiv.innerHTML = `
                        <div class="text-center py-5">
                            <div class="spinner-border text-primary mb-3" role="status"></div>
                            <h5 class="fw-bold">Analizando conflictos...</h5>
                            <p class="text-muted small">Simulando escenarios alternativos...</p>
                        </div>
                    `;

                    await new Promise(r => setTimeout(r, 800)); // UX delay

                    let reportes = [];
                    let nombres = Object.keys(bolsa);

                    for (let materiaIgnorada of nombres) {
                        // Crear bolsa temporal sin esta materia
                        let listasTemp = [];
                        for (let m of nombres) {
                            if (m !== materiaIgnorada) {
                                listasTemp.push(bolsa[m]);
                            }
                        }

                        let sim = simularGeneracion(listasTemp);
                        if (sim.validas > 0) {
                            reportes.push({
                                ignorada: materiaIgnorada,
                                validas: sim.validas,
                                creditos: sim.avgCreditos,
                                maxCreditos: sim.maxCreditos
                            });
                        }
                    }

                    // Ordenar por quién desbloquea más opciones
                    reportes.sort((a, b) => b.validas - a.validas);

                    // Renderizar Reporte
                    let html = `<div class="container py-4" style="max-width:800px;">
                        <div class="d-flex align-items-center mb-4">
                            <button class="btn btn-sm btn-outline-secondary me-3" onclick="generarCombinaciones()"><i class="bi bi-arrow-clockwise"></i> Reintentar</button>
                            <h4 class="fw-bold mb-0">Reporte de Conflictos</h4>
                        </div>`;

                    if (reportes.length === 0) {
                        html += `<div class="alert alert-warning text-center shadow-sm">
                            <h5 class="fw-bold"><i class="bi bi-exclamation-triangle"></i> Conflicto Complejo</h5>
                            <p>Incluso quitando una materia a la vez, no se encontraron soluciones válidas.</p>
                            <p class="small text-muted mb-0">Esto indica que hay múltiples choques simultáneos. Prueba reduciendo tu carga académica eliminando 2 o más materias manualmente.</p>
                        </div>`;
                    } else {
                        html += `<p class="alert alert-info border-0 shadow-sm mb-4"><i class="bi bi-lightbulb-fill me-2"></i>Se detectó que las siguientes materias están bloqueando tu horario. Te sugerimos empezar evaluando la primera opción.</p>`;

                        reportes.forEach((rep, idx) => {
                            let isBest = idx === 0;
                            let badgeCreditos = rep.maxCreditos > 41 ?
                                `<span class="badge bg-warning text-dark border border-warning ms-2"><i class="bi bi-exclamation-circle"></i> Excede Créditos (${rep.maxCreditos})</span>` :
                                (rep.maxCreditos < 30 ? `<span class="badge bg-light text-muted border ms-2">Baja Carga (${rep.maxCreditos} Cr)</span>` : '');

                            html += `
                            <div class="card mb-3 ${isBest ? 'border-primary shadow-sm' : 'border-light shadow-sm'}">
                                <div class="card-body d-flex justify-content-between align-items-center flex-wrap">
                                    <div>
                                        ${isBest ? '<div class="text-uppercase text-primary fw-bold mb-1" style="font-size:0.7rem; letter-spacing:1px;">Mejor Solución</div>' : ''}
                                        <h5 class="fw-bold mb-1">Si eliminas: <span class="text-danger">${rep.ignorada}</span></h5>
                                        <p class="mb-0 text-muted small">Se desbloquean <strong>${rep.validas}${rep.validas >= 100 ? '+' : ''} combinaciones</strong> posibles.</p>
                                    </div>
                                    <div class="text-end mt-2 mt-sm-0">
                                        ${badgeCreditos}
                                    </div>
                                </div>
                            </div>`;
                        });
                    }
                    html += `</div>`;
                    resDiv.innerHTML = html;
                }

                function simularGeneracion(listas) {
                    let indices = new Array(listas.length).fill(0);
                    let validas = 0;
                    let sumaCreditos = 0;
                    let maxCreditos = 0;
                    let count = 0;

                    while (true) {
                        let comb = [];
                        for (let i = 0; i < listas.length; i++) comb.push(listas[i][indices[i]]);

                        if (!hayChoqueCombo(comb) && esCombinacionValida(comb)) {
                            validas++;
                            let c = comb.reduce((a, b) => a + b.creditos, 0);
                            sumaCreditos += c;
                            if (c > maxCreditos) maxCreditos = c;
                        }

                        count++;
                        if (validas >= 100 || count >= 2000) break; // Limite para velocidad

                        let next = listas.length - 1;
                        while (next >= 0) {
                            indices[next]++;
                            if (indices[next] < listas[next].length) break;
                            indices[next] = 0;
                            next--;
                        }
                        if (next < 0) break;
                    }

                    return {
                        validas,
                        avgCreditos: validas ? Math.round(sumaCreditos / validas) : 0,
                        maxCreditos
                    };
                }


                function renderizarFiltroProfesores() {
                    let container = document.getElementById('lista-profes-filtro-resultados');
                    if (!container) return;
                    container.innerHTML = '';

                    let todosLosProfes = new Set();
                    RESULTADOS_GLOBALES.forEach(r => {
                        r.cursos.forEach(c => todosLosProfes.add(c.profesor));
                    });

                    let listaOrdenada = Array.from(todosLosProfes).sort();

                    if (listaOrdenada.length === 0) {
                        container.innerHTML = '<div class="text-muted small text-center p-2">No hay profesores para filtrar.</div>';
                        return;
                    }

                    listaOrdenada.forEach(profe => {
                        let div = document.createElement('div'); div.className = 'form-check mb-1';
                        // Generar ID seguro
                        let safeId = 'chk-prof-' + profe.replace(/[^a-zA-Z0-9]/g, '');
                        let safeVal = profe.replace(/"/g, '&quot;');
                        div.innerHTML = `<input class="form-check-input chk-filtro-profe" type="checkbox" value="${safeVal}" id="${safeId}" onchange="aplicarOrdenYFiltro()">
                                         <label class="form-check-label small text-truncate d-block" for="${safeId}" title="${profe}">${profe}</label>`;
                        container.appendChild(div);
                    });
                }

                function filtrarListaProfesResultados(input) {
                    let txt = input.value.toUpperCase();
                    document.querySelectorAll('.chk-filtro-profe').forEach(chk => {
                        let label = chk.nextElementSibling.innerText.toUpperCase();
                        chk.parentElement.style.display = label.includes(txt) ? 'block' : 'none';
                    });
                }

                function toggleAllProfesResultados(state) {
                    document.querySelectorAll('.chk-filtro-profe').forEach(chk => {
                        if (chk.parentElement.style.display !== 'none') chk.checked = state;
                    });
                    aplicarOrdenYFiltro();
                }

                function calcularHuecos(comb) {
                    let agenda = {}; comb.forEach(c => c.sesiones.forEach(s => { if (!agenda[s.dia]) agenda[s.dia] = []; agenda[s.dia].push([s.min_inicio, s.min_fin]); }));
                    let huecos = 0;
                    for (let dia in agenda) {
                        let bloq = agenda[dia].sort((a, b) => a[0] - b[0]);
                        for (let i = 0; i < bloq.length - 1; i++) { let diff = bloq[i + 1][0] - bloq[i][1]; if (diff > 0) huecos += diff; }
                    }
                    return Math.round(huecos / 60);
                }

                function aplicarOrdenYFiltro() {
                    let crit = document.getElementById('sort-resultados').value;
                    let tFiltro = document.getElementById('filtro-turno').value;
                    let diasLibres = Array.from(document.querySelectorAll('.chk-filtro-dia:checked')).map(c => c.value);
                    let textoBotonDia = document.getElementById('btn-filtro-dia');
                    textoBotonDia.innerText = diasLibres.length > 0 ? `${diasLibres.length} seleccionados` : "Ninguno";
                    let profesSeleccionados = Array.from(document.querySelectorAll('.chk-filtro-profe:checked')).map(c => c.value);
                    let textoBotonProfe = document.getElementById('btn-filtro-profe');
                    textoBotonProfe.innerText = profesSeleccionados.length > 0 ? (profesSeleccionados.length === 1 ? profesSeleccionados[0] : `${profesSeleccionados.length} seleccionados`) : "Todos";

                    let filtrados = RESULTADOS_GLOBALES.filter(r => {
                        if (profesSeleccionados.length > 0) {
                            // LOGICA STRICT AND: El horario debe tener TODOS los profesores seleccionados
                            let cumpleTodos = profesSeleccionados.every(profeSel =>
                                r.cursos.some(c => c.profesor === profeSel)
                            );
                            if (!cumpleTodos) return false;
                        }
                        if (diasLibres.length > 0) {
                            let ocupaDiaLibre = r.cursos.some(c => c.sesiones.some(s => diasLibres.includes(s.dia)));
                            if (ocupaDiaLibre) return false;
                        }
                        if (tFiltro) {
                            let incios = r.cursos.flatMap(c => c.sesiones.map(s => s.inicio));
                            if (tFiltro === 'matutino' && incios.some(h => parseInt(h) >= 14)) return false;
                            if (tFiltro === 'vespertino' && incios.some(h => parseInt(h) < 13)) return false;
                        }
                        return true;
                    });

                    if (crit === 'dias') filtrados.sort((a, b) => a.dias - b.dias);
                    else if (crit === 'creditos') filtrados.sort((a, b) => b.creditos - a.creditos);
                    else if (crit === 'huecos') filtrados.sort((a, b) => a.huecos - b.huecos);

                    dibujarResultados(filtrados);
                }

                function dibujarResultados(lista) {
                    RESULTADOS_MOSTRADOS = lista;
                    OFFSET_MOSTRADOS = 0;
                    let resDiv = document.getElementById('resultados-auto');
                    resDiv.innerHTML = '';
                    document.getElementById('conteo-resultados').innerText = `${lista.length} opciones`;

                    if (!lista.length) { resDiv.innerHTML = '<div class="alert alert-danger small text-center">No hay combinaciones con esos filtros.</div>'; return; }

                    renderizarBatchResultados();
                }

                function renderizarBatchResultados() {
                    let resDiv = document.getElementById('resultados-auto');
                    let btnLoad = document.getElementById('btn-cargar-mas');
                    if (btnLoad) btnLoad.remove();

                    let end = Math.min(OFFSET_MOSTRADOS + BATCH_SIZE, RESULTADOS_MOSTRADOS.length);
                    let batch = RESULTADOS_MOSTRADOS.slice(OFFSET_MOSTRADOS, end);

                    batch.forEach((val, k) => {
                        let i = OFFSET_MOSTRADOS + k;
                        let idAcc = `acc-${i}`;
                        let rows = val.cursos.map(c => generarFilaSIAE(c, null, false)).join('');
                        let item = document.createElement('div'); item.className = 'accordion-item border shadow-sm mb-2';
                        item.innerHTML = `
                <h2 class="accordion-header d-flex align-items-center">
                    <button class="accordion-button collapsed py-2 flex-grow-1" type="button" data-bs-toggle="collapse" data-bs-target="#${idAcc}">
                        <div class="d-flex w-100 justify-content-between align-items-center me-3">
                            <div>
                                <span class="badge bg-primary">Opción ${i + 1}</span>
                                <small class="text-muted fw-bold ms-2">${val.dias} Días | ${val.creditos} Cr | ${val.huecos}h Libres</small>
                            </div>
                        </div>
                    </button>
                    <select id="sort-auto-${i}" class="form-select form-select-sm border-primary me-3 d-none d-md-inline-block" style="width: auto; font-size: 0.75rem;" onclick="event.stopPropagation()" onchange="ordenarTablaAuto(${i}, this.value)">
                        <option value="materia" selected>Ordenar: Materia</option>
                        <option value="profesor">Ordenar: Profesor (A-Z)</option>
                        <option value="grupo">Ordenar: Grupo</option>
                        <option value="horas">Ordenar: Duración</option>
                        <option value="cronologico">Ordenar: Cronológico</option>
                    </select>
                    
                    <button class="btn btn-sm btn-outline-success me-2" onclick="transferirAManual(${i})" title="Usar este horario en Modo Manual">
                        <i class="bi bi-pencil-square"></i> Transferir
                    </button>
                    
                    <button class="btn btn-sm btn-outline-secondary me-2" id="btn-recolor-auto-${i}" style="display:none;" onclick="recolorearAuto(); event.stopPropagation();" title="Cambiar paleta de colores">
                        <i class="bi bi-palette"></i>
                    </button>

                    <div class="form-check form-switch ms-2 me-1" onclick="event.stopPropagation()" style="transform: scale(0.85); transform-origin: right center;">
                        <input class="form-check-input" type="checkbox" id="switch-auto-${i}" onchange="toggleVistaAuto(${i})">
                        <label class="form-check-label fw-bold text-muted" for="switch-auto-${i}" style="font-size: 0.8rem;">Gráfico</label>
                    </div>
                </h2>
                <div id="${idAcc}" class="accordion-collapse collapse">
                    <div class="accordion-body p-0">
                        <div id="res-tabla-${i}" class="table-responsive">
                            <table class="table table-bordered table-sm mb-0 tabla-siae"><thead class="table-light"><tr><th>Mat</th><th>Gpo</th><th>Prof</th><th class="col-dia">L</th><th class="col-dia">M</th><th class="col-dia">M</th><th class="col-dia">J</th><th class="col-dia">V</th><th class="col-dia">S</th><th>Cr</th><th>Obs</th></tr></thead><tbody id="tbody-auto-${i}">${rows}</tbody></table>
                        </div>
                        <div id="res-visual-${i}" class="p-3 bg-white" style="display:none; overflow-x:auto;"></div>
                    </div>
                </div>`;
                        resDiv.appendChild(item);
                    });

                    OFFSET_MOSTRADOS = end;

                    if (OFFSET_MOSTRADOS < RESULTADOS_MOSTRADOS.length) {
                        let divBtn = document.createElement('div');
                        divBtn.id = 'btn-cargar-mas';
                        divBtn.className = 'text-center py-4';
                        divBtn.innerHTML = `<button class="btn btn-outline-primary rounded-pill px-4 shadow-sm" onclick="renderizarBatchResultados()">
                                                <i class="bi bi-plus-circle me-2"></i>Cargar más resultados (${RESULTADOS_MOSTRADOS.length - OFFSET_MOSTRADOS} restantes)
                                            </button>`;
                        resDiv.appendChild(divBtn);
                    }
                }

                function transferirAManual(idx) {
                    if (miHorario.length > 0) {
                        let confirmacion = confirm("ADVERTENCIA: Al transferir esta opción, se borrará todo lo que tienes seleccionado actualmente en el 'Generador Manual'.\n\n¿Deseas continuar y sobrescribir tu horario manual?");
                        if (!confirmacion) return;
                    }

                    registrarEstado();

                    miHorario = JSON.parse(JSON.stringify(RESULTADOS_MOSTRADOS[idx].cursos));
                    materiasPendientes = [];
                    guardarEstado();
                    actualizarTablaHorario();
                    renderizarHorarioVisual();
                    materiaSeleccionadaActual = null;
                    limpiarPanelGrupos();
                    filtrarMaterias();
                    cambiarModo('manual');
                    alert("¡Horario transferido con éxito! Ahora puedes editarlo manualmente.");
                }

                function ordenarTablaAuto(idx, criterio) {
                    if (!RESULTADOS_MOSTRADOS[idx]) return;
                    let cursos = [...RESULTADOS_MOSTRADOS[idx].cursos];
                    const mapaDias = { 'LUNES': 0, 'MARTES': 1, 'MIERCOLES': 2, 'JUEVES': 3, 'VIERNES': 4, 'SABADO': 5 };

                    cursos.sort((a, b) => {
                        switch (criterio) {
                            case 'materia': return a.asignatura.localeCompare(b.asignatura);
                            case 'profesor': return a.profesor.localeCompare(b.profesor);
                            case 'grupo':
                                let gA = parseInt(a.grupo); let gB = parseInt(b.grupo);
                                if (!isNaN(gA) && !isNaN(gB)) return gA - gB;
                                return a.grupo.localeCompare(b.grupo);
                            case 'horas':
                                let durA = a.sesiones.reduce((sum, s) => sum + (s.min_fin - s.min_inicio), 0);
                                let durB = b.sesiones.reduce((sum, s) => sum + (s.min_fin - s.min_inicio), 0);
                                return durB - durA;
                            case 'cronologico':
                                let getEarliest = (curso) => {
                                    if (curso.sesiones.length === 0) return 999999;
                                    return Math.min(...curso.sesiones.map(s => {
                                        let diaIdx = mapaDias[s.dia] !== undefined ? mapaDias[s.dia] : 9;
                                        return (diaIdx * 10000) + s.min_inicio;
                                    }));
                                };
                                return getEarliest(a) - getEarliest(b);
                            default: return 0;
                        }
                    });

                    let rows = cursos.map(c => generarFilaSIAE(c, null, false)).join('');
                    document.getElementById(`tbody-auto-${idx}`).innerHTML = rows;
                }

                function toggleVistaAuto(idx) {
                    let isChecked = document.getElementById(`switch-auto-${idx}`).checked;
                    let tabla = document.getElementById(`res-tabla-${idx}`);
                    let visual = document.getElementById(`res-visual-${idx}`);
                    let selectorSort = document.getElementById(`sort-auto-${idx}`);
                    let recolorBtn = document.getElementById(`btn-recolor-auto-${idx}`);

                    if (selectorSort) {
                        selectorSort.style.display = isChecked ? 'none' : 'inline-block';
                    }
                    if (recolorBtn) {
                        recolorBtn.style.display = isChecked ? 'inline-block' : 'none';
                    }

                    tabla.style.display = isChecked ? 'none' : 'block';
                    visual.style.display = isChecked ? 'block' : 'none';

                    if (isChecked) {
                        visual.innerHTML = generarHTMLGridVisual(`auto-${idx}`);
                        renderizarBloquesEnGrid(RESULTADOS_MOSTRADOS[idx].cursos, `auto-${idx}`);
                    }
                }

                function generarHTMLGridVisual(suffix) {
                    let html = '<table class="table mb-0 tabla-visual w-100"><thead><tr><th style="width:50px;">Hora</th><th>Lunes</th><th>Martes</th><th>Miércoles</th><th>Jueves</th><th>Viernes</th><th>Sábado</th></tr></thead><tbody>';
                    let startMin = 7 * 60; let endMin = 21 * 60;
                    for (let m = startMin; m < endMin; m += 30) {
                        let horaStr = minutosAHora(m);
                        html += `<tr><td class="hora-col">${horaStr}</td>`;
                        ['LUNES', 'MARTES', 'MIERCOLES', 'JUEVES', 'VIERNES', 'SABADO'].forEach(dia => {
                            html += `<td id="grid-${suffix}-${dia}-${m}"></td>`;
                        });
                        html += '</tr>';
                    }
                    html += '</tbody></table>';
                    return html;
                }

                function renderizarBloquesEnGrid(cursos, suffix) {
                    let cursosOrdenados = [...cursos].sort((a, b) => a.asignatura.localeCompare(b.asignatura));

                    cursosOrdenados.forEach((curso, i) => {
                        let totalColores = PALETA_ORDENADA.length;
                        let indexColor = (i + OFFSET_RECOLOR_AUTO) % totalColores;
                        let color = PALETA_ORDENADA[indexColor];

                        let horasStr = curso.sesiones.map(s => `${s.dia.substr(0, 3)} ${s.inicio}-${s.fin}`).join('\n');

                        curso.sesiones.forEach(sesion => {
                            let diaNorm = sesion.dia.toUpperCase().replace('É', 'E');
                            let inicio = sesion.min_inicio;
                            let fin = sesion.min_fin;
                            let duration = fin - inicio;
                            let cellInicio = document.getElementById(`grid-${suffix}-${diaNorm}-${inicio}`);

                            if (cellInicio) {
                                let bloque = document.createElement('div');
                                bloque.className = `bloque-materia bloque-auto-${suffix}-${curso.id_unico}`;
                                bloque.style.backgroundColor = color;
                                bloque.style.cursor = 'default';

                                if (!configVisual.prof) bloque.classList.add('hide-prof');
                                if (!configVisual.grupo) bloque.classList.add('hide-group');
                                if (!configVisual.horas) bloque.classList.add('hide-time');

                                let slots = duration / 30;
                                let heightPx = (slots * 31) - 1;
                                bloque.style.height = `${heightPx}px`;

                                let htmlContent = `<div class="materia-nombre">${curso.asignatura}</div>`;
                                htmlContent += `<div class="materia-grupo">Gpo: ${curso.grupo}</div>`;
                                htmlContent += `<div class="materia-profe">${curso.profesor}</div>`;
                                htmlContent += `<div class="materia-horas">${horasStr}</div>`;

                                bloque.innerHTML = htmlContent;

                                bloque.onmouseenter = () => {
                                    document.querySelectorAll(`.bloque-auto-${suffix}-${curso.id_unico}`).forEach(b => b.classList.add('bloque-resaltado'));
                                };
                                bloque.onmouseleave = () => {
                                    document.querySelectorAll(`.bloque-auto-${suffix}-${curso.id_unico}`).forEach(b => b.classList.remove('bloque-resaltado'));
                                };

                                cellInicio.appendChild(bloque);
                            }
                        });
                    });
                }

                window.entrarAlWorkspace = function () {
                    let selectorInicio = document.getElementById('landing-selector');
                    let valor = selectorInicio.value;

                    if (!valor) {
                        alert("Por favor, selecciona un semestre para continuar.");
                        return;
                    }

                    let selectorReal = document.getElementById('semestre-selector');
                    if (selectorReal) {
                        selectorReal.value = valor;
                        if (typeof cambiarSemestre === 'function') {
                            cambiarSemestre(true);
                        }
                    }

                    let landing = document.getElementById('step-1-landing');
                    let appWrapper = document.getElementById('app-container-wrapper');

                    landing.classList.add('slide-up-exit');

                    appWrapper.classList.add('app-loaded');

                    document.body.classList.add('mode-workspace');

                    setTimeout(() => {
                        landing.style.display = 'none';
                    }, 600);
                };
                function actualizarFiltrosUI() {
                    if (document.getElementById('sort-resultados'))
                        document.getElementById('sort-resultados').value = 'dias';

                    if (document.getElementById('filtro-turno'))
                        document.getElementById('filtro-turno').value = '';

                    document.querySelectorAll('.chk-filtro-dia').forEach(c => c.checked = false);
                    let btnDia = document.getElementById('btn-filtro-dia');
                    if (btnDia) btnDia.innerText = 'Ninguno';

                    document.querySelectorAll('.chk-filtro-profe').forEach(c => c.checked = false);
                    let btnProf = document.getElementById('btn-filtro-profe');
                    if (btnProf) btnProf.innerText = 'Todos';
                }
            </script>
            <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
            <script>
                // Particle Animation for Landing Page
                (function () {
                    const canvas = document.getElementById('ocean-dust');
                    if (!canvas) return;
                    const ctx = canvas.getContext('2d');
                    let width, height, particles = [];

                    function init() {
                        width = canvas.width = window.innerWidth;
                        height = canvas.height = window.innerHeight;
                        createParticles();
                    }

                    function createParticles() {
                        particles = [];
                        // Density calculation: 1 particle per 10000 pixels
                        const count = Math.floor((width * height) / 10000);
                        for (let i = 0; i < count; i++) {
                            particles.push({
                                x: Math.random() * width,
                                y: Math.random() * height,
                                size: Math.random() * 2 + 0.5, // Random size between 0.5 and 2.5
                                speed: Math.random() * 0.4 + 0.1, // Slow vertical drift
                                opacity: Math.random() * 0.5 + 0.2 // Random transparency
                            });
                        }
                    }

                    function animate() {
                        ctx.clearRect(0, 0, width, height);
                        particles.forEach(p => {
                            p.y -= p.speed; // Move upwards
                            // Reset if off screen
                            if (p.y < -5) p.y = height + 5;

                            ctx.beginPath();
                            ctx.arc(p.x, p.y, p.size, 0, Math.PI * 2);
                            // Custom White Color
                            ctx.fillStyle = 'rgba(255, 255, 255, ' + p.opacity + ')';
                            ctx.fill();
                        });
                        requestAnimationFrame(animate);
                    }

                    // Handle window resize
                    window.addEventListener('resize', () => {
                        init();
                    });

                    // Start
                    init();
                    animate();
                })();
            </script>
</body>

</html>
