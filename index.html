<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Generador Horarios UNAM - 6to Semestre</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.0/font/bootstrap-icons.css">
    <style>
        body { background-color: #f4f6f9; font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; min-height: 100vh; display: flex; flex-direction: column; }
        .header-main { background-color: #002B7A; color: white; padding: 2rem 0; border-bottom: 6px solid #D59F0F; }
        .text-gold { color: #D59F0F; }
        .card-header { background-color: #f8f9fa; border-bottom: 2px solid #e9ecef; font-weight: 600; color: #002B7A; }
        .btn-unam { background-color: #002B7A; color: white; font-weight: 500; }
        .btn-unam:hover { background-color: #001e57; color: white; }
        .choque { background-color: #ffe6e6; color: #dc3545; cursor: not-allowed; }
        .footer-warning { background-color: #fff3cd; color: #856404; padding: 15px; text-align: center; border-top: 1px solid #ffeeba; margin-top: auto; }
        .nav-pills .nav-link.active { background-color: #D59F0F; color: #002B7A; font-weight: bold; }
        .nav-pills .nav-link { color: #002B7A; }
    </style>
</head>
<body>

<div class="header-main text-center mb-4">
    <div class="container">
        <h1 class="display-6 fw-bold">Generador de Horarios FacPsi</h1>
        <p class="lead mb-1">Psicología UNAM - <span class="text-gold fw-bold">6to Semestre (2025-2)</span></p>
        <p class="small opacity-75 mx-auto" style="max-width: 600px;">
            Optimiza tu proceso de inscripción. Esta herramienta te permite visualizar empalmes, calcular créditos automáticamente y encontrar la combinación perfecta de profesores antes de entrar al sistema oficial.
        </p>
    </div>
</div>

<div class="container pb-4" id="app">

    <div class="accordion mb-4 shadow-sm" id="accordionGuia">
        <div class="accordion-item">
            <h2 class="accordion-header">
                <button class="accordion-button collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#collapseGuia">
                    <i class="bi bi-info-circle me-2"></i> Guía de Uso y Preguntas Frecuentes
                </button>
            </h2>
            <div id="collapseGuia" class="accordion-collapse collapse" data-bs-parent="#accordionGuia">
                <div class="accordion-body bg-light">
                    <div class="row">
                        <div class="col-md-6 border-end">
                            <h6 class="text-primary fw-bold">Caso A: "Ya sé qué profesores quiero"</h6>
                            <p class="small">Usa el <strong>Generador Manual</strong>.</p>
                            <ol class="small">
                                <li>Busca la materia en la izquierda.</li>
                                <li>Selecciona el grupo específico.</li>
                                <li>El sistema bloqueará en rojo si intentas meter otro grupo que choque en horario.</li>
                            </ol>
                        </div>
                        <div class="col-md-6">
                            <h6 class="text-primary fw-bold">Caso B: "Tengo varias opciones y quiero ver qué queda"</h6>
                            <p class="small">Usa el <strong>Explorador Automático</strong>.</p>
                            <ol class="small">
                                <li>Ve a la pestaña Explorador.</li>
                                <li>Elige una materia y marca 3 o 4 profesores que te interesen (Candidatos).</li>
                                <li>Repite con todas las materias.</li>
                                <li>Dale a "Generar" y el sistema calculará matemáticamente los horarios que NO chocan.</li>
                            </ol>
                        </div>
                    </div>
                    <hr>
                    <p class="small mb-0 text-muted"><strong>Nota:</strong> Tus selecciones se guardan automáticamente en este navegador por si cierras la página por error.</p>
                </div>
            </div>
        </div>
    </div>

    <ul class="nav nav-pills mb-4 justify-content-center" id="pills-tab">
        <li class="nav-item">
            <button class="nav-link active px-4" id="tab-manual" onclick="cambiarModo('manual')">
                <i class="bi bi-pencil-square"></i> Generador Manual
            </button>
        </li>
        <li class="nav-item">
            <button class="nav-link px-4" id="tab-auto" onclick="cambiarModo('auto')">
                <i class="bi bi-cpu"></i> Explorador (Automático)
            </button>
        </li>
    </ul>

    <div id="vista-manual" class="row">
        <div class="col-md-5">
            <div class="card shadow-sm h-100">
                <div class="card-header"><i class="bi bi-search"></i> 1. Buscar Materia</div>
                <div class="card-body">
                    <input type="text" id="buscador" class="form-control mb-3" placeholder="Escribe nombre de materia..." onkeyup="filtrarMaterias()">
                    <div id="lista-materias" class="list-group" style="max-height: 300px; overflow-y: auto;"></div>
                </div>
            </div>

            <div class="card shadow mt-3 border-primary" id="panel-grupos" style="display:none;">
                <div class="card-header bg-primary text-white d-flex justify-content-between align-items-center">
                    <span>2. Elegir Grupo</span>
                    <button type="button" class="btn-close btn-close-white" onclick="cerrarPanelGrupos()"></button>
                </div>
                <div class="card-body p-0">
                    <div id="lista-grupos" class="list-group list-group-flush" style="max-height: 300px; overflow-y: auto;"></div>
                </div>
            </div>
        </div>

        <div class="col-md-7">
            <div class="card shadow h-100">
                <div class="card-header d-flex justify-content-between align-items-center">
                    <span><i class="bi bi-calendar-check"></i> Tu Horario Preliminar</span>
                    <span id="creditos-badge" class="badge bg-secondary">0 Créditos</span>
                </div>
                <div class="card-body">
                    <div id="mi-horario">
                        <div class="text-center text-muted mt-5">
                            <i class="bi bi-backpack display-1 opacity-25"></i>
                            <p class="mt-2">No has seleccionado materias.</p>
                        </div>
                    </div>
                    
                    <div class="alert alert-danger mt-3 d-flex align-items-center" id="alerta-etica" style="display:block;">
                        <i class="bi bi-exclamation-triangle-fill me-2"></i>
                        <div>
                            <strong>Requisito Faltante:</strong> ETICA PROFESIONAL
                            <div class="small">Es obligatorio inscribir esta materia en 6to semestre.</div>
                        </div>
                    </div>
                    
                    <div class="mt-3 text-end" id="btn-limpiar-manual" style="display:none;">
                        <button class="btn btn-outline-danger btn-sm" onclick="limpiarTodoManual()">Borrar Todo</button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <div id="vista-auto" class="row" style="display:none;">
        <div class="col-md-4">
            <div class="card shadow-sm mb-3">
                <div class="card-header"><i class="bi bi-funnel"></i> 1. Configurar Selecciones</div>
                <div class="card-body">
                    <label class="form-label fw-bold">Materia:</label>
                    <select id="select-materia-auto" class="form-select mb-2" onchange="cargarProfesAuto()">
                        <option value="">-- Selecciona --</option>
                    </select>
                    
                    <div id="area-profes-auto" class="border rounded p-2 mb-3 bg-light" style="max-height: 250px; overflow-y: auto; display:none;">
                        </div>

                    <button class="btn btn-outline-primary w-100 mb-3" onclick="agregarABolsa()">Agregar a mis Selecciones</button>
                </div>
            </div>

            <div class="card shadow-sm">
                 <div class="card-header d-flex justify-content-between align-items-center">
                    <span><i class="bi bi-list-check"></i> Tus Selecciones</span>
                    <button class="btn btn-sm text-danger" onclick="limpiarBolsa()" title="Borrar todo"><i class="bi bi-trash"></i></button>
                </div>
                <ul id="lista-bolsa" class="list-group list-group-flush">
                    <li class="list-group-item text-muted small text-center py-3">Aún no agregas materias.</li>
                </ul>
                <div class="card-body">
                    <button class="btn btn-unam w-100 py-2" onclick="generarCombinaciones()">
                        <i class="bi bi-lightning-charge-fill"></i> GENERAR HORARIOS
                    </button>
                </div>
            </div>
        </div>

        <div class="col-md-8">
            <div class="card shadow h-100">
                <div class="card-header">Resultados Generados</div>
                <div class="card-body bg-light" id="resultados-auto" style="overflow-y: auto; max-height: 600px;">
                    <div class="text-center text-muted mt-5">
                        <i class="bi bi-arrow-left-circle display-4 opacity-25"></i>
                        <p class="mt-3">Configura tus candidatos y presiona Generar.</p>
                    </div>
                </div>
            </div>
        </div>
    </div>

</div>

<div class="footer-warning small">
    <strong>⚠️ INFORMACIÓN IMPORTANTE:</strong><br>
    Esta herramienta es un simulador académico desarrollado por alumnos para alumnos.<br>
    Los resultados mostrados son sugerencias basadas en los horarios publicados. 
    La inscripción oficial <strong>debe realizarse únicamente</strong> a través del sistema de la DGAE/SIAE en las fechas establecidas.
</div>

<script>
    let BD = [];
    let miHorario = [];
    let bolsa = {}; 
    const OBLIGATORIA = "ETICA PROFESIONAL";
    const DB_URL = 'horarios.json'; // <--- Si falla, pon aquí el link RAW de GitHub

    // CARGAR DATOS E INICIALIZAR
    fetch(DB_URL)
        .then(response => {
            if(!response.ok) throw new Error("No se encontró el archivo JSON.");
            return response.json();
        })
        .then(data => {
            BD = data;
            // 4. RECUPERAR DATOS GUARDADOS (Persistencia)
            cargarEstado();
            
            llenarBuscadorManual();
            llenarSelectAuto();
        })
        .catch(err => console.error(err));

    // --- SISTEMA DE PERSISTENCIA (Punto 4) ---
    function guardarEstado() {
        localStorage.setItem('unam_horario', JSON.stringify(miHorario));
        localStorage.setItem('unam_bolsa', JSON.stringify(bolsa));
    }

    function cargarEstado() {
        const savedHorario = localStorage.getItem('unam_horario');
        const savedBolsa = localStorage.getItem('unam_bolsa');

        if (savedHorario) {
            miHorario = JSON.parse(savedHorario);
            actualizarVistaHorario();
        }
        if (savedBolsa) {
            bolsa = JSON.parse(savedBolsa);
            renderBolsa();
        }
    }

    // --- MODO MANUAL ---
    function filtrarMaterias() {
        const texto = document.getElementById('buscador').value.toUpperCase();
        const lista = document.getElementById('lista-materias');
        lista.innerHTML = '';
        const nombres = [...new Set(BD.map(c => c.asignatura))].sort();

        nombres.forEach(nombre => {
            if (nombre.includes(texto)) {
                if (miHorario.some(c => c.asignatura === nombre)) return; // Ya inscrita

                const item = document.createElement('button');
                item.className = 'list-group-item list-group-item-action d-flex justify-content-between align-items-center';
                item.innerHTML = `<span>${nombre}</span>`;
                if(nombre === OBLIGATORIA) item.innerHTML += ' <span class="badge bg-warning text-dark">Obligatoria</span>';
                
                item.onclick = () => mostrarGrupos(nombre);
                lista.appendChild(item);
            }
        });
    }

    function mostrarGrupos(asignatura) {
        document.getElementById('panel-grupos').style.display = 'block';
        const lista = document.getElementById('lista-grupos');
        lista.innerHTML = '';
        const cursos = BD.filter(c => c.asignatura === asignatura).sort((a,b) => a.grupo - b.grupo);

        cursos.forEach(curso => {
            const choca = hayChoque(curso, miHorario);
            const btn = document.createElement('button');
            btn.className = `list-group-item list-group-item-action ${choca ? 'choque' : ''}`;
            
            let horarioTexto = curso.sesiones.map(s => `<strong>${s.dia.substr(0,3)}</strong> ${s.inicio}`).join(', ');
            
            btn.innerHTML = `
                <div class="d-flex w-100 justify-content-between">
                    <span class="fw-bold">Gpo ${curso.grupo}</span>
                    <small class="badge bg-light text-dark border">${curso.creditos} cr</small>
                </div>
                <div class="mb-1 text-primary small">${curso.profesor}</div>
                <small class="text-muted">${horarioTexto}</small>
                ${choca ? '<div class="text-danger small fw-bold">⛔ Empalme de horario</div>' : ''}
            `;

            if (!choca) btn.onclick = () => inscribir(curso);
            lista.appendChild(btn);
        });
    }

    function cerrarPanelGrupos() {
        document.getElementById('panel-grupos').style.display = 'none';
    }

    function inscribir(curso) {
        miHorario.push(curso);
        guardarEstado(); // <--- GUARDAR
        actualizarVistaHorario();
        filtrarMaterias();
        cerrarPanelGrupos();
        document.getElementById('buscador').value = '';
    }

    function borrarMateria(index) {
        miHorario.splice(index, 1);
        guardarEstado(); // <--- GUARDAR
        actualizarVistaHorario();
        filtrarMaterias();
    }
    
    function limpiarTodoManual() {
        if(confirm("¿Borrar todo tu horario manual?")) {
            miHorario = [];
            guardarEstado();
            actualizarVistaHorario();
            filtrarMaterias();
        }
    }

    function actualizarVistaHorario() {
        const contenedor = document.getElementById('mi-horario');
        contenedor.innerHTML = '';
        let totalCreditos = 0;
        let tieneEtica = false;

        document.getElementById('btn-limpiar-manual').style.display = miHorario.length > 0 ? 'block' : 'none';

        if (miHorario.length === 0) {
            contenedor.innerHTML = '<div class="text-center text-muted mt-5"><i class="bi bi-backpack display-1 opacity-25"></i><p class="mt-2">Mochila vacía.</p></div>';
        } else {
            miHorario.forEach((curso, idx) => {
                totalCreditos += curso.creditos;
                if(curso.asignatura === OBLIGATORIA) tieneEtica = true;

                const card = document.createElement('div');
                card.className = 'card mb-2 border-start border-4 border-primary shadow-sm';
                let horarioTxt = curso.sesiones.map(s => `${s.dia.substr(0,3)} ${s.inicio}-${s.fin}`).join(' | ');
                
                card.innerHTML = `
                    <div class="card-body p-2 d-flex justify-content-between align-items-center">
                        <div style="overflow: hidden;">
                            <h6 class="mb-0 fw-bold text-truncate">${curso.asignatura}</h6>
                            <small class="text-muted">${curso.profesor} (Gpo ${curso.grupo})</small><br>
                            <small class="text-primary fw-bold" style="font-size: 0.85em;">${horarioTxt}</small>
                        </div>
                        <button class="btn btn-sm text-danger fs-5" onclick="borrarMateria(${idx})" title="Quitar materia">&times;</button>
                    </div>
                `;
                contenedor.appendChild(card);
            });
        }

        const badge = document.getElementById('creditos-badge');
        badge.innerText = `${totalCreditos} / 41 Créditos`;
        badge.className = `badge ${totalCreditos > 41 ? 'bg-danger' : (totalCreditos >= 37 ? 'bg-success' : 'bg-warning text-dark')}`;
        document.getElementById('alerta-etica').style.display = tieneEtica ? 'none' : 'flex';
    }

    // --- MODO AUTOMATICO ---

    function llenarSelectAuto() {
        const sel = document.getElementById('select-materia-auto');
        sel.innerHTML = '<option value="">-- Selecciona --</option>'; // Reset
        const nombres = [...new Set(BD.map(c => c.asignatura))].sort();
        nombres.forEach(n => {
            const opt = document.createElement('option');
            opt.value = n;
            opt.innerText = n;
            sel.appendChild(opt);
        });
    }

    function cargarProfesAuto() {
        const nombre = document.getElementById('select-materia-auto').value;
        const div = document.getElementById('area-profes-auto');
        div.innerHTML = '';
        if(!nombre) { div.style.display='none'; return; }
        
        div.style.display='block';
        const cursos = BD.filter(c => c.asignatura === nombre).sort((a,b) => a.grupo - b.grupo);

        cursos.forEach(c => {
            const divRow = document.createElement('div');
            divRow.className = 'form-check border-bottom py-2';
            let hor = c.sesiones.map(s => `${s.dia.substr(0,3)} ${s.inicio}`).join(' ');
            
            divRow.innerHTML = `
                <input class="form-check-input check-profe" type="checkbox" value="${c.id}" id="chk_${c.id}">
                <label class="form-check-label w-100" for="chk_${c.id}" style="cursor:pointer; font-size: 0.9em;">
                    <span class="fw-bold">${c.profesor}</span> <span class="text-muted">(Gpo ${c.grupo})</span><br>
                    <span class="text-primary small">${hor}</span>
                </label>
            `;
            div.appendChild(divRow);
        });
    }

    function agregarABolsa() {
        const nombre = document.getElementById('select-materia-auto').value;
        if(!nombre) return;
        const checks = document.querySelectorAll('.check-profe:checked');
        if(checks.length === 0) { alert("Selecciona al menos un profesor."); return; }

        const ids = Array.from(checks).map(c => parseInt(c.value));
        bolsa[nombre] = BD.filter(c => ids.includes(c.id));

        guardarEstado(); // <--- GUARDAR
        renderBolsa();
        
        document.getElementById('select-materia-auto').value = "";
        document.getElementById('area-profes-auto').style.display='none';
    }

    function renderBolsa() {
        const ul = document.getElementById('lista-bolsa');
        ul.innerHTML = '';
        const keys = Object.keys(bolsa);
        
        if(keys.length === 0) {
            ul.innerHTML = '<li class="list-group-item text-muted small text-center py-3">Aún no agregas materias.</li>';
            return;
        }

        keys.forEach(mat => {
            const li = document.createElement('li');
            li.className = 'list-group-item d-flex justify-content-between align-items-center py-2';
            li.innerHTML = `
                <div style="line-height: 1.2;">
                    <small class="fw-bold d-block text-truncate" style="max-width: 150px;">${mat}</small>
                    <span class="badge bg-secondary rounded-pill" style="font-size: 0.7em;">${bolsa[mat].length} Opciones</span>
                </div>
                <button class="btn btn-sm text-danger" onclick="borrarDeBolsa('${mat}')"><i class="bi bi-trash"></i></button>
            `;
            ul.appendChild(li);
        });
    }

    function borrarDeBolsa(mat) {
        delete bolsa[mat];
        guardarEstado(); // <--- GUARDAR
        renderBolsa();
    }
    
    function limpiarBolsa() {
        if(confirm("¿Borrar todas tus selecciones?")) {
            bolsa = {};
            guardarEstado();
            renderBolsa();
        }
    }

    async function generarCombinaciones() {
        const resDiv = document.getElementById('resultados-auto');
        resDiv.innerHTML = '<div class="text-center py-5"><div class="spinner-border text-primary"></div><p class="mt-2 text-muted">Analizando combinaciones...</p></div>';
        
        await new Promise(r => setTimeout(r, 100));

        const materias = Object.keys(bolsa);
        if(materias.length === 0) { resDiv.innerHTML = '<div class="alert alert-warning text-center">Tus selecciones están vacías.</div>'; return; }

        const listas = Object.values(bolsa);
        const cartesian = (...a) => a.reduce((a, b) => a.flatMap(d => b.map(e => [d, e].flat())));
        let combinaciones = cartesian(...listas);
        if (materias.length === 1) combinaciones = combinaciones.map(c => [c]);

        const validos = [];
        
        for (let comb of combinaciones) {
            if (!horarioEsValido(comb)) continue;
            
            let huecos = 0;
            let creditos = 0;
            let diasSet = new Set();
            let agenda = {};

            comb.forEach(curso => {
                creditos += curso.creditos;
                curso.sesiones.forEach(s => {
                    diasSet.add(s.dia);
                    if(!agenda[s.dia]) agenda[s.dia] = [];
                    agenda[s.dia].push([s.min_inicio, s.min_fin]);
                });
            });

            for (let dia in agenda) {
                let lapsos = agenda[dia].sort((a,b) => a[0] - b[0]);
                for(let k=0; k<lapsos.length-1; k++) {
                    let dif = lapsos[k+1][0] - lapsos[k][1];
                    if(dif > 0) huecos += dif;
                }
            }
            validos.push({ cursos: comb, creditos, huecos, dias: diasSet.size });
            if (validos.length >= 100) break; 
        }

        validos.sort((a,b) => a.dias - b.dias || a.huecos - b.huecos);

        resDiv.innerHTML = '';
        if(validos.length === 0) {
            resDiv.innerHTML = '<div class="alert alert-danger text-center"><i class="bi bi-emoji-frown"></i> Todas las combinaciones tienen choque de horario.</div>';
            return;
        }

        resDiv.innerHTML = `<div class="alert alert-success py-2 text-center shadow-sm"><strong>${validos.length}</strong> horarios posibles encontrados.</div>`;

        validos.slice(0, 20).forEach((val, i) => {
            const div = document.createElement('div');
            div.className = 'card mb-3 shadow-sm border-0';
            
            let contenidoCursos = val.cursos.map(c => `
                <tr>
                    <td class="fw-bold text-primary" style="font-size: 0.9em;">${c.asignatura}</td>
                    <td style="font-size: 0.85em;">${c.profesor}</td>
                    <td class="text-center" style="font-size: 0.85em;">${c.grupo}</td>
                    <td class="text-end text-muted" style="font-size: 0.8em;">${c.sesiones.map(s=>s.dia.substr(0,3) + ' ' + s.inicio).join('<br>')}</td>
                </tr>
            `).join('');

            div.innerHTML = `
                <div class="card-header bg-white d-flex justify-content-between align-items-center">
                    <span class="badge bg-primary rounded-pill">Opción ${i+1}</span>
                    <div>
                        <span class="badge bg-light text-dark border me-1">${val.dias} Días</span>
                        <span class="badge ${val.creditos > 41 ? 'bg-danger' : (val.creditos >= 37 ? 'bg-success' : 'bg-warning text-dark')}">${val.creditos} Cr</span>
                    </div>
                </div>
                <div class="card-body p-0">
                    <div class="table-responsive">
                        <table class="table table-sm table-striped mb-0 align-middle">
                            <thead class="table-light small"><tr><th>Materia</th><th>Profesor</th><th>Gpo</th><th class="text-end">Horario</th></tr></thead>
                            <tbody>${contenidoCursos}</tbody>
                        </table>
                    </div>
                </div>
            `;
            resDiv.appendChild(div);
        });
    }

    // --- UTILIDADES ---
    function cambiarModo(modo) {
        document.getElementById('tab-manual').className = `nav-link ${modo==='manual'?'active':''}`;
        document.getElementById('tab-auto').className = `nav-link ${modo==='auto'?'active':''}`;
        document.getElementById('vista-manual').style.display = modo==='manual'?'flex':'none';
        document.getElementById('vista-auto').style.display = modo==='auto'?'flex':'none';
    }

    function llenarBuscadorManual() { filtrarMaterias(); }

    function hayChoque(cursoNuevo, listaAgendada) {
        for (let inscrito of listaAgendada) {
            for (let s1 of cursoNuevo.sesiones) {
                for (let s2 of inscrito.sesiones) {
                    if (s1.dia === s2.dia) {
                        if ((s1.min_inicio < s2.min_fin) && (s2.min_inicio < s1.min_fin)) return true;
                    }
                }
            }
        }
        return false;
    }

    function horarioEsValido(listaCursos) {
        for (let i = 0; i < listaCursos.length; i++) {
            for (let j = i + 1; j < listaCursos.length; j++) {
                if (hayChoque(listaCursos[i], [listaCursos[j]])) return false;
            }
        }
        return true;
    }
</script>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
</body>
</html>
