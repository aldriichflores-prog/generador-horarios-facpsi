<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Generador Horarios UNAM - Multisemestre</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.0/font/bootstrap-icons.css">
    
    <style>
        body { background-color: #f4f6f9; font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; min-height: 100vh; display: flex; flex-direction: column; }
        .header-main { background-color: #002B7A; color: white; padding: 2rem 0; border-bottom: 6px solid #D59F0F; }
        .text-gold { color: #D59F0F; }
        .card-header { background-color: #f8f9fa; border-bottom: 2px solid #e9ecef; font-weight: 600; color: #002B7A; }
        .btn-unam { background-color: #002B7A; color: white; font-weight: 500; }
        .btn-unam:hover { background-color: #001e57; color: white; }
        .choque { background-color: #ffe6e6; color: #dc3545; cursor: not-allowed; opacity: 0.9; }
        .footer-warning { background-color: #fff3cd; color: #856404; padding: 15px; text-align: center; border-top: 1px solid #ffeeba; margin-top: auto; }
        .nav-pills .nav-link.active { background-color: #D59F0F; color: #002B7A; font-weight: bold; }
        .nav-pills .nav-link { color: #002B7A; }
        
        /* Estilos para las observaciones */
        .obs-text { 
            font-size: 0.85em; 
            background-color: #e7f1ff; 
            border-left: 4px solid #0d6efd; 
            padding: 8px; 
            margin-top: 8px; 
            border-radius: 4px; 
            display: none; /* Oculto por defecto */
            color: #000;
        }
        .btn-obs { font-size: 0.75em; padding: 2px 8px; margin-top: 4px; border-radius: 10px;}
        
        /* Cursor puntero para elementos clickeables */
        .cursor-pointer { cursor: pointer; }
    </style>
</head>
<body>

<div class="header-main text-center mb-4">
    <div class="container">
        <h1 class="display-6 fw-bold">Generador de Horarios FacPsi</h1>
        <p class="lead mb-3">Psicología UNAM <span class="text-gold fw-bold">(2025-2)</span></p>
        
        <div class="d-flex justify-content-center align-items-center gap-2 mb-3">
            <label class="fw-bold text-white">Selecciona tu Semestre:</label>
            <select id="semestre-selector" class="form-select w-auto fw-bold text-primary shadow" onchange="cambiarSemestre()">
                <option value="2">2do Semestre</option>
                <option value="6">6to Semestre</option>
                <option value="8" selected>8vo Semestre</option>
            </select>
        </div>

        <p class="small opacity-75 mx-auto" style="max-width: 600px;">
            Herramienta para visualizar empalmes, calcular créditos y ver observaciones antes de la inscripción oficial.
        </p>
    </div>
</div>

<div class="container pb-4" id="app">

    <ul class="nav nav-pills mb-4 justify-content-center" id="pills-tab">
        <li class="nav-item">
            <button class="nav-link active px-4 shadow-sm" id="tab-manual" onclick="cambiarModo('manual')">
                <i class="bi bi-pencil-square"></i> Generador Manual
            </button>
        </li>
        <li class="nav-item">
            <button class="nav-link px-4 shadow-sm" id="tab-auto" onclick="cambiarModo('auto')">
                <i class="bi bi-cpu"></i> Explorador (Automático)
            </button>
        </li>
    </ul>

    <div id="vista-manual" class="row">
        <div class="col-md-5">
            <div class="card shadow-sm h-100">
                <div class="card-header"><i class="bi bi-search"></i> 1. Buscar Materia</div>
                <div class="card-body">
                    <input type="text" id="buscador" class="form-control mb-3" placeholder="Escribe nombre de materia..." onkeyup="filtrarMaterias()">
                    <div id="lista-materias" class="list-group" style="max-height: 500px; overflow-y: auto;"></div>
                </div>
            </div>

            <div class="card shadow mt-3 border-primary" id="panel-grupos" style="display:none;">
                <div class="card-header bg-primary text-white d-flex justify-content-between align-items-center">
                    <span id="titulo-panel-grupos" class="fw-bold">Materia Seleccionada</span>
                    <button type="button" class="btn-close btn-close-white" onclick="cerrarPanelGrupos()"></button>
                </div>
                <div class="card-body p-0">
                    <div id="lista-grupos" class="list-group list-group-flush" style="max-height: 400px; overflow-y: auto;"></div>
                </div>
            </div>
        </div>

        <div class="col-md-7">
            <div class="card shadow h-100">
                <div class="card-header d-flex justify-content-between align-items-center">
                    <span><i class="bi bi-calendar-check"></i> Tu Horario Preliminar</span>
                    <span id="creditos-badge" class="badge bg-secondary">0 Créditos</span>
                </div>
                <div class="card-body">
                    <div id="mi-horario">
                        <div class="text-center text-muted mt-5">
                            <i class="bi bi-backpack display-1 opacity-25"></i>
                            <p class="mt-2">Tu mochila está vacía.</p>
                        </div>
                    </div>
                    
                    <div class="mt-3 text-end" id="btn-limpiar-manual" style="display:none;">
                        <button class="btn btn-outline-danger btn-sm" onclick="limpiarTodoManual()">Borrar Todo</button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <div id="vista-auto" class="row" style="display:none;">
        <div class="col-md-4">
            <div class="card shadow-sm mb-3">
                <div class="card-header"><i class="bi bi-funnel"></i> 1. Configurar Selecciones</div>
                <div class="card-body">
                    <label class="form-label fw-bold">Elige una Materia:</label>
                    <select id="select-materia-auto" class="form-select mb-2" onchange="cargarProfesAuto()">
                        <option value="">-- Selecciona --</option>
                    </select>
                    
                    <div id="area-profes-auto" class="border rounded p-2 mb-3 bg-light" style="max-height: 300px; overflow-y: auto; display:none;">
                    </div>

                    <button class="btn btn-outline-primary w-100 mb-3" onclick="agregarABolsa()">
                        <i class="bi bi-plus-circle"></i> Agregar a mis Selecciones
                    </button>
                </div>
            </div>

            <div class="card shadow-sm">
                 <div class="card-header d-flex justify-content-between align-items-center">
                    <span><i class="bi bi-list-check"></i> Tus Selecciones</span>
                    <button class="btn btn-sm text-danger" onclick="limpiarBolsa()" title="Borrar todo"><i class="bi bi-trash"></i></button>
                </div>
                <ul id="lista-bolsa" class="list-group list-group-flush">
                    <li class="list-group-item text-muted small text-center py-3">Aún no agregas materias.</li>
                </ul>
                <div class="card-body">
                    <button class="btn btn-unam w-100 py-2" onclick="generarCombinaciones()">
                        <i class="bi bi-lightning-charge-fill"></i> GENERAR HORARIOS
                    </button>
                </div>
            </div>
        </div>

        <div class="col-md-8">
            <div class="card shadow h-100">
                <div class="card-header">Resultados Generados</div>
                <div class="card-body bg-light" id="resultados-auto" style="overflow-y: auto; max-height: 600px;">
                    <div class="text-center text-muted mt-5">
                        <i class="bi bi-arrow-left-circle display-4 opacity-25"></i>
                        <p class="mt-3">Selecciona materias y profesores, luego presiona Generar.</p>
                    </div>
                </div>
            </div>
        </div>
    </div>

</div>

<div class="footer-warning small">
    <strong>⚠️ INFORMACIÓN IMPORTANTE:</strong><br>
    Esta herramienta es un simulador académico. Los resultados son sugerencias.<br>
    La inscripción oficial <strong>debe realizarse únicamente</strong> a través del sistema de la DGAE/SIAE.
</div>

<script>
    // --- VARIABLES GLOBALES ---
    let BD_CRUDA = []; // Los datos planos del JSON
    let BD_AGRUPADA = []; // Los datos procesados (Objetos)
    let miHorario = [];
    let bolsa = {}; 
    const DB_FILE = 'Horarios_Completo_UNAM.json'; // TU ARCHIVO JSON

    // --- 1. CARGA Y TRANSFORMACIÓN ---
    fetch(DB_FILE)
        .then(res => {
            if(!res.ok) throw new Error("No se encontró el archivo " + DB_FILE);
            return res.json();
        })
        .then(data => {
            BD_CRUDA = data;
            console.log("Datos crudos cargados:", BD_CRUDA.length);
            procesarDatosCrudos(); 
            
            cargarEstado(); // Recuperar memoria
            cambiarSemestre(); // Iniciar vista
        })
        .catch(err => {
            console.error(err);
            alert("Error: " + err.message + "\nAsegúrate de usar http.server (no doble clic al archivo).");
        });

    // --- FUNCIÓN CORREGIDA PARA AGRUPAR DATOS Y DETECTAR PROFESORES ---
    function procesarDatosCrudos() {
        let gruposTemp = {};

        BD_CRUDA.forEach(fila => {
            // 1. BLINDAJE DE DATOS (Para que no fallen los nombres)
            let nombreAsignatura = fila.asignatura || fila.Asignatura || "SIN NOMBRE";
            // Buscamos cualquier variación de 'profesor'
            let nombreProfesor = fila.profesor || fila.Profesor || fila.PROFESOR || "Profesor Pendiente";
            // Aseguramos que el grupo sea texto
            let numGrupo = (fila.grupo || "0").toString();

            // 2. CREAR LLAVE ÚNICA (Semestre + Materia + Grupo)
            // Quitamos espacios para evitar duplicados raros
            let key = `${fila.semestre}-${nombreAsignatura.replace(/\s+/g, '')}-${numGrupo}`;

            if (!gruposTemp[key]) {
                gruposTemp[key] = {
                    id_unico: fila.id_unico, // Usamos el ID de la primera fila que encontremos
                    semestre: fila.semestre,
                    asignatura: nombreAsignatura,
                    profesor: nombreProfesor, // <--- AQUÍ SE GUARDA EL NOMBRE
                    grupo: numGrupo,
                    creditos: fila.creditos,
                    observaciones: fila.observaciones || "",
                    area: fila.area,
                    sesiones: []
                };
            }

            // 3. AGREGAR HORARIOS VÁLIDOS
            if (fila.dia && fila.dia !== "POR ASIGNAR" && fila.hora_inicio !== "00:00") {
                gruposTemp[key].sesiones.push({
                    dia: fila.dia,
                    inicio: fila.hora_inicio,
                    fin: fila.hora_fin,
                    min_inicio: fila.min_inicio,
                    min_fin: fila.min_fin,
                    salon: fila.salon
                });
            }
        });

        // Convertir objeto a array
        BD_AGRUPADA = Object.values(gruposTemp);
        console.log("Materias procesadas correctamente:", BD_AGRUPADA.length);
    }

    // --- 2. GESTIÓN DE SEMESTRE ---
    function cambiarSemestre() {
        // Resetear visualmente
        document.getElementById('buscador').value = '';
        document.getElementById('panel-grupos').style.display = 'none';
        
        filtrarMaterias();
        llenarSelectAuto();
    }

    // --- 3. MODO MANUAL ---
    function filtrarMaterias() {
        const semestreActivo = parseInt(document.getElementById('semestre-selector').value);
        const texto = document.getElementById('buscador').value.toUpperCase();
        const lista = document.getElementById('lista-materias');
        lista.innerHTML = '';

        // 1. Filtrar BD por semestre
        let materiasSemestre = BD_AGRUPADA.filter(c => c.semestre === semestreActivo);

        // 2. Obtener nombres únicos y ordenar
        const nombresUnicos = [...new Set(materiasSemestre.map(c => c.asignatura))].sort();

        nombresUnicos.forEach(nombre => {
            if (nombre.includes(texto)) {
                // Si ya la tengo inscrita, no la muestro (opcional)
                // if (miHorario.some(c => c.asignatura === nombre)) return; 

                const item = document.createElement('button');
                item.className = 'list-group-item list-group-item-action d-flex justify-content-between align-items-center';
                item.innerHTML = `<span>${nombre}</span> <i class="bi bi-chevron-right text-muted small"></i>`;
                item.onclick = () => mostrarGrupos(nombre);
                lista.appendChild(item);
            }
        });
    }

    function mostrarGrupos(asignatura) {
        const semestreActivo = parseInt(document.getElementById('semestre-selector').value);
        document.getElementById('panel-grupos').style.display = 'block';
        document.getElementById('titulo-panel-grupos').innerText = asignatura;
        
        const lista = document.getElementById('lista-grupos');
        lista.innerHTML = '';

        // Buscar grupos de esa materia y ordenarlos
        const cursos = BD_AGRUPADA.filter(c => c.asignatura === asignatura && c.semestre === semestreActivo)
                                  .sort((a,b) => a.grupo.localeCompare(b.grupo));

        if (cursos.length === 0) {
            lista.innerHTML = '<div class="p-3 text-center text-muted">No se encontraron grupos para este semestre.</div>';
            return;
        }

        cursos.forEach(curso => {
            const choca = hayChoque(curso, miHorario);
            const btn = document.createElement('div');
            btn.className = `list-group-item list-group-item-action ${choca ? 'choque' : ''}`;
            
            let horarioTexto = curso.sesiones.length > 0 
                ? curso.sesiones.map(s => `<strong>${s.dia.substr(0,3)}</strong> ${s.inicio}`).join(', ')
                : '<span class="text-muted fst-italic">Sin horario definido (en línea o por asignar)</span>';
            
            // Botón de Observaciones
            let obsHtml = '';
            if (curso.observaciones && curso.observaciones.length > 3) {
                obsHtml = `
                    <button class="btn btn-outline-info btn-obs mt-1" onclick="toggleObs('obs-${curso.id_unico}')">
                        <i class="bi bi-eye"></i> Observaciones
                    </button>
                    <div id="obs-${curso.id_unico}" class="obs-text">${curso.observaciones}</div>
                `;
            }

            btn.innerHTML = `
                <div class="d-flex w-100 justify-content-between cursor-pointer align-items-center" onclick="${!choca ? `inscribir(${curso.id_unico})` : ''}">
                    <span class="fw-bold fs-5">Gpo ${curso.grupo}</span>
                    <span class="badge bg-light text-dark border">${curso.creditos} cr</span>
                </div>
                
                <div class="mb-1 text-primary fw-bold small mt-1 text-uppercase">
                    <i class="bi bi-person-fill"></i> ${curso.profesor}
                </div>
                
                <small class="text-muted d-block border-top pt-1 mt-1">${horarioTexto}</small>
                
                ${obsHtml}

                ${choca ? '<div class="text-danger small fw-bold mt-1"><i class="bi bi-exclamation-octagon"></i> Empalme de horario</div>' : ''}
                ${!choca ? `<button class="btn btn-sm btn-primary w-100 mt-2" onclick="inscribir(${curso.id_unico})">Agregar al Horario</button>` : ''}
            `;
            
            lista.appendChild(btn);
        });
    }

    function toggleObs(id) {
        const el = document.getElementById(id);
        el.style.display = (el.style.display === 'none' || el.style.display === '') ? 'block' : 'none';
    }

    function inscribir(idUnico) {
        // Buscamos el objeto completo por ID
        const curso = BD_AGRUPADA.find(c => c.id_unico === idUnico);
        
        // Verificar duplicados de materia
        if (miHorario.some(c => c.asignatura === curso.asignatura)) {
            alert("Ya tienes inscrita la materia: " + curso.asignatura);
            return;
        }

        if(curso) {
            miHorario.push(curso);
            guardarEstado();
            actualizarVistaHorario();
            cerrarPanelGrupos();
            document.getElementById('buscador').value = '';
            filtrarMaterias();
        }
    }

    function cerrarPanelGrupos() { document.getElementById('panel-grupos').style.display = 'none'; }

    function borrarMateria(index) {
        miHorario.splice(index, 1);
        guardarEstado();
        actualizarVistaHorario();
        filtrarMaterias();
    }

    function limpiarTodoManual() {
        if(confirm("¿Estás seguro de borrar todo tu horario?")) {
            miHorario = [];
            guardarEstado();
            actualizarVistaHorario();
            filtrarMaterias();
        }
    }

    function actualizarVistaHorario() {
        const contenedor = document.getElementById('mi-horario');
        contenedor.innerHTML = '';
        let totalCreditos = 0;

        document.getElementById('btn-limpiar-manual').style.display = miHorario.length > 0 ? 'block' : 'none';

        if (miHorario.length === 0) {
            contenedor.innerHTML = '<div class="text-center text-muted mt-5"><i class="bi bi-backpack display-1 opacity-25"></i><p class="mt-2">Mochila vacía.</p></div>';
        } else {
            miHorario.forEach((curso, idx) => {
                totalCreditos += parseInt(curso.creditos || 0);
                
                const card = document.createElement('div');
                card.className = 'card mb-2 border-start border-4 border-primary shadow-sm';
                let horarioTxt = curso.sesiones.map(s => `${s.dia.substr(0,3)} ${s.inicio}-${s.fin}`).join(' | ');
                
                let obsIcon = curso.observaciones.length > 3 
                    ? `<i class="bi bi-info-circle-fill text-info ms-1" title="${curso.observaciones}"></i>` 
                    : '';

                card.innerHTML = `
                    <div class="card-body p-2 d-flex justify-content-between align-items-center">
                        <div style="overflow: hidden;">
                            <h6 class="mb-0 fw-bold text-truncate" title="${curso.asignatura}">${curso.asignatura}</h6>
                            <small class="text-primary fw-bold text-uppercase" style="font-size: 0.85em;">${curso.profesor}</small><br>
                            <small class="text-muted">Gpo ${curso.grupo} ${obsIcon}</small> | 
                            <small class="text-dark fw-bold" style="font-size: 0.8em;">${horarioTxt}</small>
                        </div>
                        <button class="btn btn-sm text-danger fs-5" onclick="borrarMateria(${idx})" title="Quitar">&times;</button>
                    </div>
                `;
                contenedor.appendChild(card);
            });
        }

        const badge = document.getElementById('creditos-badge');
        badge.innerText = `${totalCreditos} Créditos`;
        badge.className = `badge ${totalCreditos > 50 ? 'bg-danger' : 'bg-success'}`;
    }

    // --- 4. MODO AUTOMÁTICO ---
    function llenarSelectAuto() {
        const semestreActivo = parseInt(document.getElementById('semestre-selector').value);
        const sel = document.getElementById('select-materia-auto');
        sel.innerHTML = '<option value="">-- Selecciona --</option>';
        
        let materiasSemestre = BD_AGRUPADA.filter(c => c.semestre === semestreActivo);
        const nombres = [...new Set(materiasSemestre.map(c => c.asignatura))].sort();
        
        nombres.forEach(n => {
            const opt = document.createElement('option');
            opt.value = n;
            opt.innerText = n;
            sel.appendChild(opt);
        });
    }

    function cargarProfesAuto() {
        const semestreActivo = parseInt(document.getElementById('semestre-selector').value);
        const nombre = document.getElementById('select-materia-auto').value;
        const div = document.getElementById('area-profes-auto');
        div.innerHTML = '';
        if(!nombre) { div.style.display='none'; return; }
        
        div.style.display='block';
        const cursos = BD_AGRUPADA.filter(c => c.asignatura === nombre && c.semestre === semestreActivo)
                                  .sort((a,b) => a.grupo.localeCompare(b.grupo));

        cursos.forEach(c => {
            const divRow = document.createElement('div');
            divRow.className = 'form-check border-bottom py-2';
            let hor = c.sesiones.map(s => `${s.dia.substr(0,3)} ${s.inicio}`).join(' ');
            let obsBadge = c.observaciones.length > 5 ? `<span class="badge bg-info text-dark ms-1" title="${c.observaciones}">Obs</span>` : '';

            divRow.innerHTML = `
                <input class="form-check-input check-profe" type="checkbox" value="${c.id_unico}" id="chk_${c.id_unico}">
                <label class="form-check-label w-100" for="chk_${c.id_unico}" style="cursor:pointer; font-size: 0.9em;">
                    <span class="fw-bold text-primary text-uppercase">${c.profesor}</span> 
                    <span class="text-muted small">(Gpo ${c.grupo})</span> ${obsBadge}<br>
                    <span class="text-dark small">${hor}</span>
                </label>
            `;
            div.appendChild(divRow);
        });
    }

    function agregarABolsa() {
        const nombre = document.getElementById('select-materia-auto').value;
        if(!nombre) return;
        const checks = document.querySelectorAll('.check-profe:checked');
        if(checks.length === 0) { alert("Selecciona al menos un profesor."); return; }

        const ids = Array.from(checks).map(c => parseInt(c.value));
        bolsa[nombre] = BD_AGRUPADA.filter(c => ids.includes(c.id_unico));

        guardarEstado();
        renderBolsa();
        
        document.getElementById('select-materia-auto').value = "";
        document.getElementById('area-profes-auto').style.display='none';
    }

    function renderBolsa() {
        const ul = document.getElementById('lista-bolsa');
        ul.innerHTML = '';
        const keys = Object.keys(bolsa);
        
        if(keys.length === 0) {
            ul.innerHTML = '<li class="list-group-item text-muted small text-center py-3">Aún no agregas materias.</li>';
            return;
        }

        keys.forEach(mat => {
            const li = document.createElement('li');
            li.className = 'list-group-item d-flex justify-content-between align-items-center py-2';
            li.innerHTML = `
                <div style="line-height: 1.2;">
                    <small class="fw-bold d-block text-truncate" style="max-width: 150px;">${mat}</small>
                    <span class="badge bg-secondary rounded-pill" style="font-size: 0.7em;">${bolsa[mat].length} Opciones</span>
                </div>
                <button class="btn btn-sm text-danger" onclick="borrarDeBolsa('${mat}')"><i class="bi bi-trash"></i></button>
            `;
            ul.appendChild(li);
        });
    }

    // --- ALGORITMO DE COMBINACIONES (Modo Automático) ---
    async function generarCombinaciones() {
        const resDiv = document.getElementById('resultados-auto');
        resDiv.innerHTML = '<div class="text-center py-5"><div class="spinner-border text-primary"></div><p class="mt-2 text-muted">Calculando horarios sin choques...</p></div>';
        
        await new Promise(r => setTimeout(r, 100));

        const materias = Object.keys(bolsa);
        if(materias.length === 0) { resDiv.innerHTML = '<div class="alert alert-warning text-center">Tus selecciones están vacías.</div>'; return; }

        const listas = Object.values(bolsa);
        // Producto Cartesiano
        const cartesian = (...a) => a.reduce((a, b) => a.flatMap(d => b.map(e => [d, e].flat())));
        let combinaciones = cartesian(...listas);
        if (materias.length === 1) combinaciones = combinaciones.map(c => [c]);

        const validos = [];
        
        // Límite de seguridad
        const MAX_ANALISIS = 50000;
        if(combinaciones.length > MAX_ANALISIS) {
             combinaciones = combinaciones.slice(0, MAX_ANALISIS);
        }

        for (let comb of combinaciones) {
            if (!horarioEsValido(comb)) continue;
            
            let creditos = 0;
            let diasSet = new Set();
            
            comb.forEach(curso => {
                creditos += parseInt(curso.creditos || 0);
                curso.sesiones.forEach(s => diasSet.add(s.dia));
            });

            validos.push({ cursos: comb, creditos, dias: diasSet.size });
            if (validos.length >= 50) break; // Mostrar máximo 50 resultados
        }

        validos.sort((a,b) => a.dias - b.dias); // Ordenar: menos días es mejor

        resDiv.innerHTML = '';
        if(validos.length === 0) {
            resDiv.innerHTML = '<div class="alert alert-danger text-center"><i class="bi bi-emoji-frown"></i> Imposible. Todas las combinaciones tienen empalmes. Intenta quitar profesores.</div>';
            return;
        }

        resDiv.innerHTML = `<div class="alert alert-success py-2 text-center shadow-sm"><strong>${validos.length}</strong> horarios encontrados.</div>`;

        validos.forEach((val, i) => {
            const div = document.createElement('div');
            div.className = 'card mb-3 shadow-sm border-0';
            
            let contenidoCursos = val.cursos.map(c => `
                <tr>
                    <td class="fw-bold text-primary" style="font-size: 0.9em;">${c.asignatura}</td>
                    <td style="font-size: 0.85em;">
                        <span class="text-uppercase fw-bold">${c.profesor}</span>
                        ${c.observaciones.length > 5 ? '<i class="bi bi-info-circle text-info ms-1" title="'+c.observaciones+'"></i>' : ''}
                    </td>
                    <td class="text-center" style="font-size: 0.85em;">${c.grupo}</td>
                    <td class="text-end text-muted" style="font-size: 0.8em;">${c.sesiones.map(s=>s.dia.substr(0,3) + ' ' + s.inicio).join('<br>')}</td>
                </tr>
            `).join('');

            div.innerHTML = `
                <div class="card-header bg-white d-flex justify-content-between align-items-center">
                    <span class="badge bg-primary rounded-pill">Opción ${i+1}</span>
                    <div>
                        <span class="badge bg-light text-dark border me-1">${val.dias} Días</span>
                        <span class="badge bg-success">${val.creditos} Cr</span>
                    </div>
                </div>
                <div class="card-body p-0">
                    <div class="table-responsive">
                        <table class="table table-sm table-striped mb-0 align-middle">
                            <thead class="table-light small"><tr><th>Materia</th><th>Profesor</th><th>Gpo</th><th class="text-end">Horario</th></tr></thead>
                            <tbody>${contenidoCursos}</tbody>
                        </table>
                    </div>
                </div>
            `;
            resDiv.appendChild(div);
        });
    }

    // --- UTILIDADES ---
    function guardarEstado() {
        localStorage.setItem('unam_horario_multi', JSON.stringify(miHorario));
        localStorage.setItem('unam_bolsa_multi', JSON.stringify(bolsa));
    }

    function cargarEstado() {
        const savedHorario = localStorage.getItem('unam_horario_multi');
        const savedBolsa = localStorage.getItem('unam_bolsa_multi');
        if (savedHorario) {
            miHorario = JSON.parse(savedHorario);
            actualizarVistaHorario();
        }
        if (savedBolsa) {
            bolsa = JSON.parse(savedBolsa);
            renderBolsa();
        }
    }

    function borrarDeBolsa(mat) {
        delete bolsa[mat];
        guardarEstado();
        renderBolsa();
    }
    
    function limpiarBolsa() {
        if(confirm("¿Borrar selecciones?")) {
            bolsa = {};
            guardarEstado();
            renderBolsa();
        }
    }

    function cambiarModo(modo) {
        document.getElementById('tab-manual').className = `nav-link ${modo==='manual'?'active':''}`;
        document.getElementById('tab-auto').className = `nav-link ${modo==='auto'?'active':''}`;
        document.getElementById('vista-manual').style.display = modo==='manual'?'flex':'none';
        document.getElementById('vista-auto').style.display = modo==='auto'?'flex':'none';
    }

    function hayChoque(cursoNuevo, listaAgendada) {
        for (let inscrito of listaAgendada) {
            for (let s1 of cursoNuevo.sesiones) {
                for (let s2 of inscrito.sesiones) {
                    if (s1.dia === s2.dia) {
                        if ((s1.min_inicio < s2.min_fin) && (s2.min_inicio < s1.min_fin)) return true;
                    }
                }
            }
        }
        return false;
    }

    function horarioEsValido(listaCursos) {
        for (let i = 0; i < listaCursos.length; i++) {
            for (let j = i + 1; j < listaCursos.length; j++) {
                if (hayChoque(listaCursos[i], [listaCursos[j]])) return false;
            }
        }
        return true;
    }
</script>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
</body>
</html>
